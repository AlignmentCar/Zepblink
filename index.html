<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Urban Estate 2 Local Shop</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="UE2 Shop">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
      import {
        getAuth,
        signInWithPopup,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut
      } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
      import {
  getFirestore,
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  query,
  where,
  serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';


      // ‚ö†Ô∏è REPLACE WITH YOUR FIREBASE CONFIG
      const firebaseConfig = {
        apiKey: "AIzaSyBLt_z6QrkwXwK2l8tDq-n7choUJ6vUJf0",
  authDomain: "zepblink-3e1c7.firebaseapp.com",
  projectId: "zepblink-3e1c7",
  storageBucket: "zepblink-3e1c7.firebasestorage.app",
  messagingSenderId: "275105674132",
  appId: "1:275105674132:web:1e0460f6765a580c461581"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.auth = auth;
      window.db = db;
      window.firebaseImports = {
  collection, doc, getDoc, getDocs, setDoc, query, where, serverTimestamp,
  signInWithPopup, signInWithEmailAndPassword, GoogleAuthProvider, 
  onAuthStateChanged, signOut
};


      console.log("‚úÖ Firebase SDK loaded successfully!");

    // Auth State Listener
onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log('‚úÖ User signed in:', user.email);

    // Check if user exists in Firestore and get their role
    let userRole = 'customer'; // Default role
    
    try {
      const userDocRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userDocRef);

      if (userDoc.exists()) {
        // Get role from Firestore
        userRole = userDoc.data().role || 'customer';
        console.log('üìù User role from Firestore:', userRole);
        
        // Update last login
        await setDoc(userDocRef, {
          lastLogin: serverTimestamp()
        }, { merge: true });
      } else {
        // Determine role based on email
        userRole = isAuthorizedShopowner(user.email) ? 'shopowner' : 'customer';
        
        // Create new user document with role
        await setDoc(userDocRef, {
          email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          photoURL: user.photoURL,
          location: 'Urban Estate 2, Hisar',
          role: userRole,
          createdAt: serverTimestamp(),
          lastLogin: serverTimestamp()
        });
        console.log('‚úÖ New user created with role:', userRole);
      }
    } catch (error) {
      console.error('‚ùå Error checking user data:', error);
    }

    // Store user info with role
    window.currentUser = {
      email: user.email,
      uid: user.uid,
      displayName: user.displayName || user.email.split('@')[0],
      photoURL: user.photoURL || null,
      role: userRole  // ‚úÖ Add role here
    };

    console.log('‚úÖ Current user:', window.currentUser);

    // Show main app
    showApp();
  } else {
    console.log('‚ùå No user signed in');
    window.currentUser = null;
    showAuthScreen();
  }
});


      // Check if email is authorized shopowner
      function isAuthorizedShopowner(email) {
        const authorizedEmails = [
          'sharma.uday8831@gmail.com',
          'shopowner2@example.com',
          'shopowner3@example.com'
          // Add more authorized shopowner emails here
        ];
        return authorizedEmails.includes(email.toLowerCase());
      }

      window.isAuthorizedShopowner = isAuthorizedShopowner;

      function showApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  updateUserInfo();
  
  // ‚úÖ Load shops after showing app
  setTimeout(() => {
    loadShopsFromFirestore();
  }, 500);
}


      function showAuthScreen() {
        document.getElementById('authScreen').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
      }


      function updateUserInfo() {
  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const userEmailDropdown = document.getElementById('userEmailDropdown');
  const userEmailMobile = document.getElementById('userEmailMobile');
  const userAvatar = document.getElementById('userAvatar');
  const userAvatarMobile = document.getElementById('userAvatarMobile');
  const userRole = document.getElementById('userRole');
  const userRoleDropdown = document.getElementById('userRoleDropdown');
  const userRoleDropdownMobile = document.getElementById('userRoleDropdownMobile');
  const userRoleMobile = document.getElementById('userRoleMobile');

  if (window.currentUser) {
    const displayName = window.currentUser.displayName;
    const email = window.currentUser.email;
    const role = window.currentUser.role || 'customer';
    
    // Update user name
    if (userName) userName.textContent = displayName;
    if (userEmail) userEmail.textContent = email;
    if (userEmailDropdown) userEmailDropdown.textContent = email;
    if (userEmailMobile) userEmailMobile.textContent = email;
    
    // Update avatar
    const avatarUrl = window.currentUser.photoURL || 
                     `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=25D366&color=fff`;
    if (userAvatar) userAvatar.src = avatarUrl;
    if (userAvatarMobile) userAvatarMobile.src = avatarUrl;
    
    // Update role badges
    let roleText = '';
    let roleColor = '';
    let roleIcon = '';
    
    if (role === 'shopowner') {
      roleText = 'üè™ Shopowner';
      roleColor = 'background: #ffc107; color: #000;';
      roleIcon = 'bi-shop';
    } else if (role === 'customer') {
      roleText = 'üõçÔ∏è Customer';
      roleColor = 'background: #0d6efd; color: white;';
      roleIcon = 'bi-person';
    } else {
      roleText = 'üë§ Guest';
      roleColor = 'background: #6c757d; color: white;';
      roleIcon = 'bi-person-circle';
    }
    
    if (userRole) {
      userRole.textContent = roleText;
      userRole.setAttribute('style', `font-size: 0.65rem; padding: 2px 8px; margin-top: 2px; ${roleColor} border-radius: 10px;`);
    }
    
    if (userRoleDropdown) {
      userRoleDropdown.textContent = roleText;
      userRoleDropdown.setAttribute('style', `font-size: 0.7rem; ${roleColor} border-radius: 10px; padding: 3px 8px;`);
    }
    
    if (userRoleDropdownMobile) {
      userRoleDropdownMobile.textContent = roleText;
      userRoleDropdownMobile.setAttribute('style', `font-size: 0.7rem; ${roleColor} border-radius: 10px; padding: 3px 8px;`);
    }
    
    if (userRoleMobile) {
      userRoleMobile.textContent = roleText.split(' ')[0]; // Just the emoji
      userRoleMobile.setAttribute('style', `position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px; ${roleColor} border-radius: 10px;`);
    }
    
    // ‚úÖ NEW: Show/Hide Register Shop Button based on role
    const registerShopBtn = document.getElementById('registerShopBtn');
    const registerShopBtnMobile = document.getElementById('registerShopBtnMobile');
    
    if (role === 'shopowner') {
      // Show Register Shop button for shopowners
      if (registerShopBtn) {
        registerShopBtn.classList.remove('d-none');
        registerShopBtn.style.display = 'block';
      }
      if (registerShopBtnMobile) {
        registerShopBtnMobile.style.display = 'block';
      }
      console.log('‚úÖ Register Shop button shown (Shopowner)');
    } else {
      // Hide for customers and guests
      if (registerShopBtn) {
        registerShopBtn.classList.add('d-none');
        registerShopBtn.style.display = 'none';
      }
      if (registerShopBtnMobile) {
        registerShopBtnMobile.style.display = 'none';
      }
      console.log('‚ÑπÔ∏è Register Shop button hidden (Customer/Guest)');
    }
    
  } else {
    // Guest mode
    if (userName) userName.textContent = 'Guest User';
    if (userEmail) userEmail.textContent = 'guest@ue2shop.local';
    if (userEmailDropdown) userEmailDropdown.textContent = 'guest@ue2shop.local';
    if (userEmailMobile) userEmailMobile.textContent = 'guest@ue2shop.local';
    
    const guestAvatar = 'https://ui-avatars.com/api/?name=Guest&background=6c757d&color=fff';
    if (userAvatar) userAvatar.src = guestAvatar;
    if (userAvatarMobile) userAvatarMobile.src = guestAvatar;
    
    const guestRole = 'üë§ Guest';
    const guestStyle = 'background: #6c757d; color: white; border-radius: 10px;';
    
    if (userRole) {
      userRole.textContent = guestRole;
      userRole.setAttribute('style', `font-size: 0.65rem; padding: 2px 8px; margin-top: 2px; ${guestStyle}`);
    }
    if (userRoleDropdown) {
      userRoleDropdown.textContent = guestRole;
      userRoleDropdown.setAttribute('style', `font-size: 0.7rem; ${guestStyle} padding: 3px 8px;`);
    }
    if (userRoleDropdownMobile) {
      userRoleDropdownMobile.textContent = guestRole;
      userRoleDropdownMobile.setAttribute('style', `font-size: 0.7rem; ${guestStyle} padding: 3px 8px;`);
    }
    if (userRoleMobile) {
      userRoleMobile.textContent = 'üë§';
      userRoleMobile.setAttribute('style', `position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px; ${guestStyle}`);
    }
    
    // ‚úÖ NEW: Hide Register Shop button for guests
    const registerShopBtn = document.getElementById('registerShopBtn');
    const registerShopBtnMobile = document.getElementById('registerShopBtnMobile');
    
    if (registerShopBtn) {
      registerShopBtn.classList.add('d-none');
      registerShopBtn.style.display = 'none';
    }
    if (registerShopBtnMobile) {
      registerShopBtnMobile.style.display = 'none';
    }
  }
}


    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<!-- ============================================
     AUTHENTICATION SCREEN
     ============================================ -->
<div id="authScreen" style="display: block;">
  <div class="auth-container">
    <div class="auth-card">

      <!-- App Icon & Branding -->
      <div class="auth-header">
        <div class="app-icon">
          <i class="bi bi-shop"></i>
        </div>
        <h1 class="app-title">Urban Estate 2</h1>
        <p class="app-subtitle">Local Shop - Hisar</p>
        <p class="location-badge">
          <i class="bi bi-geo-alt-fill"></i> Urban Estate 2, Hisar Only
        </p>
      </div>

      <!-- Welcome Message -->
      <div class="auth-body">
        <h2 class="welcome-text">Welcome Back!</h2>
        <p class="welcome-subtext">Order from your favorite local shops in Urban Estate 2</p>

        <!-- Google Sign-In Button (FOR CUSTOMERS) -->
        <button 
          onclick="handleGoogleSignIn()" 
          class="btn-google-signin" 
          id="googleSignInBtn"
        >
          <svg width="20" height="20" viewBox="0 0 18 18" class="google-icon">
            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
          </svg>
          <span class="btn-text">Continue with Google</span>
        </button>

        <!-- Divider -->
        <div class="position-relative my-4">
          <hr style="border-top: 1px solid #dee2e6;">
          <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0 15px; color: #6c757d; font-size: 0.875rem;">
            OR
          </span>
        </div>

        <!-- Email/Password Sign-In (FOR AUTHORIZED SHOPOWNERS ONLY) -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Shopowner Email" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>

          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>

          <button type="submit" id="loginButton" class="btn btn-outline-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In with Email
          </button>
        </form>

        <p class="text-muted mt-3" style="font-size: 0.8rem; text-align: center;">
          <i class="bi bi-info-circle"></i> Email sign-in is for authorized shopowners only
        </p>

        <!-- ‚úÖ NEW: Skip Login Button (Temporary) -->
        <div class="mt-4 pt-3" style="border-top: 1px solid #dee2e6;">
          <button onclick="skipLogin()" class="btn btn-sm w-100" style="background: rgba(37, 211, 102, 0.1); color: #128C7E; border: 1px dashed #128C7E; border-radius: 8px; padding: 10px; font-weight: 600;">
            <i class="bi bi-skip-forward-circle me-2"></i>Skip Login (Temporary - Development)
          </button>
        </div>

        <!-- Features -->
        <div class="auth-features">
          <div class="feature-item">
            <i class="bi bi-lightning-charge-fill"></i>
            <span>Quick Orders</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-truck"></i>
            <span>Local Delivery</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-shield-check"></i>
            <span>Secure Payment</span>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="auth-footer">
        <p class="security-text">
          <i class="bi bi-shield-lock"></i> 
          Secured by Firebase Authentication
        </p>
      </div>

    </div>
  </div>
</div>

<!-- ============================================
     MAIN APP - HOMEPAGE
     ============================================ -->
<div id="mainApp" style="display: none;">

  <!-- ============================================
       HAMBURGER BUTTON & SIDEBAR
       ============================================ -->
  <!-- Hamburger Menu Button -->
  <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar Menu -->
  <nav class="sidebar-menu" id="sidebarMenu">
    
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <i class="bi bi-shop" style="font-size: 32px;"></i>
      <h4 class="mt-2">UE2 Shop Menu</h4>
    </div>
    
    <!-- Home -->
    <div class="sidebar-item" onclick="goToHome()">
      <i class="bi bi-house-door"></i>
      <span>Home</span>
    </div>
    
    <!-- SHOPPING Section -->
    <div class="sidebar-section-title">SHOPPING</div>
    
    <div class="sidebar-item" onclick="navigateTo('categories')">
      <i class="bi bi-grid-3x3-gap"></i>
      <span>Shop by Category</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('shops')">
      <i class="bi bi-shop-window"></i>
      <span>All Shops</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('deals')">
      <i class="bi bi-tag-fill"></i>
      <span>Deals & Offers</span>
    </div>
    
    <!-- MY ACCOUNT Section -->
    <div class="sidebar-section-title">MY ACCOUNT</div>
    
    <div class="sidebar-item" onclick="navigateTo('orders')">
      <i class="bi bi-bag-check"></i>
      <span>My Orders</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('cart')">
      <i class="bi bi-cart3"></i>
      <span>Shopping Cart</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('favorites')">
      <i class="bi bi-heart-fill"></i>
      <span>Favorites</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('address')">
      <i class="bi bi-geo-alt-fill"></i>
      <span>Delivery Address</span>
    </div>
    
    <!-- SETTINGS Section -->
    <div class="sidebar-section-title">SETTINGS</div>
    
    <div class="sidebar-item" onclick="navigateTo('profile')">
      <i class="bi bi-person-circle"></i>
      <span>Profile Settings</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('help')">
      <i class="bi bi-question-circle"></i>
      <span>Help & Support</span>
    </div>
    
  </nav>


  <!-- ‚úÖ NAVBAR - Professional with User Dropdown + Register Shop Button -->
<nav id="mainNavbar" class="navbar navbar-dark sticky-top" 
style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 12px 0; padding-left: 70px;">
<div class="container-fluid">
<div class="w-100">
 
 <!-- Row 1: App Name + Buttons -->
 <div class="d-flex align-items-center justify-content-between">
   <!-- App Name -->
   <span class="navbar-brand mb-0 h1 d-flex align-items-center" style="margin: 0; font-size: 1.3rem;">
     <i class="bi bi-shop me-2" style="font-size: 1.5rem;"></i>
     <span>UE2 Shop</span>
   </span>
   
   <!-- Right Side: Register Shop Button + User Dropdown -->
   <div class="d-flex align-items-center gap-3">
     
     <!-- ‚úÖ NEW: Register Shop Button (Shopowners Only) -->
     <button 
       id="registerShopBtn" 
       class="btn btn-light d-none" 
       onclick="openRegisterShopModal()" 
       style="border-radius: 10px; font-weight: 600; padding: 8px 16px; display: none;">
       <i class="bi bi-shop me-2"></i>Register Shop
     </button>
     
     <!-- Desktop: User Dropdown with Role Badge -->
     <div class="dropdown d-none d-md-block">
       <button class="btn text-white d-flex align-items-center" 
               type="button" 
               id="userDropdown" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 10px; font-weight: 600; padding: 8px 16px;">
         <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
         <div class="d-flex flex-column align-items-start me-2">
           <span id="userName" style="font-size: 0.9rem;">Loading...</span>
           <span id="userRole" class="badge" style="font-size: 0.65rem; padding: 2px 8px; margin-top: 2px;">Guest</span>
         </div>
         <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
       </button>
       
       <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown" style="border-radius: 10px; min-width: 250px; border: none;">
         <li>
           <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
             <div class="d-flex align-items-center">
               <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=25D366&color=fff" alt="User" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
               <div style="flex: 1;">
                 <strong id="userEmailDropdown" style="font-size: 0.85rem; display: block;">user@example.com</strong>
                 <span id="userRoleDropdown" class="badge mt-1" style="font-size: 0.7rem;">Guest</span>
               </div>
             </div>
           </div>
         </li>
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('orders'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-bag me-2" style="color: #25D366;"></i>
             <span style="font-weight: 500;">My Orders</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('favorites'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-heart me-2" style="color: #dc3545;"></i>
             <span style="font-weight: 500;">Favorites</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('address'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-geo-alt me-2" style="color: #0d6efd;"></i>
             <span style="font-weight: 500;">Delivery Address</span>
           </a>
         </li>
         
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <button class="dropdown-item d-flex align-items-center" onclick="handleSignOut()" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
             <i class="bi bi-box-arrow-right me-2" style="color: #128C7E;"></i>
             <span style="color: #128C7E; font-weight: 500;">Sign Out</span>
           </button>
         </li>
       </ul>
     </div>
     
     <!-- Mobile: User Icon Button with Badge -->
     <div class="dropdown d-md-none">
       <button class="btn text-white position-relative" 
               type="button" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 10px; padding: 8px 12px;">
         <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
         <span id="userRoleMobile" class="badge position-absolute" style="top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px;">Guest</span>
       </button>
       
       <ul class="dropdown-menu dropdown-menu-end shadow" style="border-radius: 10px; min-width: 250px; border: none;">
         <li>
           <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
             <div class="d-flex align-items-center">
               <img id="userAvatarMobile" src="https://ui-avatars.com/api/?name=Guest&background=25D366&color=fff" alt="User" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
               <div style="flex: 1;">
                 <strong id="userEmailMobile" style="font-size: 0.85rem; display: block;">user@example.com</strong>
                 <span id="userRoleDropdownMobile" class="badge mt-1" style="font-size: 0.7rem;">Guest</span>
               </div>
             </div>
           </div>
         </li>
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <!-- ‚úÖ NEW: Mobile Register Shop Button -->
         <li id="registerShopBtnMobile" style="display: none;">
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="openRegisterShopModal(); return false;" style="padding: 12px 16px; background: rgba(37, 211, 102, 0.1);">
             <i class="bi bi-shop me-2" style="color: #25D366;"></i>
             <span style="font-weight: 600; color: #128C7E;">Register Shop</span>
           </a>
           <hr class="dropdown-divider" style="margin: 0;">
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('orders'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-bag me-2" style="color: #25D366;"></i>
             <span style="font-weight: 500;">My Orders</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('favorites'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-heart me-2" style="color: #dc3545;"></i>
             <span style="font-weight: 500;">Favorites</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('address'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-geo-alt me-2" style="color: #0d6efd;"></i>
             <span style="font-weight: 500;">Delivery Address</span>
           </a>
         </li>
         
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <button class="dropdown-item d-flex align-items-center" onclick="handleSignOut()" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
             <i class="bi bi-box-arrow-right me-2" style="color: #128C7E;"></i>
             <span style="color: #128C7E; font-weight: 500;">Sign Out</span>
           </button>
         </li>
       </ul>
     </div>
     
   </div>
   
 </div>
 
</div>
</div>
</nav>

<!-- ‚úÖ Sync Indicator -->
<div id="syncIndicator" class="sync-indicator" style="display: none;">
<i class="bi bi-arrow-repeat"></i> 
<span id="syncText">Syncing...</span>
</div>


<!-- ============================================
     REGISTER SHOP MODAL
     ============================================ -->
     <div class="modal fade" id="registerShopModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-shop me-2"></i>Register Your Shop
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <form id="registerShopForm">
              
              <!-- Shop Name -->
              <div class="mb-3">
                <label for="shopName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-shop me-2" style="color: #25D366;"></i>Shop Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="shopName" 
                  placeholder="e.g., ABC Tiles & Sanitaryware"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Owner Name -->
              <div class="mb-3">
                <label for="ownerName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-person me-2" style="color: #128C7E;"></i>Owner Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="ownerName" 
                  placeholder="e.g., Rajesh Kumar"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Mobile Number -->
              <div class="mb-3">
                <label for="shopMobile" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-phone me-2" style="color: #0d6efd;"></i>Mobile Number <span style="color: red;">*</span>
                </label>
                <input 
                  type="tel" 
                  class="form-control form-control-lg" 
                  id="shopMobile" 
                  placeholder="e.g., 9876543210"
                  required
                  pattern="[0-9]{10}"
                  maxlength="10"
                  style="border-radius: 10px;"
                >
                <small class="text-muted">Enter 10-digit mobile number</small>
              </div>
              
              <!-- Address -->
              <div class="mb-3">
                <label for="shopAddress" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-geo-alt me-2" style="color: #dc3545;"></i>Shop Address <span style="color: red;">*</span>
                </label>
                <textarea 
                  class="form-control" 
                  id="shopAddress" 
                  rows="3" 
                  placeholder="e.g., Shop No. 45, Urban Estate 2, Hisar"
                  required
                  style="border-radius: 10px;"
                ></textarea>
              </div>
              
            </form>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn" onclick="handleRegisterShop()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-check-circle me-2"></i>Register Shop
            </button>
          </div>
          
        </div>
      </div>
    </div>
    


    
    



  <!-- Main Content -->
  <main class="main-content" style="padding: 20px 0; min-height: calc(100vh - 70px); background: #F8F9F8;">
    <div class="container">

      <!-- Welcome Banner -->
      <div class="card mb-4" style="border: none; border-radius: 15px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white;">
        <div class="card-body p-4">
          <h2 class="mb-2" style="color: white; font-weight: 700;">
            <i class="bi bi-emoji-smile"></i> Welcome to Urban Estate 2 Shop!
          </h2>
          <p class="mb-0" style="opacity: 0.95;">Order from your favorite local shops, delivered to your doorstep.</p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-shop" style="font-size: 2rem; color: #25D366;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">12</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Active Shops</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-box-seam" style="font-size: 2rem; color: #128C7E;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">450+</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Products</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-truck" style="font-size: 2rem; color: #0d6efd;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">Fast</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Delivery</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-shield-check" style="font-size: 2rem; color: #198754;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">100%</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Secure</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Featured Products Section -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 style="font-weight: 700; color: #333; margin: 0;">
            <i class="bi bi-star-fill me-2" style="color: #ffc107;"></i>
            Featured Products
          </h3>
          <a href="#" class="text-decoration-none" style="color: #25D366; font-weight: 600; font-size: 0.9rem;">
            View All <i class="bi bi-arrow-right"></i>
          </a>
        </div>

        <div class="row g-3">
          <!-- Product Card 1 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-box-seam" style="font-size: 3rem; color: #1976d2;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 1</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop A</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ299</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Card 2 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-basket" style="font-size: 3rem; color: #7b1fa2;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 2</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop B</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ499</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Card 3 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-bag-heart" style="font-size: 3rem; color: #e65100;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 3</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop C</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ199</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Card 4 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-gift" style="font-size: 3rem; color: #2e7d32;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 4</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop D</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ399</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Development Notice -->
      <div class="alert alert-info mt-4" role="alert" style="border-radius: 12px; border: none;">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Under Development:</strong> Product listings from local shopowners will be loaded here. Shopping cart and checkout coming soon!
      </div>

    </div>
  </main>

</div>

<!-- ============================================
     SHOP PRODUCTS PAGE
     ============================================ -->
     <div class="page-view" id="shopProductsPage" style="display: none;">
  
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <button class="btn btn-light" onclick="goBackHome()" style="border-radius: 10px; font-weight: 600;">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
          <i class="bi bi-shop me-2"></i><span id="shopProductsPageTitle">Shop Products</span>
        </h3>
        <div style="width: 80px;"></div> <!-- Spacer for centering -->
      </div>
      
      <!-- Shop Info Card -->
      <div class="container-fluid" style="padding: 20px;">
        <div id="shopInfoCard" class="card mb-4" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
          <!-- Shop info will be dynamically inserted here -->
        </div>
        
        <!-- Search Box -->
        <div class="mb-3">
          <input 
            type="text" 
            class="form-control form-control-lg" 
            id="searchShopProductsInput" 
            placeholder="üîç Search products..." 
            onkeyup="filterShopProducts(this.value)"
            style="border-radius: 10px; max-width: 600px; margin: 0 auto; display: block;"
          >
        </div>
        
        <!-- Products Grid -->
        <div id="shopProductsGrid" class="row g-3">
          <!-- Products will be rendered here -->
          <div class="col-12" style="text-align: center; padding: 40px;">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-3">Loading products...</p>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="shopProductsEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-box-seam" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">No Products Yet</h4>
          <p class="text-muted">This shop hasn't added any products yet.</p>
        </div>
      </div>
      
    </div>



<!-- ============================================
     JAVASCRIPT
     ============================================ -->
<script>

function skipLogin() {
  console.log('‚è≠Ô∏è Skipping login - Guest mode');

  // Set temporary guest user
  window.currentUser = {
    email: 'guest@ue2shop.local',
    uid: 'guest_' + Date.now(),
    displayName: 'Guest User',
    photoURL: null,
    role: 'guest',  // ‚úÖ Add guest role
    isGuest: true
  };

  // Hide auth screen and show app
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  // Update UI
  if (typeof window.updateUserInfo === 'function') {
    window.updateUserInfo();
  }

  // Show notification
  setTimeout(() => {
    alert('‚ö†Ô∏è Guest Mode: You are browsing without authentication.\n\nSign in with Google or Email to place orders.');
  }, 500);
}


/**
 * Handle Google Sign-In (FOR CUSTOMERS)
 */
async function handleGoogleSignIn() {
  const googleSignInBtn = document.getElementById('googleSignInBtn');

  if (googleSignInBtn) {
    googleSignInBtn.disabled = true;
    googleSignInBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }

  try {
    console.log('üîê Starting Google Sign-In...');

    const { signInWithPopup, GoogleAuthProvider } = window.firebaseImports;
    const provider = new GoogleAuthProvider();

    provider.setCustomParameters({
      prompt: 'select_account'
    });

    const result = await signInWithPopup(window.auth, provider);
    const user = result.user;

    console.log('‚úÖ Google Sign-In successful!', user.email);

  } catch (error) {
    console.error('‚ùå Google Sign-In error:', error);

    let errorMessage = 'Google Sign-In failed. Please try again.';

    if (error.code === 'auth/popup-closed-by-user') {
      errorMessage = 'Sign-in cancelled. Please try again.';
    } else if (error.code === 'auth/popup-blocked') {
      errorMessage = 'Pop-up blocked. Please enable pop-ups for this site.';
    } else if (error.code === 'auth/cancelled-popup-request') {
      errorMessage = 'Only one sign-in at a time please.';
    } else if (error.code === 'auth/network-request-failed') {
      errorMessage = 'Network error. Check your internet connection.';
    }

    alert(errorMessage);

    if (googleSignInBtn) {
      googleSignInBtn.disabled = false;
      googleSignInBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 18 18" class="google-icon"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg><span class="btn-text">Continue with Google</span>';
    }
  }
}

/**
 * Handle Email/Password Sign-In (FOR AUTHORIZED SHOPOWNERS ONLY)
 */
 async function handleEmailPasswordAuth(event) {
  event.preventDefault();

  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const loginButton = document.getElementById('loginButton');

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  if (!window.isAuthorizedShopowner(email)) {
    alert('‚ùå Unauthorized! This email is not registered as a shopowner.\n\nCustomers should use Google Sign-In.');
    return;
  }

  if (loginButton) {
    loginButton.disabled = true;
    loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }

  try {
    console.log('üîê Starting Email/Password Sign-In for:', email);

    const { signInWithEmailAndPassword, doc, setDoc } = window.firebaseImports;
    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
    const user = userCredential.user;

    console.log('‚úÖ Email/Password Sign-In successful!', user.email);

    // ‚úÖ UPDATE: Set role as shopowner in Firestore
    try {
      const userDocRef = doc(window.db, 'users', user.uid);
      await setDoc(userDocRef, {
        email: user.email,
        displayName: user.displayName || user.email.split('@')[0],
        lastLogin: new Date().toISOString(),
        role: 'shopowner',  // ‚úÖ Email sign-in = shopowner
        location: 'Urban Estate 2, Hisar'
      }, { merge: true });
      
      console.log('‚úÖ Role updated to shopowner in Firestore');
      
      // ‚úÖ Update window.currentUser with role
      if (window.currentUser) {
        window.currentUser.role = 'shopowner';
      }
      
    } catch (firestoreError) {
      console.error('‚ö†Ô∏è Error updating Firestore:', firestoreError);
      // Continue anyway - auth was successful
    }

  } catch (error) {
    console.error('‚ùå Email/Password Sign-In error:', error);

    let errorMessage = 'Sign-in failed. Please try again.';

    if (error.code === 'auth/user-not-found') {
      errorMessage = 'No account found with this email. Please contact admin.';
    } else if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect password. Please try again.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email format.';
    } else if (error.code === 'auth/user-disabled') {
      errorMessage = 'This account has been disabled. Contact admin.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/invalid-credential') {
      errorMessage = 'Invalid email or password. Please try again.';
    }

    alert(errorMessage);

    if (loginButton) {
      loginButton.disabled = false;
      loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In with Email';
    }
  }
}


/**
 * Toggle Password Visibility
 */
function togglePasswordVisibility() {
  const passwordInput = document.getElementById('userPasswordInput');
  const toggleIcon = document.getElementById('passwordToggleIcon');

  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.classList.remove('bi-eye');
    toggleIcon.classList.add('bi-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIcon.classList.remove('bi-eye-slash');
    toggleIcon.classList.add('bi-eye');
  }
}

/**
 * Handle Sign Out
 */
async function handleSignOut() {
  if (window.currentUser && window.currentUser.isGuest) {
    // Guest mode - just reload page
    if (confirm('Return to login screen?')) {
      location.reload();
    }
    return;
  }

  if (confirm('Are you sure you want to sign out?')) {
    try {
      await window.auth.signOut();
      console.log('‚úÖ User signed out');
      location.reload();
    } catch (error) {
      console.error('‚ùå Sign out error:', error);
      alert('Failed to sign out. Please try again.');
    }
  }
}

/**
 * ==========================================
 * SIDEBAR MENU FUNCTIONALITY
 * ==========================================
 */

// Current page tracker
let currentPage = 'home';

/**
 * Toggle Sidebar
 */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    // Prevent body scroll when sidebar is open
    document.body.style.overflow = 'hidden';
  }
}

/**
 * Close Sidebar
 */
function closeSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  document.body.style.overflow = '';
}

/**
 * Go to Home function
 */
function goToHome() {
  console.log('üìç Going to Home');
  closeSidebar();
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Update active page
  currentPage = 'home';
  updateSidebarActive('home');
}

/**
 * Navigate to Different Pages
 */
function navigateTo(page) {
  console.log('üìç Navigating to:', page);
  
  // Update current page
  currentPage = page;
  
  // Close sidebar
  closeSidebar();
  
  // Update active state
  updateSidebarActive(page);
  
  // Handle navigation based on page
  const pageNames = {
    'categories': 'üìÇ Categories',
    'shops': 'üè™ All Shops',
    'deals': 'üè∑Ô∏è Deals & Offers',
    'orders': 'üì¶ My Orders',
    'cart': 'üõí Shopping Cart',
    'favorites': '‚ù§Ô∏è Favorites',
    'address': 'üìç Delivery Address',
    'profile': 'üë§ Profile Settings',
    'help': '‚ùì Help & Support'
  };
  
  const pageName = pageNames[page] || page;
  
  // Show coming soon alert
  alert(`‚è≥ "${pageName}" feature coming soon!\n\nThis will be implemented in the next phase.`);
}

/**
 * Sidebar Action function (for future use)
 */
function sidebarAction(action) {
  console.log('Sidebar action:', action);
  
  // Show coming soon for disabled items
  const actionName = action.replace(/([A-Z])/g, ' $1').trim();
  alert(`‚è≥ "${actionName}" feature coming soon!\n\nThis will be implemented in the next phase.`);
  
  closeSidebar();
}

/**
 * Update Active State in Sidebar
 */
function updateSidebarActive(page) {
  // Remove active class from all items
  const allItems = document.querySelectorAll('.sidebar-item');
  allItems.forEach(item => {
    item.classList.remove('active');
  });
  
  console.log('‚úÖ Active page:', page);
}

/**
 * Close sidebar on window resize (desktop view)
 */
window.addEventListener('resize', function() {
  if (window.innerWidth > 768) {
    closeSidebar();
  }
});

/**
 * Close sidebar on Escape key
 */
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeSidebar();
  }
});

/**
 * ==========================================
 * SHOP REGISTRATION FUNCTIONS
 * ==========================================
 */

// Global variable to store shops
let cachedShops = [];

/**
 * Open Register Shop Modal
 */
function openRegisterShopModal() {
  // Check if user is shopowner
  if (!window.currentUser || window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can register shops.\n\nPlease sign in with authorized email.');
    return;
  }
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('registerShopModal'));
  modal.show();
  
  // Clear form
  document.getElementById('registerShopForm').reset();
}

/**
 * Handle Shop Registration
 */
async function handleRegisterShop() {
  const shopName = document.getElementById('shopName').value.trim();
  const ownerName = document.getElementById('ownerName').value.trim();
  const shopMobile = document.getElementById('shopMobile').value.trim();
  const shopAddress = document.getElementById('shopAddress').value.trim();
  
  // Validation
  if (!shopName || !ownerName || !shopMobile || !shopAddress) {
    alert('‚ùå Please fill all required fields');
    return;
  }
  
  // Validate mobile number
  if (!/^[0-9]{10}$/.test(shopMobile)) {
    alert('‚ùå Please enter a valid 10-digit mobile number');
    return;
  }
  
  // Check if user is authenticated
  if (!window.currentUser || !window.currentUser.uid) {
    alert('‚ùå You must be signed in to register a shop');
    return;
  }
  
  // Show loading
  showSyncIndicator('Registering shop...', null);
  
  try {
    console.log('üè™ Registering shop:', shopName);
    
    const { collection, doc, setDoc } = window.firebaseImports;
    
    // Create shop document
    const shopData = {
      shopName: shopName,
      ownerName: ownerName,
      mobile: shopMobile,
      address: shopAddress,
      ownerId: window.currentUser.uid,
      ownerEmail: window.currentUser.email,
      status: 'active',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    // Save to Firestore: shops/{shopId}
    const shopId = 'shop_' + Date.now();
    const shopRef = doc(window.db, 'shops', shopId);
    await setDoc(shopRef, shopData);
    
    console.log('‚úÖ Shop registered successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('registerShopModal'));
    modal.hide();
    
    // Show success message
    showSyncIndicator('Shop registered successfully!', 2000);
    
    // Reload shops
    await loadShopsFromFirestore();
    
    // Show success alert
    setTimeout(() => {
      alert('‚úÖ Shop Registered Successfully!\n\n' +
            'Shop Name: ' + shopName + '\n' +
            'Owner: ' + ownerName + '\n\n' +
            'Your shop is now visible on the homepage!');
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error registering shop:', error);
    showSyncIndicator('Registration failed', 1500);
    alert('‚ùå Failed to register shop: ' + error.message + '\n\nPlease try again.');
  }
}

/**
 * Load Shops from Firestore
 */
async function loadShopsFromFirestore() {
  try {
    console.log('üîÑ Loading shops from Firestore...');
    
    const { collection, getDocs, query, where } = window.firebaseImports;
    
    // Load all active shops
    const shopsRef = collection(window.db, 'shops');
    const shopsQuery = query(shopsRef, where('status', '==', 'active'));
    const shopsSnap = await getDocs(shopsQuery);
    
    cachedShops = [];
    shopsSnap.forEach((doc) => {
      cachedShops.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${cachedShops.length} shops`);
    
    // Save to cache
    localStorage.setItem('ue2shop_shops_cache', JSON.stringify(cachedShops));
    
    // Render shops on homepage
    renderShopsOnHomepage();
    
  } catch (error) {
    console.error('‚ùå Error loading shops:', error);
    
    // Load from cache
    try {
      cachedShops = JSON.parse(localStorage.getItem('ue2shop_shops_cache') || '[]');
      renderShopsOnHomepage();
    } catch (e) {
      console.error('Failed to load from cache:', e);
    }
  }
}

/**
 * Render Shops on Homepage
 */
function renderShopsOnHomepage() {
  // Find the container (after featured products section)
  const mainContent = document.querySelector('.main-content .container');
  
  if (!mainContent) {
    console.warn('‚ö†Ô∏è Main content container not found');
    return;
  }
  
  // Remove existing shops section if any
  const existingSection = document.getElementById('shopsSection');
  if (existingSection) {
    existingSection.remove();
  }
  
  // Create shops section
  const shopsHTML = `
    <div id="shopsSection" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="font-weight: 700; color: #333; margin: 0;">
          <i class="bi bi-shop me-2" style="color: #25D366;"></i>
          Local Shops in Urban Estate 2
        </h3>
        <span class="badge" style="background: #25D366; color: white; font-size: 0.9rem; padding: 6px 12px; border-radius: 10px;">
          ${cachedShops.length} Shop${cachedShops.length !== 1 ? 's' : ''}
        </span>
      </div>
      
      <div class="row g-3" id="shopsGrid">
        ${cachedShops.length === 0 ? `
          <div class="col-12">
            <div class="alert alert-info" style="border-radius: 12px; border: none;">
              <i class="bi bi-info-circle me-2"></i>
              <strong>No shops registered yet.</strong><br>
              ${window.currentUser && window.currentUser.role === 'shopowner' ? 
                'Click "Register Shop" button to add your shop!' : 
                'Be the first to discover local shops here!'}
            </div>
          </div>
        ` : cachedShops.map(shop => `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              
              <!-- Shop Header -->
              <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; color: white;">
                <div class="d-flex align-items-start justify-content-between">
                  <div style="flex: 1;">
                    <h5 style="font-weight: 700; color: white; margin-bottom: 5px;">
                      <i class="bi bi-shop me-2"></i>${escapeHtml(shop.shopName)}
                    </h5>
                    <p style="font-size: 0.85rem; opacity: 0.9; margin: 0;">
                      <i class="bi bi-person me-1"></i>${escapeHtml(shop.ownerName)}
                    </p>
                  </div>
                  <span class="badge" style="background: rgba(255,255,255,0.3); color: white; font-size: 0.75rem;">Active</span>
                </div>
              </div>
              
              <!-- Shop Body -->
              <div class="card-body">
                <!-- Mobile -->
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-phone" style="color: #0d6efd; font-size: 1.2rem; margin-right: 10px;"></i>
                  <div>
                    <small class="text-muted" style="font-size: 0.75rem;">Mobile</small>
                    <p style="margin: 0; font-weight: 600; color: #333;">${escapeHtml(shop.mobile)}</p>
                  </div>
                </div>
                
                <!-- Address -->
                <div class="d-flex align-items-start mb-3">
                  <i class="bi bi-geo-alt-fill" style="color: #dc3545; font-size: 1.2rem; margin-right: 10px;"></i>
                  <div>
                    <small class="text-muted" style="font-size: 0.75rem;">Address</small>
                    <p style="margin: 0; font-size: 0.9rem; color: #666; line-height: 1.4;">${escapeHtml(shop.address)}</p>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                  <button class="btn btn-sm flex-fill" style="background: #25D366; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;">
                    <i class="bi bi-telephone me-1"></i>Call
                  </button>
                 <button class="btn btn-sm flex-fill" onclick="navigateToShopProducts('${shop.id}', '${escapeHtml(shop.shopName)}')" style="background: #128C7E; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;">
  <i class="bi bi-eye me-1"></i>View Products
</button>
                </div>
              </div>
              
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  // Insert before "Featured Products" section
  const featuredSection = mainContent.querySelector('.mb-4');
  if (featuredSection) {
    featuredSection.insertAdjacentHTML('afterend', shopsHTML);
  } else {
    mainContent.insertAdjacentHTML('afterbegin', shopsHTML);
  }
}


/**
 * Call Shop
 */
 function callShop(mobile) {
  console.log('üìû Calling:', mobile);
  window.location.href = 'tel:' + mobile;
}


/**
 * Sync Helper Functions
 */
function showSyncIndicator(msg = 'Syncing...', hideAfterMs = null) {
  const el = document.getElementById('syncIndicator');
  const textEl = document.getElementById('syncText');
  
  if (el && textEl) {
    textEl.textContent = msg;
    el.style.display = 'block';
    
    if (hideAfterMs) {
      setTimeout(() => {
        el.style.display = 'none';
      }, hideAfterMs);
    }
  }
}

function hideSyncIndicator() {
  const el = document.getElementById('syncIndicator');
  if (el) {
    el.style.display = 'none';
  }
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Load shops when app initializes
 * This runs after DOM is loaded and Firebase is ready
 */
 window.addEventListener('DOMContentLoaded', function() {
  console.log('üîÑ DOM loaded, waiting for auth...');
  
  // Check periodically if user is authenticated
  const checkAuthInterval = setInterval(() => {
    if (window.auth && window.auth.currentUser && document.getElementById('mainApp').style.display === 'block') {
      console.log('‚úÖ User authenticated, loading shops...');
      loadShopsFromFirestore();
      clearInterval(checkAuthInterval);
    }
  }, 500);
  
  // Stop checking after 10 seconds
  setTimeout(() => {
    clearInterval(checkAuthInterval);
  }, 10000);
});

/**
 * ==========================================
 * SHOP PRODUCTS PAGE FUNCTIONS
 * ==========================================
 */

// Global variables
let currentShopData = null;
let allShopProducts = [];

/**
 * Navigate to Shop Products Page
 */
function navigateToShopProducts(shopId, shopName) {
  console.log('üè™ Navigating to Shop Products:', shopId, shopName);
  
  // Store current shop data
  currentShopData = cachedShops.find(shop => shop.id === shopId);
  
  if (!currentShopData) {
    console.error('‚ùå Shop not found:', shopId);
    alert('Shop not found!');
    return;
  }
  
  // Hide main app and navbar
  const mainApp = document.getElementById('mainApp');
  const mainNavbar = document.getElementById('mainNavbar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  if (sidebarToggleBtn) {
    sidebarToggleBtn.style.display = 'none';
  }
  
  // Show shop products page
  const shopProductsPage = document.getElementById('shopProductsPage');
  if (shopProductsPage) {
    shopProductsPage.style.display = 'block';
    shopProductsPage.classList.add('active');
  }
  
  // Update page title
  const pageTitle = document.getElementById('shopProductsPageTitle');
  if (pageTitle) {
    pageTitle.textContent = shopName;
  }
  
  // Render shop info
  renderShopInfo(currentShopData);
  
  // Load shop products
  loadShopProducts(currentShopData.ownerId);
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Update hash
  window.location.hash = '#shop-products/' + shopId;
}

/**
 * Render Shop Info Card
 */
function renderShopInfo(shop) {
  const shopInfoCard = document.getElementById('shopInfoCard');
  
  if (!shopInfoCard) return;
  
  shopInfoCard.innerHTML = `
    <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; color: white;">
      <div class="d-flex align-items-start justify-content-between">
        <div style="flex: 1;">
          <h4 style="font-weight: 700; color: white; margin-bottom: 8px;">
            <i class="bi bi-shop me-2"></i>${escapeHtml(shop.shopName)}
          </h4>
          <p style="font-size: 0.95rem; opacity: 0.95; margin-bottom: 4px;">
            <i class="bi bi-person me-2"></i>${escapeHtml(shop.ownerName)}
          </p>
          <p style="font-size: 0.9rem; opacity: 0.9; margin: 0;">
            <i class="bi bi-phone me-2"></i>${escapeHtml(shop.mobile)}
          </p>
        </div>
        <span class="badge" style="background: rgba(255,255,255,0.3); color: white; font-size: 0.85rem; padding: 6px 12px;">Active</span>
      </div>
    </div>
    <div class="card-body">
      <p style="margin: 0; color: #666;">
        <i class="bi bi-geo-alt-fill me-2" style="color: #dc3545;"></i>${escapeHtml(shop.address)}
      </p>
    </div>
  `;
}

/**
 * Load Shop Products from Firestore
 */
async function loadShopProducts(ownerId) {
  console.log('üîÑ Loading products for owner:', ownerId);
  
  const productsGrid = document.getElementById('shopProductsGrid');
  const emptyState = document.getElementById('shopProductsEmptyState');
  
  if (!productsGrid) {
    console.error('‚ùå Products grid not found');
    return;
  }
  
  // Show loading
  productsGrid.innerHTML = `
    <div class="col-12" style="text-align: center; padding: 40px;">
      <div class="spinner-border text-success" role="status"></div>
      <p class="mt-3">Loading products...</p>
    </div>
  `;
  
  try {
    const { collection, getDocs, query, where } = window.firebaseImports;
    
    // Load products for this shop owner from their tenant collection
    const productsRef = collection(window.db, 'tenants', ownerId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    allShopProducts = [];
    productsSnap.forEach((doc) => {
      allShopProducts.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${allShopProducts.length} products`);
    
    // Render products
    renderShopProducts(allShopProducts);
    
  } catch (error) {
    console.error('‚ùå Error loading shop products:', error);
    
    productsGrid.innerHTML = `
      <div class="col-12">
        <div class="alert alert-danger" style="border-radius: 12px;">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Error loading products:</strong> ${error.message}
        </div>
      </div>
    `;
  }
}

/**
 * Render Shop Products
 */
function renderShopProducts(products) {
  const productsGrid = document.getElementById('shopProductsGrid');
  const emptyState = document.getElementById('shopProductsEmptyState');
  
  if (!productsGrid) return;
  
  // Clear grid
  productsGrid.innerHTML = '';
  
  if (products.length === 0) {
    productsGrid.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  productsGrid.style.display = 'flex';
  if (emptyState) emptyState.style.display = 'none';
  
  // Render each product
  products.forEach(product => {
    const productCard = `
      <div class="col-md-4 col-sm-6 col-12">
        <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
          
          <!-- Product Image/Icon -->
          <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-box-seam" style="font-size: 3rem; color: #1976d2;"></i>
          </div>
          
          <!-- Product Body -->
          <div class="card-body">
            <h6 class="mb-2" style="font-weight: 600; color: #333; min-height: 40px;">
              ${escapeHtml(product.name || 'Unnamed Product')}
            </h6>
            
            <div class="mb-2">
              ${product.brand ? `<span class="badge" style="background: #e3f2fd; color: #1976d2; font-size: 0.75rem; margin-right: 5px;">${escapeHtml(product.brand)}</span>` : ''}
              ${product.size ? `<span class="badge" style="background: #f3e5f5; color: #7b1fa2; font-size: 0.75rem;">${escapeHtml(product.size)}</span>` : ''}
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span style="font-size: 1.2rem; font-weight: 700; color: #25D366;">
                ‚Çπ${formatPrice(product.price || 0)}
              </span>
              <span class="text-muted" style="font-size: 0.85rem;">
                Stock: ${product.stock || 0}
              </span>
            </div>
            
            <button class="btn btn-sm w-100" style="background: #25D366; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;" onclick="addToCart('${product.id}')">
              <i class="bi bi-cart-plus me-1"></i>Add to Cart
            </button>
          </div>
          
        </div>
      </div>
    `;
    
    productsGrid.insertAdjacentHTML('beforeend', productCard);
  });
}

/**
 * Filter Shop Products
 */
function filterShopProducts(searchTerm) {
  const term = searchTerm.toLowerCase().trim();
  
  if (!term) {
    renderShopProducts(allShopProducts);
    return;
  }
  
  const filtered = allShopProducts.filter(product => {
    const name = (product.name || '').toLowerCase();
    const brand = (product.brand || '').toLowerCase();
    const size = (product.size || '').toLowerCase();
    
    return name.includes(term) || brand.includes(term) || size.includes(term);
  });
  
  renderShopProducts(filtered);
}

/**
 * Go Back to Home
 */
function goBackHome() {
  console.log('üè† Going back to home');
  
  // Hide shop products page
  const shopProductsPage = document.getElementById('shopProductsPage');
  if (shopProductsPage) {
    shopProductsPage.style.display = 'none';
    shopProductsPage.classList.remove('active');
  }
  
  // Show main app and navbar
  const mainApp = document.getElementById('mainApp');
  const mainNavbar = document.getElementById('mainNavbar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  
  if (mainApp) {
    mainApp.style.display = 'block';
  }
  
  if (mainNavbar) {
    mainNavbar.style.display = 'flex';
  }
  
  if (sidebarToggleBtn) {
    sidebarToggleBtn.style.display = 'block';
  }
  
  // Clear search
  const searchInput = document.getElementById('searchShopProductsInput');
  if (searchInput) {
    searchInput.value = '';
  }
  
  // Reset current shop data
  currentShopData = null;
  allShopProducts = [];
  
  // Update hash
  window.location.hash = '#home';
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Format Price
 */
function formatPrice(price) {
  return Number(price || 0).toLocaleString('en-IN', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}

/**
 * Add to Cart (Placeholder)
 */
function addToCart(productId) {
  console.log('üõí Add to cart:', productId);
  alert('üõí Add to Cart feature coming soon!\n\nProduct ID: ' + productId);
}



</script>

</body>
</html>
