<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Urban Estate 2 Local Shop</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="UE2 Shop">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
      import {
        getAuth,
        signInWithPopup,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut
      } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
      import {
  getFirestore,
  collection,
  collectionGroup,
  doc,
  getDoc,
  getDocs,
  setDoc,
  addDoc,
  updateDoc,
  query,
  where,
  serverTimestamp
} from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';



      // ‚ö†Ô∏è REPLACE WITH YOUR FIREBASE CONFIG
      const firebaseConfig = {
        apiKey: "AIzaSyBLt_z6QrkwXwK2l8tDq-n7choUJ6vUJf0",
  authDomain: "zepblink-3e1c7.firebaseapp.com",
  projectId: "zepblink-3e1c7",
  storageBucket: "zepblink-3e1c7.firebasestorage.app",
  messagingSenderId: "275105674132",
  appId: "1:275105674132:web:1e0460f6765a580c461581"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.auth = auth;
      window.db = db;
      window.firebaseImports = {
  collection, collectionGroup, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, query, where, serverTimestamp,
  signInWithPopup, signInWithEmailAndPassword, GoogleAuthProvider, 
  onAuthStateChanged, signOut
};


      console.log("‚úÖ Firebase SDK loaded successfully!");

    // Auth State Listener
onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log('‚úÖ User signed in:', user.email);

    // Check if user exists in Firestore and get their role
    let userRole = 'customer'; // Default role
    
    try {
      const userDocRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userDocRef);

      if (userDoc.exists()) {
        // Get role from Firestore
        userRole = userDoc.data().role || 'customer';
        console.log('üìù User role from Firestore:', userRole);
        
        // Update last login
        await setDoc(userDocRef, {
          lastLogin: serverTimestamp()
        }, { merge: true });
      } else {
        // Determine role based on email
        userRole = isAuthorizedShopowner(user.email) ? 'shopowner' : 'customer';
        
        // Create new user document with role
        await setDoc(userDocRef, {
          email: user.email,
          displayName: user.displayName || user.email.split('@')[0],
          photoURL: user.photoURL,
          location: 'Urban Estate 2, Hisar',
          role: userRole,
          createdAt: serverTimestamp(),
          lastLogin: serverTimestamp()
        });
        console.log('‚úÖ New user created with role:', userRole);
      }
    } catch (error) {
      console.error('‚ùå Error checking user data:', error);
    }

    // Store user info with role
    window.currentUser = {
      email: user.email,
      uid: user.uid,
      displayName: user.displayName || user.email.split('@')[0],
      photoURL: user.photoURL || null,
      role: userRole  // ‚úÖ Add role here
    };

    console.log('‚úÖ Current user:', window.currentUser);

    // Show main app
    showApp();
  } else {
    console.log('‚ùå No user signed in');
    window.currentUser = null;
    showAuthScreen();
  }
});


      // Check if email is authorized shopowner
      function isAuthorizedShopowner(email) {
        const authorizedEmails = [
          'sharma.uday8831@gmail.com',
          'shopowner2@example.com',
          'shopowner3@example.com'
          // Add more authorized shopowner emails here
        ];
        return authorizedEmails.includes(email.toLowerCase());
      }

      window.isAuthorizedShopowner = isAuthorizedShopowner;

      function showApp() {
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  updateUserInfo();
  
  // ‚úÖ Load shops after showing app
  setTimeout(() => {
    loadShopsFromFirestore();
  }, 500);
}


      function showAuthScreen() {
        document.getElementById('authScreen').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
      }


      function updateUserInfo() {
  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const userEmailDropdown = document.getElementById('userEmailDropdown');
  const userEmailMobile = document.getElementById('userEmailMobile');
  const userAvatar = document.getElementById('userAvatar');
  const userAvatarMobile = document.getElementById('userAvatarMobile');
  const userRole = document.getElementById('userRole');
  const userRoleDropdown = document.getElementById('userRoleDropdown');
  const userRoleDropdownMobile = document.getElementById('userRoleDropdownMobile');
  const userRoleMobile = document.getElementById('userRoleMobile');

  if (window.currentUser) {
    const displayName = window.currentUser.displayName;
    const email = window.currentUser.email;
    const role = window.currentUser.role || 'customer';
    
    // Update user name
    if (userName) userName.textContent = displayName;
    if (userEmail) userEmail.textContent = email;
    if (userEmailDropdown) userEmailDropdown.textContent = email;
    if (userEmailMobile) userEmailMobile.textContent = email;
    
    // Update avatar
    const avatarUrl = window.currentUser.photoURL || 
                     `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=25D366&color=fff`;
    if (userAvatar) userAvatar.src = avatarUrl;
    if (userAvatarMobile) userAvatarMobile.src = avatarUrl;
    
    // Update role badges
    let roleText = '';
    let roleColor = '';
    let roleIcon = '';
    
    if (role === 'shopowner') {
      roleText = 'üè™ Shopowner';
      roleColor = 'background: #ffc107; color: #000;';
      roleIcon = 'bi-shop';
    } else if (role === 'customer') {
      roleText = 'üõçÔ∏è Customer';
      roleColor = 'background: #0d6efd; color: white;';
      roleIcon = 'bi-person';
    } else {
      roleText = 'üë§ Guest';
      roleColor = 'background: #6c757d; color: white;';
      roleIcon = 'bi-person-circle';
    }
    
    if (userRole) {
      userRole.textContent = roleText;
      userRole.setAttribute('style', `font-size: 0.65rem; padding: 2px 8px; margin-top: 2px; ${roleColor} border-radius: 10px;`);
    }
    
    if (userRoleDropdown) {
      userRoleDropdown.textContent = roleText;
      userRoleDropdown.setAttribute('style', `font-size: 0.7rem; ${roleColor} border-radius: 10px; padding: 3px 8px;`);
    }
    
    if (userRoleDropdownMobile) {
      userRoleDropdownMobile.textContent = roleText;
      userRoleDropdownMobile.setAttribute('style', `font-size: 0.7rem; ${roleColor} border-radius: 10px; padding: 3px 8px;`);
    }
    
    if (userRoleMobile) {
      userRoleMobile.textContent = roleText.split(' ')[0]; // Just the emoji
      userRoleMobile.setAttribute('style', `position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px; ${roleColor} border-radius: 10px;`);
    }
    
    // ‚úÖ NEW: Show/Hide Register Shop Button based on role
    const registerShopBtn = document.getElementById('registerShopBtn');
    const registerShopBtnMobile = document.getElementById('registerShopBtnMobile');
    
    if (role === 'shopowner') {
      // Show Register Shop button for shopowners
      if (registerShopBtn) {
        registerShopBtn.classList.remove('d-none');
        registerShopBtn.style.display = 'block';
      }
      if (registerShopBtnMobile) {
        registerShopBtnMobile.style.display = 'block';
      }
      console.log('‚úÖ Register Shop button shown (Shopowner)');
    } else {
      // Hide for customers and guests
      if (registerShopBtn) {
        registerShopBtn.classList.add('d-none');
        registerShopBtn.style.display = 'none';
      }
      if (registerShopBtnMobile) {
        registerShopBtnMobile.style.display = 'none';
      }
      console.log('‚ÑπÔ∏è Register Shop button hidden (Customer/Guest)');
    }
    
  } else {
    // Guest mode
    if (userName) userName.textContent = 'Guest User';
    if (userEmail) userEmail.textContent = 'guest@ue2shop.local';
    if (userEmailDropdown) userEmailDropdown.textContent = 'guest@ue2shop.local';
    if (userEmailMobile) userEmailMobile.textContent = 'guest@ue2shop.local';
    
    const guestAvatar = 'https://ui-avatars.com/api/?name=Guest&background=6c757d&color=fff';
    if (userAvatar) userAvatar.src = guestAvatar;
    if (userAvatarMobile) userAvatarMobile.src = guestAvatar;
    
    const guestRole = 'üë§ Guest';
    const guestStyle = 'background: #6c757d; color: white; border-radius: 10px;';
    
    if (userRole) {
      userRole.textContent = guestRole;
      userRole.setAttribute('style', `font-size: 0.65rem; padding: 2px 8px; margin-top: 2px; ${guestStyle}`);
    }
    if (userRoleDropdown) {
      userRoleDropdown.textContent = guestRole;
      userRoleDropdown.setAttribute('style', `font-size: 0.7rem; ${guestStyle} padding: 3px 8px;`);
    }
    if (userRoleDropdownMobile) {
      userRoleDropdownMobile.textContent = guestRole;
      userRoleDropdownMobile.setAttribute('style', `font-size: 0.7rem; ${guestStyle} padding: 3px 8px;`);
    }
    if (userRoleMobile) {
      userRoleMobile.textContent = 'üë§';
      userRoleMobile.setAttribute('style', `position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px; ${guestStyle}`);
    }
    
    // ‚úÖ NEW: Hide Register Shop button for guests
    const registerShopBtn = document.getElementById('registerShopBtn');
    const registerShopBtnMobile = document.getElementById('registerShopBtnMobile');
    
    if (registerShopBtn) {
      registerShopBtn.classList.add('d-none');
      registerShopBtn.style.display = 'none';
    }
    if (registerShopBtnMobile) {
      registerShopBtnMobile.style.display = 'none';
    }
  }
}


    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<!-- ============================================
     AUTHENTICATION SCREEN
     ============================================ -->
<div id="authScreen" style="display: block;">
  <div class="auth-container">
    <div class="auth-card">

      <!-- App Icon & Branding -->
      <div class="auth-header">
        <div class="app-icon">
          <i class="bi bi-shop"></i>
        </div>
        <h1 class="app-title">Urban Estate 2</h1>
        <p class="app-subtitle">Local Shop - Hisar</p>
        <p class="location-badge">
          <i class="bi bi-geo-alt-fill"></i> Urban Estate 2, Hisar Only
        </p>
      </div>

      <!-- Welcome Message -->
      <div class="auth-body">
        <h2 class="welcome-text">Welcome Back!</h2>
        <p class="welcome-subtext">Order from your favorite local shops in Urban Estate 2</p>

        <!-- Google Sign-In Button (FOR CUSTOMERS) -->
        <button 
          onclick="handleGoogleSignIn()" 
          class="btn-google-signin" 
          id="googleSignInBtn"
        >
          <svg width="20" height="20" viewBox="0 0 18 18" class="google-icon">
            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
          </svg>
          <span class="btn-text">Continue with Google</span>
        </button>

        <!-- Divider -->
        <div class="position-relative my-4">
          <hr style="border-top: 1px solid #dee2e6;">
          <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0 15px; color: #6c757d; font-size: 0.875rem;">
            OR
          </span>
        </div>

        <!-- Email/Password Sign-In (FOR AUTHORIZED SHOPOWNERS ONLY) -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Shopowner Email" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>

          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>

          <button type="submit" id="loginButton" class="btn btn-outline-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In with Email
          </button>
        </form>

        <p class="text-muted mt-3" style="font-size: 0.8rem; text-align: center;">
          <i class="bi bi-info-circle"></i> Email sign-in is for authorized shopowners only
        </p>

        <!-- ‚úÖ NEW: Skip Login Button (Temporary) -->
        <div class="mt-4 pt-3" style="border-top: 1px solid #dee2e6;">
          <button onclick="skipLogin()" class="btn btn-sm w-100" style="background: rgba(37, 211, 102, 0.1); color: #128C7E; border: 1px dashed #128C7E; border-radius: 8px; padding: 10px; font-weight: 600;">
            <i class="bi bi-skip-forward-circle me-2"></i>Skip Login (Temporary - Development)
          </button>
        </div>

        <!-- Features -->
        <div class="auth-features">
          <div class="feature-item">
            <i class="bi bi-lightning-charge-fill"></i>
            <span>Quick Orders</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-truck"></i>
            <span>Local Delivery</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-shield-check"></i>
            <span>Secure Payment</span>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="auth-footer">
        <p class="security-text">
          <i class="bi bi-shield-lock"></i> 
          Secured by Firebase Authentication
        </p>
      </div>

    </div>
  </div>
</div>

<!-- ============================================
     MAIN APP - HOMEPAGE
     ============================================ -->
<div id="mainApp" style="display: none;">

  <!-- ============================================
       HAMBURGER BUTTON & SIDEBAR
       ============================================ -->
  <!-- Hamburger Menu Button -->
  <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar Menu -->
  <nav class="sidebar-menu" id="sidebarMenu">
    
    <!-- Sidebar Header -->
    <div class="sidebar-header">
      <i class="bi bi-shop" style="font-size: 32px;"></i>
      <h4 class="mt-2">UE2 Shop Menu</h4>
    </div>
    
    <!-- Home -->
    <div class="sidebar-item" onclick="goToHome()">
      <i class="bi bi-house-door"></i>
      <span>Home</span>
    </div>
    
    <!-- SHOPPING Section -->
    <div class="sidebar-section-title">SHOPPING</div>
    
    <div class="sidebar-item" onclick="navigateTo('categories')">
      <i class="bi bi-grid-3x3-gap"></i>
      <span>Shop by Category</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('shops')">
      <i class="bi bi-shop-window"></i>
      <span>All Shops</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('deals')">
      <i class="bi bi-tag-fill"></i>
      <span>Deals & Offers</span>
    </div>
    
    <!-- MY ACCOUNT Section -->
    <div class="sidebar-section-title">MY ACCOUNT</div>
    
    <!-- For Customers -->
<a href="#" onclick="navigateToCustomerOrders(); return false;" class="sidebar-link">
  <i class="bi bi-bag-check"></i>
  <span>My Orders</span>
</a>

    
    <div class="sidebar-item" onclick="navigateTo('cart')">
      <i class="bi bi-cart3"></i>
      <span>Shopping Cart</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('favorites')">
      <i class="bi bi-heart-fill"></i>
      <span>Favorites</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('address')">
      <i class="bi bi-geo-alt-fill"></i>
      <span>Delivery Address</span>
    </div>
    
    <!-- SETTINGS Section -->
    <div class="sidebar-section-title">SETTINGS</div>
    
    <div class="sidebar-item" onclick="navigateTo('profile')">
      <i class="bi bi-person-circle"></i>
      <span>Profile Settings</span>
    </div>
    
    <div class="sidebar-item" onclick="navigateTo('help')">
      <i class="bi bi-question-circle"></i>
      <span>Help & Support</span>
    </div>
    
  </nav>


  <!-- ‚úÖ NAVBAR - Professional with User Dropdown + Register Shop Button -->
<nav id="mainNavbar" class="navbar navbar-dark sticky-top" 
style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 12px 0; padding-left: 70px;">
<div class="container-fluid">
<div class="w-100">
 
 <!-- Row 1: App Name + Buttons -->
 <div class="d-flex align-items-center justify-content-between">
   <!-- App Name -->
   <span class="navbar-brand mb-0 h1 d-flex align-items-center" style="margin: 0; font-size: 1.3rem;">
     <i class="bi bi-shop me-2" style="font-size: 1.5rem;"></i>
     <span>UE2 Shop</span>
   </span>
   
   <!-- Right Side: Register Shop Button + User Dropdown -->
   <div class="d-flex align-items-center gap-3">
     
     <!-- ‚úÖ NEW: Register Shop Button (Shopowners Only) -->
     <button 
       id="registerShopBtn" 
       class="btn btn-light d-none" 
       onclick="openRegisterShopModal()" 
       style="border-radius: 10px; font-weight: 600; padding: 8px 16px; display: none;">
       <i class="bi bi-shop me-2"></i>Register Shop
     </button>
     
     <!-- Desktop: User Dropdown with Role Badge -->
     <div class="dropdown d-none d-md-block">
       <button class="btn text-white d-flex align-items-center" 
               type="button" 
               id="userDropdown" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 10px; font-weight: 600; padding: 8px 16px;">
         <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
         <div class="d-flex flex-column align-items-start me-2">
           <span id="userName" style="font-size: 0.9rem;">Loading...</span>
           <span id="userRole" class="badge" style="font-size: 0.65rem; padding: 2px 8px; margin-top: 2px;">Guest</span>
         </div>
         <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
       </button>
       
       <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown" style="border-radius: 10px; min-width: 250px; border: none;">
         <li>
           <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
             <div class="d-flex align-items-center">
               <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=25D366&color=fff" alt="User" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
               <div style="flex: 1;">
                 <strong id="userEmailDropdown" style="font-size: 0.85rem; display: block;">user@example.com</strong>
                 <span id="userRoleDropdown" class="badge mt-1" style="font-size: 0.7rem;">Guest</span>
               </div>
             </div>
           </div>
         </li>
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('orders'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-bag me-2" style="color: #25D366;"></i>
             <span style="font-weight: 500;">My Orders</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('favorites'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-heart me-2" style="color: #dc3545;"></i>
             <span style="font-weight: 500;">Favorites</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('address'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-geo-alt me-2" style="color: #0d6efd;"></i>
             <span style="font-weight: 500;">Delivery Address</span>
           </a>
         </li>
         
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <button class="dropdown-item d-flex align-items-center" onclick="handleSignOut()" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
             <i class="bi bi-box-arrow-right me-2" style="color: #128C7E;"></i>
             <span style="color: #128C7E; font-weight: 500;">Sign Out</span>
           </button>
         </li>
       </ul>
     </div>
     
     <!-- Mobile: User Icon Button with Badge -->
     <div class="dropdown d-md-none">
       <button class="btn text-white position-relative" 
               type="button" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 10px; padding: 8px 12px;">
         <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
         <span id="userRoleMobile" class="badge position-absolute" style="top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px;">Guest</span>
       </button>
       
       <ul class="dropdown-menu dropdown-menu-end shadow" style="border-radius: 10px; min-width: 250px; border: none;">
         <li>
           <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
             <div class="d-flex align-items-center">
               <img id="userAvatarMobile" src="https://ui-avatars.com/api/?name=Guest&background=25D366&color=fff" alt="User" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
               <div style="flex: 1;">
                 <strong id="userEmailMobile" style="font-size: 0.85rem; display: block;">user@example.com</strong>
                 <span id="userRoleDropdownMobile" class="badge mt-1" style="font-size: 0.7rem;">Guest</span>
               </div>
             </div>
           </div>
         </li>
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <!-- ‚úÖ NEW: Mobile Register Shop Button -->
         <li id="registerShopBtnMobile" style="display: none;">
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="openRegisterShopModal(); return false;" style="padding: 12px 16px; background: rgba(37, 211, 102, 0.1);">
             <i class="bi bi-shop me-2" style="color: #25D366;"></i>
             <span style="font-weight: 600; color: #128C7E;">Register Shop</span>
           </a>
           <hr class="dropdown-divider" style="margin: 0;">
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('orders'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-bag me-2" style="color: #25D366;"></i>
             <span style="font-weight: 500;">My Orders</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('favorites'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-heart me-2" style="color: #dc3545;"></i>
             <span style="font-weight: 500;">Favorites</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('address'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-geo-alt me-2" style="color: #0d6efd;"></i>
             <span style="font-weight: 500;">Delivery Address</span>
           </a>
         </li>
         
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <button class="dropdown-item d-flex align-items-center" onclick="handleSignOut()" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
             <i class="bi bi-box-arrow-right me-2" style="color: #128C7E;"></i>
             <span style="color: #128C7E; font-weight: 500;">Sign Out</span>
           </button>
         </li>
       </ul>
     </div>
     
   </div>
   
 </div>
 
</div>
</div>
</nav>

<!-- ‚úÖ Sync Indicator -->
<div id="syncIndicator" class="sync-indicator" style="display: none;">
<i class="bi bi-arrow-repeat"></i> 
<span id="syncText">Syncing...</span>
</div>


<!-- ============================================
     REGISTER SHOP MODAL
     ============================================ -->
     <div class="modal fade" id="registerShopModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-shop me-2"></i>Register Your Shop
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <form id="registerShopForm">
              
              <!-- Shop Name -->
              <div class="mb-3">
                <label for="shopName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-shop me-2" style="color: #25D366;"></i>Shop Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="shopName" 
                  placeholder="e.g., ABC Tiles & Sanitaryware"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Owner Name -->
              <div class="mb-3">
                <label for="ownerName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-person me-2" style="color: #128C7E;"></i>Owner Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="ownerName" 
                  placeholder="e.g., Rajesh Kumar"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Mobile Number -->
              <div class="mb-3">
                <label for="shopMobile" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-phone me-2" style="color: #0d6efd;"></i>Mobile Number <span style="color: red;">*</span>
                </label>
                <input 
                  type="tel" 
                  class="form-control form-control-lg" 
                  id="shopMobile" 
                  placeholder="e.g., 9876543210"
                  required
                  pattern="[0-9]{10}"
                  maxlength="10"
                  style="border-radius: 10px;"
                >
                <small class="text-muted">Enter 10-digit mobile number</small>
              </div>
              
              <!-- Address -->
              <div class="mb-3">
                <label for="shopAddress" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-geo-alt me-2" style="color: #dc3545;"></i>Shop Address <span style="color: red;">*</span>
                </label>
                <textarea 
                  class="form-control" 
                  id="shopAddress" 
                  rows="3" 
                  placeholder="e.g., Shop No. 45, Urban Estate 2, Hisar"
                  required
                  style="border-radius: 10px;"
                ></textarea>
              </div>
              
            </form>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn" onclick="handleRegisterShop()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-check-circle me-2"></i>Register Shop
            </button>
          </div>
          
        </div>
      </div>
    </div>
    


    
    



  <!-- Main Content -->
  <main class="main-content" style="padding: 20px 0; min-height: calc(100vh - 70px); background: #F8F9F8;">
    <div class="container">

      <!-- Welcome Banner -->
      <div class="card mb-4" style="border: none; border-radius: 15px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white;">
        <div class="card-body p-4">
          <h2 class="mb-2" style="color: white; font-weight: 700;">
            <i class="bi bi-emoji-smile"></i> Welcome to Urban Estate 2 Shop!
          </h2>
          <p class="mb-0" style="opacity: 0.95;">Order from your favorite local shops, delivered to your doorstep.</p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-shop" style="font-size: 2rem; color: #25D366;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">12</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Active Shops</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-box-seam" style="font-size: 2rem; color: #128C7E;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">450+</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Products</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-truck" style="font-size: 2rem; color: #0d6efd;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">Fast</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Delivery</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-shield-check" style="font-size: 2rem; color: #198754;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">100%</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Secure</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Featured Products Section -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 style="font-weight: 700; color: #333; margin: 0;">
            <i class="bi bi-star-fill me-2" style="color: #ffc107;"></i>
            Featured Products
          </h3>
          <a href="#" class="text-decoration-none" style="color: #25D366; font-weight: 600; font-size: 0.9rem;">
            View All <i class="bi bi-arrow-right"></i>
          </a>
        </div>

        <div class="row g-3">
          <!-- Product Card 1 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-box-seam" style="font-size: 3rem; color: #1976d2;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 1</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop A</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ299</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Card 2 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-basket" style="font-size: 3rem; color: #7b1fa2;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 2</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop B</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ499</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Card 3 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-bag-heart" style="font-size: 3rem; color: #e65100;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 3</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop C</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ199</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Product Card 4 -->
          <div class="col-md-3 col-6">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-gift" style="font-size: 3rem; color: #2e7d32;"></i>
              </div>
              <div class="card-body">
                <h6 class="mb-2" style="font-weight: 600; color: #333;">Product Name 4</h6>
                <p class="text-muted mb-2" style="font-size: 0.8rem;">Local Shop D</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ399</span>
                  <button class="btn btn-sm" style="background: #25D366; color: white; border: none; border-radius: 6px; padding: 4px 12px;">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Development Notice -->
      <div class="alert alert-info mt-4" role="alert" style="border-radius: 12px; border: none;">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Under Development:</strong> Product listings from local shopowners will be loaded here. Shopping cart and checkout coming soon!
      </div>

    </div>
  </main>

</div>

<!-- ============================================
     SHOP PRODUCTS PAGE
     ============================================ -->
     <div class="page-view" id="shopProductsPage" style="display: none;">
  
      <!-- Header -->
<div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <button class="btn btn-light" onclick="goBackHome()" style="border-radius: 10px; font-weight: 600;">
    <i class="bi bi-arrow-left me-2"></i>Back
  </button>
  <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
    <i class="bi bi-shop me-2"></i><span id="shopProductsPageTitle">Shop Products</span>
  </h3>
  <!-- ‚úÖ NEW: Add Products Button (Shopowners Only) -->
  <button id="addProductsBtn" class="btn btn-light" onclick="openAddProductsModal()" style="border-radius: 10px; font-weight: 600; display: none;">
    <i class="bi bi-plus-lg me-2"></i>Add Products
  </button>
  <div id="headerSpacer" style="width: 80px;"></div> <!-- Spacer for centering -->
</div>

      
      <!-- Shop Info Card -->
      <div class="container-fluid" style="padding: 20px;">
        <div id="shopInfoCard" class="card mb-4" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
          <!-- Shop info will be dynamically inserted here -->
        </div>
        
        <!-- Search Box -->
        <div class="mb-3">
          <input 
            type="text" 
            class="form-control form-control-lg" 
            id="searchShopProductsInput" 
            placeholder="üîç Search products..." 
            onkeyup="filterShopProducts(this.value)"
            style="border-radius: 10px; max-width: 600px; margin: 0 auto; display: block;"
          >
        </div>
        
        <!-- Products Grid -->
        <div id="shopProductsGrid" class="row g-3">
          <!-- Products will be rendered here -->
          <div class="col-12" style="text-align: center; padding: 40px;">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-3">Loading products...</p>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="shopProductsEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-box-seam" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">No Products Yet</h4>
          <p class="text-muted">This shop hasn't added any products yet.</p>
        </div>
      </div>
      
    </div>

    <!-- ============================================
     ADD PRODUCTS MODAL (FOR SHOPOWNERS)
     ============================================ -->
<div class="modal fade" id="addProductsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
        <h5 class="modal-title" style="font-weight: 700;">
          <i class="bi bi-plus-circle me-2"></i>Add Multiple Products
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-4">
        
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter product names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each product, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="productInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., Ceramic Tiles, Wall Tiles, Floor Tiles..."
          onkeydown="handleProductInputKeydown(event)"
          oninput="window.lastProductInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-success w-100"
          onclick="addProductToList()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="productsPreviewCount">
            üìù Products to Save (0):
          </p>
          <div id="productsPreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No products added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border: none; padding: 20px;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
        <button type="button" class="btn btn-success" onclick="saveAllProducts()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
          <i class="bi bi-check-circle me-2"></i>Save All Products
        </button>
      </div>
      
    </div>
  </div>
</div>

<!-- ============================================
     CART PAGE (FOR CUSTOMERS)
     ============================================ -->
     <div class="page-view" id="cartPage" style="display: none;">
  
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <button class="btn btn-light" onclick="goBackFromCart()" style="border-radius: 10px; font-weight: 600;">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
          <i class="bi bi-cart me-2"></i>Shopping Cart
        </h3>
        <div style="width: 80px;"></div> <!-- Spacer -->
      </div>
      
      <!-- Cart Content -->
      <div class="container-fluid" style="padding: 20px; padding-bottom: 100px;">
        
        <!-- Shop Info Card (Shows which shop items are from) -->
        <div id="cartShopInfo" class="card mb-4" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none;">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Cart Items List -->
        <div id="cartItemsList" class="mb-4">
          <!-- Cart items will be rendered here -->
        </div>
        
        <!-- Empty Cart State -->
        <div id="emptyCartState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-cart-x" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">Your cart is empty</h4>
          <p class="text-muted">Add products from shops to get started!</p>
          <button class="btn btn-success mt-3" onclick="goBackHome()" style="border-radius: 10px; padding: 10px 24px;">
            <i class="bi bi-shop me-2"></i>Browse Shops
          </button>
        </div>
        
        <!-- Cart Summary Card -->
        <div id="cartSummary" class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none;">
          <div class="card-body">
            <h5 style="font-weight: 700; margin-bottom: 20px;">Price Details</h5>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <span>Price (<span id="summaryItemCount">0</span> items)</span>
              <span id="summarySubtotal">‚Çπ0</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <span>Delivery Charges</span>
              <span id="summaryDelivery" style="color: #25D366;">FREE</span>
            </div>
            
            <hr>
            
            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700;">
              <span>Total Amount</span>
              <span style="color: #25D366;" id="summaryTotal">‚Çπ0</span>
            </div>
            
            <button class="btn btn-success w-100 mt-3" onclick="proceedToCheckout()" style="border-radius: 10px; padding: 12px; font-weight: 600; font-size: 1.1rem;">
              <i class="bi bi-check-circle me-2"></i>Proceed to Checkout
            </button>
          </div>
        </div>
        
      </div>
      
    </div>


<!-- ============================================
     ORDERS PAGE (FOR SHOPOWNERS)
     ============================================ -->
     <div class="page-view" id="ordersPage" style="display: none;">
  
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <button class="btn btn-light" onclick="goBackFromOrders()" style="border-radius: 10px; font-weight: 600;">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
          <i class="bi bi-receipt me-2"></i><span id="ordersPageTitle">Shop Orders</span>
        </h3>
        <div style="width: 80px;"></div>
      </div>
      
      <!-- Orders Content -->
      <div class="container-fluid" style="padding: 20px;">
        
        <!-- Shop Info Card -->
        <div id="ordersShopInfo" class="card mb-4" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none;">
          <!-- Will be populated -->
        </div>
        
        <!-- Filter Tabs -->
        <div class="mb-3">
          <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="filterOrders('all')" id="filterAll" style="border-radius: 10px 0 0 10px;">
              All Orders
            </button>
            <button type="button" class="btn btn-outline-warning" onclick="filterOrders('pending')">
              Pending
            </button>
            <button type="button" class="btn btn-outline-success" onclick="filterOrders('accepted')">
              Accepted
            </button>
            <button type="button" class="btn btn-outline-info" onclick="filterOrders('delivered')" style="border-radius: 0 10px 10px 0;">
              Delivered
            </button>
          </div>
        </div>
        
        <!-- Orders List -->
        <div id="ordersListContainer">
          <!-- Orders will be rendered here -->
          <div style="text-align: center; padding: 40px;">
            <div class="spinner-border text-warning" role="status"></div>
            <p class="mt-3">Loading orders...</p>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="ordersEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-inbox" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">No Orders Yet</h4>
          <p class="text-muted">Orders from customers will appear here.</p>
        </div>
        
      </div>
      
    </div>
    
    <!-- ============================================
         CUSTOMER ORDERS PAGE
         ============================================ -->
    <div class="page-view" id="customerOrdersPage" style="display: none;">
      
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <button class="btn btn-light" onclick="goBackHome()" style="border-radius: 10px; font-weight: 600;">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
          <i class="bi bi-bag-check me-2"></i>My Orders
        </h3>
        <div style="width: 80px;"></div>
      </div>
      
      <!-- Customer Orders Content -->
      <div class="container-fluid" style="padding: 20px;">
        
        <!-- Customer Orders List -->
        <div id="customerOrdersList">
          <!-- Customer orders will be rendered here -->
          <div style="text-align: center; padding: 40px;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading your orders...</p>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="customerOrdersEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-bag-x" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">No Orders Yet</h4>
          <p class="text-muted">Start shopping and place your first order!</p>
          <button class="btn btn-success mt-3" onclick="goBackHome()" style="border-radius: 10px; padding: 10px 24px;">
            <i class="bi bi-shop me-2"></i>Browse Shops
          </button>
        </div>
        
      </div>
      
    </div>
    



    <!-- ============================================
     MINI-CART FOOTER (PERSISTENT)
     ============================================ -->
<div id="miniCartFooter" style="
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: white;
box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
padding: 12px 20px;
display: none;
z-index: 9999;
cursor: pointer;
transition: transform 0.3s ease;
" onclick="navigateToCart()">

<div style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto;">
  
  <!-- Left: Item Count & Preview -->
  <div style="flex: 1;">
    <div style="font-weight: 700; font-size: 1rem; color: #333;">
      <i class="bi bi-cart3"></i> <span id="miniCartCount">0</span> Item(s)
    </div>
    <div style="font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="miniCartPreview">
      <!-- Product names preview -->
    </div>
  </div>
  
  <!-- Right: Total & CTA -->
  <div style="display: flex; align-items: center; gap: 20px;">
    <div style="text-align: right;">
      <div style="font-size: 0.85rem; color: #666;">Total</div>
      <div style="font-weight: 700; font-size: 1.2rem; color: #25D366;" id="miniCartTotal">‚Çπ0</div>
    </div>
    <button class="btn btn-success" style="border-radius: 10px; padding: 10px 20px; font-weight: 600; white-space: nowrap;">
      View Cart <i class="bi bi-arrow-right ms-1"></i>
    </button>
  </div>
  
</div>

</div>

<!-- ============================================
     SHOP CONFLICT MODAL
     ============================================ -->
     <div class="modal fade" id="shopConflictModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-exclamation-triangle me-2"></i>Different Shop Detected
            </h5>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <p style="font-size: 1rem; margin-bottom: 20px;">
              Your cart contains items from <strong id="currentShopName">Shop A</strong>.
            </p>
            <p style="font-size: 1rem; margin-bottom: 20px;">
              You're trying to add an item from <strong id="newShopName">Shop B</strong>.
            </p>
            <div class="alert alert-warning" style="border-radius: 10px;">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Note:</strong> You can only order from one shop at a time. Do you want to replace your current cart?
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" onclick="closeShopConflictModal()" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmReplaceCart()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-arrow-repeat me-2"></i>Replace Cart
            </button>
          </div>
          
        </div>
      </div>
    </div>
    
<!-- ============================================
     EDIT PRODUCT MODAL (SHOPOWNERS ONLY)
     ============================================ -->
     <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-pencil-square me-2"></i>Edit Product
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <form id="editProductForm">
              
              <!-- Hidden Product ID -->
              <input type="hidden" id="editProductId">
              
              <!-- Product Name -->
              <div class="mb-3">
                <label for="editProductName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-box-seam me-2" style="color: #1976d2;"></i>Product Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductName" 
                  placeholder="e.g., Ceramic Tiles"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Price -->
              <div class="mb-3">
                <label for="editProductPrice" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-currency-rupee me-2" style="color: #25D366;"></i>Price (‚Çπ) <span style="color: red;">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-control form-control-lg" 
                  id="editProductPrice" 
                  placeholder="e.g., 499"
                  required
                  min="0"
                  step="0.01"
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Stock -->
              <div class="mb-3">
                <label for="editProductStock" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-boxes me-2" style="color: #ff9800;"></i>Stock Quantity <span style="color: red;">*</span>
                </label>
                <div class="input-group" style="border-radius: 10px; overflow: hidden;">
                  <button 
                    type="button" 
                    class="btn btn-outline-danger" 
                    onclick="adjustEditStock(-1)"
                    style="border-radius: 10px 0 0 10px; padding: 0 20px;">
                    <i class="bi bi-dash-lg"></i>
                  </button>
                  <input 
                    type="number" 
                    class="form-control form-control-lg text-center" 
                    id="editProductStock" 
                    placeholder="0"
                    required
                    min="0"
                    style="border: 1px solid #dee2e6; font-weight: 600; font-size: 1.2rem;"
                  >
                  <button 
                    type="button" 
                    class="btn btn-outline-success" 
                    onclick="adjustEditStock(1)"
                    style="border-radius: 0 10px 10px 0; padding: 0 20px;">
                    <i class="bi bi-plus-lg"></i>
                  </button>
                </div>
                <small class="text-muted">Use - and + buttons or type directly</small>
              </div>
              
              <!-- Brand (Optional) -->
              <div class="mb-3">
                <label for="editProductBrand" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-tag me-2" style="color: #9c27b0;"></i>Brand (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductBrand" 
                  placeholder="e.g., Samsung"
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Size (Optional) -->
              <div class="mb-3">
                <label for="editProductSize" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-rulers me-2" style="color: #f44336;"></i>Size (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductSize" 
                  placeholder="e.g., 2x2 ft"
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Category (Optional) -->
              <div class="mb-3">
                <label for="editProductCategory" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-folder me-2" style="color: #ff5722;"></i>Category (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductCategory" 
                  placeholder="e.g., Floor Tiles"
                  style="border-radius: 10px;"
                >
              </div>
              
            </form>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="saveEditedProduct()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-check-circle me-2"></i>Save Changes
            </button>
          </div>
          
        </div>
      </div>
    </div>
    
    <!-- ============================================
     CHECKOUT MODAL (CUSTOMERS ONLY)
     ============================================ -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
        <h5 class="modal-title" style="font-weight: 700;">
          <i class="bi bi-check-circle me-2"></i>Checkout
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-4">
        
        <!-- Step Indicator -->
        <div class="mb-4">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1; text-align: center;">
              <div class="step-circle active" id="step1Circle">1</div>
              <small style="font-weight: 600;">Delivery Details</small>
            </div>
            <div style="flex: 0.5; height: 2px; background: #e0e0e0;" id="step1Line"></div>
            <div style="flex: 1; text-align: center;">
              <div class="step-circle" id="step2Circle">2</div>
              <small style="font-weight: 600;">Order Summary</small>
            </div>
            <div style="flex: 0.5; height: 2px; background: #e0e0e0;" id="step2Line"></div>
            <div style="flex: 1; text-align: center;">
              <div class="step-circle" id="step3Circle">3</div>
              <small style="font-weight: 600;">Confirm</small>
            </div>
          </div>
        </div>
        
        <!-- Step 1: Delivery Details -->
        <div id="checkoutStep1" style="display: block;">
          <h5 style="font-weight: 700; margin-bottom: 20px;">
            <i class="bi bi-geo-alt text-danger me-2"></i>Delivery Address
          </h5>
          
          <div class="alert alert-info" style="border-radius: 10px;">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Note:</strong> We currently deliver only in <strong>Urban Estate 2, Hisar</strong>
          </div>
          
          <form id="checkoutForm">
            
            <!-- Full Name -->
            <div class="mb-3">
              <label for="checkoutName" class="form-label" style="font-weight: 600;">
                <i class="bi bi-person me-2"></i>Full Name <span style="color: red;">*</span>
              </label>
              <input 
                type="text" 
                class="form-control form-control-lg" 
                id="checkoutName" 
                placeholder="e.g., Rajesh Kumar"
                required
                style="border-radius: 10px;"
              >
            </div>
            
            <!-- Phone Number -->
            <div class="mb-3">
              <label for="checkoutPhone" class="form-label" style="font-weight: 600;">
                <i class="bi bi-phone me-2"></i>Phone Number <span style="color: red;">*</span>
              </label>
              <input 
                type="tel" 
                class="form-control form-control-lg" 
                id="checkoutPhone" 
                placeholder="e.g., 9876543210"
                required
                pattern="[0-9]{10}"
                maxlength="10"
                style="border-radius: 10px;"
              >
              <small class="text-muted">10-digit mobile number</small>
            </div>
            
            <!-- Address -->
            <div class="mb-3">
              <label for="checkoutAddress" class="form-label" style="font-weight: 600;">
                <i class="bi bi-house me-2"></i>House/Flat Number <span style="color: red;">*</span>
              </label>
              <input 
                type="text" 
                class="form-control form-control-lg" 
                id="checkoutAddress" 
                placeholder="e.g., House No. 123, Block A"
                required
                style="border-radius: 10px;"
              >
            </div>
            
            <!-- Urban Estate 2 Confirmation -->
            <div class="mb-3">
              <label for="checkoutArea" class="form-label" style="font-weight: 600;">
                <i class="bi bi-map me-2"></i>Area <span style="color: red;">*</span>
              </label>
              <input 
                type="text" 
                class="form-control form-control-lg" 
                id="checkoutArea" 
                value="Urban Estate 2, Hisar"
                readonly
                style="border-radius: 10px; background: #f8f9fa;"
              >
            </div>
            
            <!-- Landmark (Optional) -->
            <div class="mb-3">
              <label for="checkoutLandmark" class="form-label" style="font-weight: 600;">
                <i class="bi bi-signpost me-2"></i>Landmark (Optional)
              </label>
              <input 
                type="text" 
                class="form-control form-control-lg" 
                id="checkoutLandmark" 
                placeholder="e.g., Near Park, Behind Market"
                style="border-radius: 10px;"
              >
            </div>
            
          </form>
        </div>
        
        <!-- Step 2: Order Summary -->
        <div id="checkoutStep2" style="display: none;">
          <h5 style="font-weight: 700; margin-bottom: 20px;">
            <i class="bi bi-receipt text-success me-2"></i>Order Summary
          </h5>
          
          <!-- Delivery Address Summary -->
          <div class="card mb-3" style="border-radius: 10px; border: 1px solid #e0e0e0;">
            <div class="card-body">
              <h6 style="font-weight: 600; margin-bottom: 10px;">
                <i class="bi bi-geo-alt text-danger me-2"></i>Delivering to:
              </h6>
              <div id="deliverySummary" style="color: #666;">
                <!-- Will be populated -->
              </div>
            </div>
          </div>
          
          <!-- Order Items -->
          <div class="card mb-3" style="border-radius: 10px; border: 1px solid #e0e0e0;">
            <div class="card-body">
              <h6 style="font-weight: 600; margin-bottom: 10px;">
                <i class="bi bi-cart text-success me-2"></i>Items:
              </h6>
              <div id="orderItemsSummary">
                <!-- Will be populated -->
              </div>
            </div>
          </div>
          
          <!-- Payment Method -->
          <div class="card mb-3" style="border-radius: 10px; border: 1px solid #e0e0e0;">
            <div class="card-body">
              <h6 style="font-weight: 600; margin-bottom: 10px;">
                <i class="bi bi-cash-coin text-warning me-2"></i>Payment Method:
              </h6>
              <div class="alert alert-warning mb-0" style="border-radius: 8px;">
                <strong>Cash on Delivery (COD)</strong> - Pay when you receive your order
              </div>
            </div>
          </div>
          
          <!-- Price Details -->
          <div class="card" style="border-radius: 10px; border: 1px solid #e0e0e0;">
            <div class="card-body">
              <h6 style="font-weight: 600; margin-bottom: 15px;">Price Details:</h6>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Subtotal (<span id="summaryItemCountCheckout">0</span> items)</span>
                <span id="summarySubtotalCheckout">‚Çπ0</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>Delivery Fee</span>
                <span style="color: #25D366; font-weight: 600;">FREE</span>
              </div>
              <hr>
              <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700;">
                <span>Total Amount</span>
                <span style="color: #25D366;" id="summaryTotalCheckout">‚Çπ0</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Step 3: Confirmation -->
        <div id="checkoutStep3" style="display: none;">
          <div style="text-align: center; padding: 40px 20px;">
            <i class="bi bi-check-circle" style="font-size: 64px; color: #25D366;"></i>
            <h3 style="margin-top: 20px; font-weight: 700;">Order Placed Successfully!</h3>
            <p style="font-size: 1.1rem; color: #666; margin-top: 15px;">
              Your order has been placed successfully.<br>
              Order ID: <strong id="confirmedOrderId">#ORD123456</strong>
            </p>
            <div class="alert alert-info mt-3" style="border-radius: 10px;">
              <i class="bi bi-info-circle me-2"></i>
              The shop owner will accept your order shortly and set a delivery time.
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border: none; padding: 20px;">
        <button type="button" class="btn btn-secondary" id="checkoutBackBtn" onclick="checkoutBack()" style="border-radius: 10px; padding: 10px 24px; display: none;">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="checkoutCancelBtn" style="border-radius: 10px; padding: 10px 24px;">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-success" id="checkoutNextBtn" onclick="checkoutNext()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
          Next <i class="bi bi-arrow-right ms-2"></i>
        </button>
        <button type="button" class="btn btn-success" id="checkoutConfirmBtn" onclick="confirmOrder()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600; display: none;">
          <i class="bi bi-check-circle me-2"></i>Place Order
        </button>
        <button type="button" class="btn btn-success" id="checkoutDoneBtn" onclick="closeCheckoutModal()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600; display: none;">
          <i class="bi bi-check-circle me-2"></i>Done
        </button>
      </div>
      
    </div>
  </div>
</div>




<!-- ============================================
     JAVASCRIPT
     ============================================ -->
<script>

function skipLogin() {
  console.log('‚è≠Ô∏è Skipping login - Guest mode');

  // Set temporary guest user
  window.currentUser = {
    email: 'guest@ue2shop.local',
    uid: 'guest_' + Date.now(),
    displayName: 'Guest User',
    photoURL: null,
    role: 'guest',  // ‚úÖ Add guest role
    isGuest: true
  };

  // Hide auth screen and show app
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  // Update UI
  if (typeof window.updateUserInfo === 'function') {
    window.updateUserInfo();
  }

  // Show notification
  setTimeout(() => {
    alert('‚ö†Ô∏è Guest Mode: You are browsing without authentication.\n\nSign in with Google or Email to place orders.');
  }, 500);
}


/**
 * Handle Google Sign-In (FOR CUSTOMERS)
 */
async function handleGoogleSignIn() {
  const googleSignInBtn = document.getElementById('googleSignInBtn');

  if (googleSignInBtn) {
    googleSignInBtn.disabled = true;
    googleSignInBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }

  try {
    console.log('üîê Starting Google Sign-In...');

    const { signInWithPopup, GoogleAuthProvider } = window.firebaseImports;
    const provider = new GoogleAuthProvider();

    provider.setCustomParameters({
      prompt: 'select_account'
    });

    const result = await signInWithPopup(window.auth, provider);
    const user = result.user;

    console.log('‚úÖ Google Sign-In successful!', user.email);

  } catch (error) {
    console.error('‚ùå Google Sign-In error:', error);

    let errorMessage = 'Google Sign-In failed. Please try again.';

    if (error.code === 'auth/popup-closed-by-user') {
      errorMessage = 'Sign-in cancelled. Please try again.';
    } else if (error.code === 'auth/popup-blocked') {
      errorMessage = 'Pop-up blocked. Please enable pop-ups for this site.';
    } else if (error.code === 'auth/cancelled-popup-request') {
      errorMessage = 'Only one sign-in at a time please.';
    } else if (error.code === 'auth/network-request-failed') {
      errorMessage = 'Network error. Check your internet connection.';
    }

    alert(errorMessage);

    if (googleSignInBtn) {
      googleSignInBtn.disabled = false;
      googleSignInBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 18 18" class="google-icon"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg><span class="btn-text">Continue with Google</span>';
    }
  }
}

/**
 * Handle Email/Password Sign-In (FOR AUTHORIZED SHOPOWNERS ONLY)
 */
 async function handleEmailPasswordAuth(event) {
  event.preventDefault();

  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const loginButton = document.getElementById('loginButton');

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  if (!window.isAuthorizedShopowner(email)) {
    alert('‚ùå Unauthorized! This email is not registered as a shopowner.\n\nCustomers should use Google Sign-In.');
    return;
  }

  if (loginButton) {
    loginButton.disabled = true;
    loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }

  try {
    console.log('üîê Starting Email/Password Sign-In for:', email);

    const { signInWithEmailAndPassword, doc, setDoc } = window.firebaseImports;
    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
    const user = userCredential.user;

    console.log('‚úÖ Email/Password Sign-In successful!', user.email);

    // ‚úÖ UPDATE: Set role as shopowner in Firestore
    try {
      const userDocRef = doc(window.db, 'users', user.uid);
      await setDoc(userDocRef, {
        email: user.email,
        displayName: user.displayName || user.email.split('@')[0],
        lastLogin: new Date().toISOString(),
        role: 'shopowner',  // ‚úÖ Email sign-in = shopowner
        location: 'Urban Estate 2, Hisar'
      }, { merge: true });
      
      console.log('‚úÖ Role updated to shopowner in Firestore');
      
      // ‚úÖ Update window.currentUser with role
      if (window.currentUser) {
        window.currentUser.role = 'shopowner';
      }
      
    } catch (firestoreError) {
      console.error('‚ö†Ô∏è Error updating Firestore:', firestoreError);
      // Continue anyway - auth was successful
    }

  } catch (error) {
    console.error('‚ùå Email/Password Sign-In error:', error);

    let errorMessage = 'Sign-in failed. Please try again.';

    if (error.code === 'auth/user-not-found') {
      errorMessage = 'No account found with this email. Please contact admin.';
    } else if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect password. Please try again.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email format.';
    } else if (error.code === 'auth/user-disabled') {
      errorMessage = 'This account has been disabled. Contact admin.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/invalid-credential') {
      errorMessage = 'Invalid email or password. Please try again.';
    }

    alert(errorMessage);

    if (loginButton) {
      loginButton.disabled = false;
      loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In with Email';
    }
  }
}


/**
 * Toggle Password Visibility
 */
function togglePasswordVisibility() {
  const passwordInput = document.getElementById('userPasswordInput');
  const toggleIcon = document.getElementById('passwordToggleIcon');

  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.classList.remove('bi-eye');
    toggleIcon.classList.add('bi-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIcon.classList.remove('bi-eye-slash');
    toggleIcon.classList.add('bi-eye');
  }
}

/**
 * Handle Sign Out
 */
async function handleSignOut() {
  if (window.currentUser && window.currentUser.isGuest) {
    // Guest mode - just reload page
    if (confirm('Return to login screen?')) {
      location.reload();
    }
    return;
  }

  if (confirm('Are you sure you want to sign out?')) {
    try {
      await window.auth.signOut();
      console.log('‚úÖ User signed out');
      location.reload();
    } catch (error) {
      console.error('‚ùå Sign out error:', error);
      alert('Failed to sign out. Please try again.');
    }
  }
}

/**
 * ==========================================
 * SIDEBAR MENU FUNCTIONALITY
 * ==========================================
 */

// Current page tracker
let currentPage = 'home';

/**
 * Toggle Sidebar
 */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    // Prevent body scroll when sidebar is open
    document.body.style.overflow = 'hidden';
  }
}

/**
 * Close Sidebar
 */
function closeSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  document.body.style.overflow = '';
}

/**
 * Go to Home function
 */
function goToHome() {
  console.log('üìç Going to Home');
  closeSidebar();
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Update active page
  currentPage = 'home';
  updateSidebarActive('home');
}

/**
 * Navigate to Different Pages
 */
function navigateTo(page) {
  console.log('üìç Navigating to:', page);
  
  // Update current page
  currentPage = page;
  
  // Close sidebar
  closeSidebar();
  
  // Update active state
  updateSidebarActive(page);
  
  // Handle navigation based on page
  const pageNames = {
    'categories': 'üìÇ Categories',
    'shops': 'üè™ All Shops',
    'deals': 'üè∑Ô∏è Deals & Offers',
    'orders': 'üì¶ My Orders',
    'cart': 'üõí Shopping Cart',
    'favorites': '‚ù§Ô∏è Favorites',
    'address': 'üìç Delivery Address',
    'profile': 'üë§ Profile Settings',
    'help': '‚ùì Help & Support'
  };
  
  const pageName = pageNames[page] || page;
  
  // Show coming soon alert
  alert(`‚è≥ "${pageName}" feature coming soon!\n\nThis will be implemented in the next phase.`);
}

/**
 * Sidebar Action function (for future use)
 */
function sidebarAction(action) {
  console.log('Sidebar action:', action);
  
  // Show coming soon for disabled items
  const actionName = action.replace(/([A-Z])/g, ' $1').trim();
  alert(`‚è≥ "${actionName}" feature coming soon!\n\nThis will be implemented in the next phase.`);
  
  closeSidebar();
}

/**
 * Update Active State in Sidebar
 */
function updateSidebarActive(page) {
  // Remove active class from all items
  const allItems = document.querySelectorAll('.sidebar-item');
  allItems.forEach(item => {
    item.classList.remove('active');
  });
  
  console.log('‚úÖ Active page:', page);
}

/**
 * Close sidebar on window resize (desktop view)
 */
window.addEventListener('resize', function() {
  if (window.innerWidth > 768) {
    closeSidebar();
  }
});

/**
 * Close sidebar on Escape key
 */
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeSidebar();
  }
});

/**
 * ==========================================
 * SHOP REGISTRATION FUNCTIONS
 * ==========================================
 */

// Global variable to store shops
let cachedShops = [];

/**
 * Open Register Shop Modal
 */
function openRegisterShopModal() {
  // Check if user is shopowner
  if (!window.currentUser || window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can register shops.\n\nPlease sign in with authorized email.');
    return;
  }
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('registerShopModal'));
  modal.show();
  
  // Clear form
  document.getElementById('registerShopForm').reset();
}

/**
 * Handle Shop Registration
 */
async function handleRegisterShop() {
  const shopName = document.getElementById('shopName').value.trim();
  const ownerName = document.getElementById('ownerName').value.trim();
  const shopMobile = document.getElementById('shopMobile').value.trim();
  const shopAddress = document.getElementById('shopAddress').value.trim();
  
  // Validation
  if (!shopName || !ownerName || !shopMobile || !shopAddress) {
    alert('‚ùå Please fill all required fields');
    return;
  }
  
  // Validate mobile number
  if (!/^[0-9]{10}$/.test(shopMobile)) {
    alert('‚ùå Please enter a valid 10-digit mobile number');
    return;
  }
  
  // Check if user is authenticated
  if (!window.currentUser || !window.currentUser.uid) {
    alert('‚ùå You must be signed in to register a shop');
    return;
  }
  
  // Show loading
  showSyncIndicator('Registering shop...', null);
  
  try {
    console.log('üè™ Registering shop:', shopName);
    
    const { collection, doc, setDoc } = window.firebaseImports;
    
    // Create shop document
    const shopData = {
      shopName: shopName,
      ownerName: ownerName,
      mobile: shopMobile,
      address: shopAddress,
      ownerId: window.currentUser.uid,
      ownerEmail: window.currentUser.email,
      status: 'active',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    // Save to Firestore: shops/{shopId}
    const shopId = 'shop_' + Date.now();
    const shopRef = doc(window.db, 'shops', shopId);
    await setDoc(shopRef, shopData);
    
    console.log('‚úÖ Shop registered successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('registerShopModal'));
    modal.hide();
    
    // Show success message
    showSyncIndicator('Shop registered successfully!', 2000);
    
    // Reload shops
    await loadShopsFromFirestore();
    
    // Show success alert
    setTimeout(() => {
      alert('‚úÖ Shop Registered Successfully!\n\n' +
            'Shop Name: ' + shopName + '\n' +
            'Owner: ' + ownerName + '\n\n' +
            'Your shop is now visible on the homepage!');
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error registering shop:', error);
    showSyncIndicator('Registration failed', 1500);
    alert('‚ùå Failed to register shop: ' + error.message + '\n\nPlease try again.');
  }
}

/**
 * Load Shops from Firestore
 */
async function loadShopsFromFirestore() {
  try {
    console.log('üîÑ Loading shops from Firestore...');
    
    const { collection, getDocs, query, where } = window.firebaseImports;
    
    // Load all active shops
    const shopsRef = collection(window.db, 'shops');
    const shopsQuery = query(shopsRef, where('status', '==', 'active'));
    const shopsSnap = await getDocs(shopsQuery);
    
    cachedShops = [];
    shopsSnap.forEach((doc) => {
      cachedShops.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${cachedShops.length} shops`);
    
    // Save to cache
    localStorage.setItem('ue2shop_shops_cache', JSON.stringify(cachedShops));
    
    // Render shops on homepage
    renderShopsOnHomepage();
    
  } catch (error) {
    console.error('‚ùå Error loading shops:', error);
    
    // Load from cache
    try {
      cachedShops = JSON.parse(localStorage.getItem('ue2shop_shops_cache') || '[]');
      renderShopsOnHomepage();
    } catch (e) {
      console.error('Failed to load from cache:', e);
    }
  }
}

/**
 * Render Shops on Homepage
 */
function renderShopsOnHomepage() {
  // Find the container (after featured products section)
  const mainContent = document.querySelector('.main-content .container');
  
  if (!mainContent) {
    console.warn('‚ö†Ô∏è Main content container not found');
    return;
  }
  
  // Remove existing shops section if any
  const existingSection = document.getElementById('shopsSection');
  if (existingSection) {
    existingSection.remove();
  }
  
  // Create shops section
  const shopsHTML = `
    <div id="shopsSection" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="font-weight: 700; color: #333; margin: 0;">
          <i class="bi bi-shop me-2" style="color: #25D366;"></i>
          Local Shops in Urban Estate 2
        </h3>
        <span class="badge" style="background: #25D366; color: white; font-size: 0.9rem; padding: 6px 12px; border-radius: 10px;">
          ${cachedShops.length} Shop${cachedShops.length !== 1 ? 's' : ''}
        </span>
      </div>
      
      <div class="row g-3" id="shopsGrid">
        ${cachedShops.length === 0 ? `
          <div class="col-12">
            <div class="alert alert-info" style="border-radius: 12px; border: none;">
              <i class="bi bi-info-circle me-2"></i>
              <strong>No shops registered yet.</strong><br>
              ${window.currentUser && window.currentUser.role === 'shopowner' ? 
                'Click "Register Shop" button to add your shop!' : 
                'Be the first to discover local shops here!'}
            </div>
          </div>
        ` : cachedShops.map(shop => `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              
              <!-- Shop Header -->
              <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; color: white;">
                <div class="d-flex align-items-start justify-content-between">
                  <div style="flex: 1;">
                    <h5 style="font-weight: 700; color: white; margin-bottom: 5px;">
                      <i class="bi bi-shop me-2"></i>${escapeHtml(shop.shopName)}
                    </h5>
                    <p style="font-size: 0.85rem; opacity: 0.9; margin: 0;">
                      <i class="bi bi-person me-1"></i>${escapeHtml(shop.ownerName)}
                    </p>
                  </div>
                  <span class="badge" style="background: rgba(255,255,255,0.3); color: white; font-size: 0.75rem;">Active</span>
                </div>
              </div>
              
              <!-- Shop Body -->
              <div class="card-body">
                <!-- Mobile -->
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-phone" style="color: #0d6efd; font-size: 1.2rem; margin-right: 10px;"></i>
                  <div>
                    <small class="text-muted" style="font-size: 0.75rem;">Mobile</small>
                    <p style="margin: 0; font-weight: 600; color: #333;">${escapeHtml(shop.mobile)}</p>
                  </div>
                </div>
                
                <!-- Address -->
                <div class="d-flex align-items-start mb-3">
                  <i class="bi bi-geo-alt-fill" style="color: #dc3545; font-size: 1.2rem; margin-right: 10px;"></i>
                  <div>
                    <small class="text-muted" style="font-size: 0.75rem;">Address</small>
                    <p style="margin: 0; font-size: 0.9rem; color: #666; line-height: 1.4;">${escapeHtml(shop.address)}</p>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                  <button class="btn btn-sm flex-fill" style="background: #25D366; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;">
                    <i class="bi bi-telephone me-1"></i>Call
                  </button>
                 <button class="btn btn-sm flex-fill" onclick="navigateToShopProducts('${shop.id}', '${escapeHtml(shop.shopName)}')" style="background: #128C7E; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;">
  <i class="bi bi-eye me-1"></i>View Products
</button>
                </div>
              </div>
              
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  // Insert before "Featured Products" section
  const featuredSection = mainContent.querySelector('.mb-4');
  if (featuredSection) {
    featuredSection.insertAdjacentHTML('afterend', shopsHTML);
  } else {
    mainContent.insertAdjacentHTML('afterbegin', shopsHTML);
  }
}


/**
 * Call Shop
 */
 function callShop(mobile) {
  console.log('üìû Calling:', mobile);
  window.location.href = 'tel:' + mobile;
}


/**
 * Sync Helper Functions
 */
function showSyncIndicator(msg = 'Syncing...', hideAfterMs = null) {
  const el = document.getElementById('syncIndicator');
  const textEl = document.getElementById('syncText');
  
  if (el && textEl) {
    textEl.textContent = msg;
    el.style.display = 'block';
    
    if (hideAfterMs) {
      setTimeout(() => {
        el.style.display = 'none';
      }, hideAfterMs);
    }
  }
}

function hideSyncIndicator() {
  const el = document.getElementById('syncIndicator');
  if (el) {
    el.style.display = 'none';
  }
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Load shops when app initializes
 * This runs after DOM is loaded and Firebase is ready
 */
 window.addEventListener('DOMContentLoaded', function() {
  console.log('üîÑ DOM loaded, waiting for auth...');
  
  // Check periodically if user is authenticated
  const checkAuthInterval = setInterval(() => {
    if (window.auth && window.auth.currentUser && document.getElementById('mainApp').style.display === 'block') {
      console.log('‚úÖ User authenticated, loading shops...');
      loadShopsFromFirestore();
      clearInterval(checkAuthInterval);
    }
  }, 500);
  
  // Stop checking after 10 seconds
  setTimeout(() => {
    clearInterval(checkAuthInterval);
  }, 10000);
});

/**
 * ==========================================
 * SHOP PRODUCTS PAGE FUNCTIONS
 * ==========================================
 */

// Global variables
let currentShopData = null;
let allShopProducts = [];

/**
 * Navigate to Shop Products Page
 */
 function navigateToShopProducts(shopId, shopName) {
  console.log('üè™ Navigating to Shop Products:', shopId, shopName);
  
  // Store current shop data
  currentShopData = cachedShops.find(shop => shop.id === shopId);
  
  if (!currentShopData) {
    console.error('‚ùå Shop not found:', shopId);
    alert('Shop not found!');
    return;
  }
  
  // Hide main app and navbar
  const mainApp = document.getElementById('mainApp');
  const mainNavbar = document.getElementById('mainNavbar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  if (sidebarToggleBtn) {
    sidebarToggleBtn.style.display = 'none';
  }
  
  // Show shop products page
  const shopProductsPage = document.getElementById('shopProductsPage');
  if (shopProductsPage) {
    shopProductsPage.style.display = 'block';
    shopProductsPage.classList.add('active');
  }
  
  // Update page title
  const pageTitle = document.getElementById('shopProductsPageTitle');
  if (pageTitle) {
    pageTitle.textContent = shopName;
  }
  
  // Render shop info
  renderShopInfo(currentShopData);
  
  // Load shop products
 // ‚úÖ NEW
loadShopProducts(currentShopData.id);

  
  // ‚úÖ NEW: Show/Hide Add Products button based on ownership
  const addProductsBtn = document.getElementById('addProductsBtn');
  const headerSpacer = document.getElementById('headerSpacer');
  
  if (window.currentUser && 
      window.currentUser.role === 'shopowner' && 
      window.currentUser.uid === currentShopData.ownerId) {
    // User owns this shop - show Add Products button
    if (addProductsBtn) {
      addProductsBtn.style.display = 'block';
    }
    if (headerSpacer) {
      headerSpacer.style.display = 'none';
    }
    console.log('‚úÖ Add Products button shown (Shop Owner)');
  } else {
    // Hide button for customers or other shopowners
    if (addProductsBtn) {
      addProductsBtn.style.display = 'none';
    }
    if (headerSpacer) {
      headerSpacer.style.display = 'block';
    }
    console.log('‚ÑπÔ∏è Add Products button hidden (Customer/Other Shopowner)');
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Update hash
  window.location.hash = '#shop-products/' + shopId;
}

/**
 * Render Shop Info Card
 */
function renderShopInfo(shop) {
  const shopInfoCard = document.getElementById('shopInfoCard');
  
  if (!shopInfoCard) return;
  
  shopInfoCard.innerHTML = `
    <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; color: white;">
      <div class="d-flex align-items-start justify-content-between">
        <div style="flex: 1;">
          <h4 style="font-weight: 700; color: white; margin-bottom: 8px;">
            <i class="bi bi-shop me-2"></i>${escapeHtml(shop.shopName)}
          </h4>
          <p style="font-size: 0.95rem; opacity: 0.95; margin-bottom: 4px;">
            <i class="bi bi-person me-2"></i>${escapeHtml(shop.ownerName)}
          </p>
          <p style="font-size: 0.9rem; opacity: 0.9; margin: 0;">
            <i class="bi bi-phone me-2"></i>${escapeHtml(shop.mobile)}
          </p>
        </div>
        <span class="badge" style="background: rgba(255,255,255,0.3); color: white; font-size: 0.85rem; padding: 6px 12px;">Active</span>
      </div>
    </div>
    <div class="card-body">
      <p style="margin: 0; color: #666;">
        <i class="bi bi-geo-alt-fill me-2" style="color: #dc3545;"></i>${escapeHtml(shop.address)}
      </p>
    </div>
  `;
}
/**
 * Load Shop Products from Firestore (SHOP-SPECIFIC)
 */
 async function loadShopProducts(shopId) {
  console.log('üîÑ Loading products for shop:', shopId);
  
  const productsGrid = document.getElementById('shopProductsGrid');
  const emptyState = document.getElementById('shopProductsEmptyState');
  
  if (!productsGrid) {
    console.error('‚ùå Products grid not found');
    return;
  }
  
  // Show loading
  productsGrid.innerHTML = `
    <div class="col-12" style="text-align: center; padding: 40px;">
      <div class="spinner-border text-success" role="status"></div>
      <p class="mt-3">Loading products...</p>
    </div>
  `;
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // ‚úÖ NEW: Load from shops/{shopId}/products instead of tenants/{ownerId}/products
    const productsRef = collection(window.db, 'shops', shopId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    allShopProducts = [];
    productsSnap.forEach((doc) => {
      allShopProducts.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${allShopProducts.length} products for shop: ${shopId}`);
    
    // Render products
    renderShopProducts(allShopProducts);
    
  } catch (error) {
    console.error('‚ùå Error loading shop products:', error);
    
    productsGrid.innerHTML = `
      <div class="col-12">
        <div class="alert alert-danger" style="border-radius: 12px;">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Error loading products:</strong> ${error.message}
        </div>
      </div>
    `;
  }
}
/**
 * Render Shop Products (WITH CART + EDIT INTEGRATION)
 */
 function renderShopProducts(products) {
  const productsGrid = document.getElementById('shopProductsGrid');
  const emptyState = document.getElementById('shopProductsEmptyState');
  
  if (!productsGrid) return;
  
  // Clear grid
  productsGrid.innerHTML = '';
  
  if (products.length === 0) {
    productsGrid.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  productsGrid.style.display = 'flex';
  if (emptyState) emptyState.style.display = 'none';
  
  // ‚úÖ Check if current user is shop owner
  const isOwner = window.currentUser && 
                  window.currentUser.role === 'shopowner' && 
                  currentShopData && 
                  window.currentUser.uid === currentShopData.ownerId;
  
  // Render each product
  products.forEach(product => {
    // Check if product is in cart
    const cartItem = getCartItem(product.id);
    const inCart = !!cartItem;
    const quantity = cartItem ? cartItem.quantity : 0;
    const stock = product.stock || 0;
    const price = product.price || 0;
    
    // Prepare product data for addToCart
    const productData = {
      id: product.id,
      name: product.name || 'Unnamed Product',
      price: price,
      stock: stock,
      brand: product.brand || '',
      size: product.size || '',
      category: product.category || '',
      shopId: product.shopId || currentShopData?.id,
      shopName: product.shopName || currentShopData?.shopName,
      ownerId: product.ownerId || currentShopData?.ownerId
    };
    
    const productCard = `
      <div class="col-md-4 col-sm-6 col-12">
        <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
          
          ${isOwner ? `
            <!-- ‚úÖ EDIT BUTTON (SHOPOWNERS ONLY) -->
            <button 
              onclick="openEditProductModal('${product.id}')" 
              style="
                position: absolute; 
                top: 10px; 
                right: 10px; 
                background: rgba(25, 118, 210, 0.95); 
                color: white; 
                border: none; 
                border-radius: 50%; 
                width: 36px; 
                height: 36px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                cursor: pointer; 
                z-index: 10;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              "
              onmouseover="this.style.background='rgba(21, 101, 192, 0.95)'; this.style.transform='scale(1.1)'"
              onmouseout="this.style.background='rgba(25, 118, 210, 0.95)'; this.style.transform='scale(1)'"
              title="Edit Product">
              <i class="bi bi-pencil-fill"></i>
            </button>
          ` : ''}
          
          <!-- Product Image/Icon -->
          <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-box-seam" style="font-size: 3rem; color: #1976d2;"></i>
          </div>
          
          <!-- Product Body -->
          <div class="card-body">
            <h6 class="mb-2" style="font-weight: 600; color: #333; min-height: 40px;">
              ${escapeHtml(product.name || 'Unnamed Product')}
            </h6>
            
            <div class="mb-2">
              ${product.brand ? `<span class="badge" style="background: #e3f2fd; color: #1976d2; font-size: 0.75rem; margin-right: 5px;">${escapeHtml(product.brand)}</span>` : ''}
              ${product.size ? `<span class="badge" style="background: #f3e5f5; color: #7b1fa2; font-size: 0.75rem;">${escapeHtml(product.size)}</span>` : ''}
              ${product.category ? `<span class="badge" style="background: #fff3e0; color: #e65100; font-size: 0.75rem; margin-left: 5px;">${escapeHtml(product.category)}</span>` : ''}
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span style="font-size: 1.2rem; font-weight: 700; color: #25D366;">
                ${price > 0 ? `‚Çπ${formatPrice(price)}` : '<span style="color: #999; font-size: 0.9rem;">Price TBD</span>'}
              </span>
              <span class="text-muted" style="font-size: 0.85rem;">
                ${stock > 0 ? `Stock: ${stock}` : '<span style="color: #dc3545;">Out of Stock</span>'}
              </span>
            </div>
            
            ${!isOwner ? `
              <!-- ‚úÖ CART BUTTON / QUANTITY STEPPER (CUSTOMERS ONLY) -->
              <div id="cartBtn_${product.id}">
                ${inCart ? `
                  <!-- Quantity Stepper -->
                  <div class="quantity-stepper w-100" style="justify-content: space-between; padding: 10px 15px;">
                    <button 
                      onclick="event.stopPropagation(); updateCartQuantity('${product.id}', -1);" 
                      ${quantity <= 1 ? 'disabled' : ''}
                      title="${quantity <= 1 ? 'Remove from cart' : 'Decrease quantity'}">
                      <i class="bi bi-${quantity <= 1 ? 'trash' : 'dash'}"></i>
                    </button>
                    <span style="font-size: 1.1rem; font-weight: 600;">${quantity}</span>
                    <button 
                      onclick="event.stopPropagation(); updateCartQuantity('${product.id}', 1);" 
                      ${quantity >= stock ? 'disabled' : ''}
                      title="${quantity >= stock ? 'Stock limit reached' : 'Increase quantity'}">
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                  ${quantity >= stock ? '<p class="text-warning text-center mb-0 mt-2" style="font-size: 0.75rem;"><i class="bi bi-exclamation-triangle"></i> Max stock reached</p>' : ''}
                ` : `
                  <!-- Add to Cart Button -->
                  <button 
                    class="btn btn-sm w-100 btn-add-to-cart" 
                    style="background: ${stock > 0 ? '#25D366' : '#ccc'}; color: white; border: none; border-radius: 8px; padding: 10px; font-weight: 600; transition: all 0.2s;" 
                    onclick="event.stopPropagation(); addToCart(${JSON.stringify(productData).replace(/"/g, '&quot;')});"
                    ${stock <= 0 ? 'disabled' : ''}
                    onmouseover="if(this.style.background === 'rgb(37, 211, 102)') this.style.background='#128C7E'"
                    onmouseout="if(!this.disabled) this.style.background='#25D366'">
                    <i class="bi bi-cart-plus me-1"></i>${stock > 0 ? 'Add to Cart' : 'Out of Stock'}
                  </button>
                `}
              </div>
            ` : `
              <!-- ‚úÖ SHOPOWNER INFO (NO CART BUTTONS) -->
              <div class="alert alert-info mb-0" style="border-radius: 8px; padding: 8px; font-size: 0.85rem;">
                <i class="bi bi-info-circle me-1"></i> Click <strong>Edit</strong> to manage this product
              </div>
            `}
            
          </div>
          
        </div>
      </div>
    `;
    
    productsGrid.insertAdjacentHTML('beforeend', productCard);
  });
  
  console.log(`‚úÖ Rendered ${products.length} products (Owner: ${isOwner})`);
}


/**
 * Filter Shop Products
 */
function filterShopProducts(searchTerm) {
  const term = searchTerm.toLowerCase().trim();
  
  if (!term) {
    renderShopProducts(allShopProducts);
    return;
  }
  
  const filtered = allShopProducts.filter(product => {
    const name = (product.name || '').toLowerCase();
    const brand = (product.brand || '').toLowerCase();
    const size = (product.size || '').toLowerCase();
    
    return name.includes(term) || brand.includes(term) || size.includes(term);
  });
  
  renderShopProducts(filtered);
}

/**
 * Go Back to Home
 */
function goBackHome() {
  console.log('üè† Going back to home');
  
  // Hide shop products page
  const shopProductsPage = document.getElementById('shopProductsPage');
  if (shopProductsPage) {
    shopProductsPage.style.display = 'none';
    shopProductsPage.classList.remove('active');
  }
  
  // Show main app and navbar
  const mainApp = document.getElementById('mainApp');
  const mainNavbar = document.getElementById('mainNavbar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  
  if (mainApp) {
    mainApp.style.display = 'block';
  }
  
  if (mainNavbar) {
    mainNavbar.style.display = 'flex';
  }
  
  if (sidebarToggleBtn) {
    sidebarToggleBtn.style.display = 'block';
  }
  
  // Clear search
  const searchInput = document.getElementById('searchShopProductsInput');
  if (searchInput) {
    searchInput.value = '';
  }
  
  // Reset current shop data
  currentShopData = null;
  allShopProducts = [];
  
  // Update hash
  window.location.hash = '#home';
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Format Price
 */
function formatPrice(price) {
  return Number(price || 0).toLocaleString('en-IN', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}

/**
 * Add to Cart (Placeholder)
 */
function addToCart(productId) {
  console.log('üõí Add to cart:', productId);
  alert('üõí Add to Cart feature coming soon!\n\nProduct ID: ' + productId);
}

/**
 * ==========================================
 * ADD PRODUCTS FUNCTIONALITY (SHOPOWNERS ONLY)
 * ==========================================
 */

// Global variables
let pendingProducts = [];

/**
 * Open Add Products Modal
 */
function openAddProductsModal() {
  console.log('‚ûï Opening Add Products modal');
  
  // Check if user is shopowner and owns this shop
  if (!window.currentUser || window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can add products.');
    return;
  }
  
  if (!currentShopData || currentShopData.ownerId !== window.currentUser.uid) {
    alert('‚ö†Ô∏è You can only add products to your own shop.');
    return;
  }
  
  // Reset pending products
  pendingProducts = [];
  
  // Clear input
  document.querySelectorAll('#productInput').forEach(inp => {
    inp.value = '';
    inp.setAttribute('value', '');
    window.lastProductInput = '';
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
  
  // Update preview
  updateProductsPreviewList();
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('addProductsModal'));
  modal.show();
  
  // Focus on input
  setTimeout(() => {
    const input = document.getElementById('productInput');
    if (input) input.focus();
  }, 200);
}

/**
 * Handle Product Input Keydown (Enter or Comma)
 */
function handleProductInputKeydown(event) {
  const input = document.getElementById('productInput');
  if (!input) return;
  
  // Check if Enter or Comma key
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    let value = window.lastProductInput || input.value;
    value = value.trim();
    
    // Remove trailing comma if present
    if (value.endsWith(',')) {
      value = value.slice(0, -1).trim();
    }
    
    if (value && value.length > 0) {
      // Check if already in pending list
      if (pendingProducts.includes(value)) {
        alert('‚ö†Ô∏è This product is already in the list!');
      } else {
        // Add to pending products
        pendingProducts.push(value);
        console.log('‚úÖ Product added to preview:', value);
        
        // Update preview
        updateProductsPreviewList();
      }
    }
    
    // Clear input
    forceClearProductInput();
  }
}

/**
 * Add Product to List (Button Click)
 */
function addProductToList() {
  const input = document.getElementById('productInput');
  if (!input) return;
  
  let value = window.lastProductInput || input.value;
  value = value.trim();
  
  if (!value || value.length === 0) {
    alert('‚ö†Ô∏è Please enter a product name');
    return;
  }
  
  // Check for duplicates
  if (pendingProducts.includes(value)) {
    alert('‚ö†Ô∏è This product is already in the list!');
    return;
  }
  
  // Add to pending list
  pendingProducts.push(value);
  console.log('‚úÖ Product added to preview:', value);
  
  // Update preview
  updateProductsPreviewList();
  
  // Clear input
  forceClearProductInput();
  
  // Focus back
  setTimeout(() => {
    if (input) input.focus();
  }, 50);
}

/**
 * Force Clear Product Input
 */
function forceClearProductInput() {
  document.querySelectorAll('#productInput').forEach(inp => {
    inp.value = '';
    inp.setAttribute('value', '');
    window.lastProductInput = '';
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
  console.log('üßπ Product input cleared');
}

/**
 * Update Products Preview List
 */
function updateProductsPreviewList() {
  const previewList = document.getElementById('productsPreviewList');
  const previewCount = document.getElementById('productsPreviewCount');
  
  if (!previewList) {
    console.error('‚ùå productsPreviewList not found');
    return;
  }
  
  if (previewCount) {
    previewCount.textContent = `üìù Products to Save (${pendingProducts.length}):`;
  }
  
  if (pendingProducts.length === 0) {
    previewList.innerHTML = `
      <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
        No products added yet
      </div>
    `;
    return;
  }
  
  let html = '';
  pendingProducts.forEach((product, index) => {
    html += `
      <div style="
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 12px; border-bottom: 1px solid #e0e0e0;
        background: white; transition: background 0.2s;
      " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
        
        <span style="font-size: 14px; color: #333; flex: 1;">
          <strong style="color: #007bff;">${index + 1}.</strong> 
          <span style="margin-left: 8px;">${escapeHtml(product)}</span>
        </span>
        
        <button onclick="removePendingProduct(${index})" style="
          background: #dc3545; color: white; border: none; 
          padding: 5px 10px; border-radius: 5px; cursor: pointer;
          font-size: 12px; font-weight: 600; transition: background 0.2s;
        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
  console.log(`üìã Updated preview: ${pendingProducts.length} products`);
}

/**
 * Remove Pending Product
 */
function removePendingProduct(index) {
  if (index < 0 || index >= pendingProducts.length) return;
  
  const removed = pendingProducts.splice(index, 1);
  console.log('üóëÔ∏è Removed product:', removed[0]);
  updateProductsPreviewList();
}
/**
 * Save All Products to Firebase (SHOP-SPECIFIC)
 */
 async function saveAllProducts() {
  if (pendingProducts.length === 0) {
    alert('‚ö†Ô∏è Please add at least one product');
    return;
  }
  
  if (!currentShopData || !currentShopData.id) {
    alert('‚ùå Shop data not found');
    return;
  }
  
  console.log('üíæ Saving', pendingProducts.length, 'products to shop:', currentShopData.shopName);
  
  try {
    showSyncIndicator('Saving products...', null);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // ‚úÖ NEW: Save to shops/{shopId}/products instead of tenants/{ownerId}/products
    const productsRef = collection(window.db, 'shops', currentShopData.id, 'products');
    
    const productsToSave = [...pendingProducts];
    
    // Save each product
    const savePromises = productsToSave.map(async (productName) => {
      try {
        await addDoc(productsRef, {
          name: productName,
          price: 0,
          stock: 0,
          brand: '',
          size: '',
          category: '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          shopId: currentShopData.id,
          shopName: currentShopData.shopName,
          ownerId: currentShopData.ownerId,
          ownerName: currentShopData.ownerName
        });
        console.log('‚úÖ Firebase: Product saved to shop:', productName);
        return { success: true, product: productName };
      } catch (error) {
        console.error('‚ùå Firebase: Failed to save product:', productName, error);
        return { success: false, product: productName, error };
      }
    });
    
    const results = await Promise.all(savePromises);
    const failed = results.filter(r => !r.success);
    
    // Clear input
    document.querySelectorAll('#productInput').forEach(inp => {
      inp.value = '';
      inp.setAttribute('value', '');
      window.lastProductInput = '';
      inp.dispatchEvent(new Event('input', { bubbles: true }));
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addProductsModal'));
    if (modal) modal.hide();
    
    // Clear pending
    pendingProducts = [];
    
    // Reload products
    await loadShopProducts(currentShopData.id);
    
    showSyncIndicator('Products saved!', 2000);
    
    if (failed.length > 0) {
      alert(`‚ö†Ô∏è Warning: ${failed.length} product(s) failed to save.\n\n${productsToSave.length - failed.length} products saved successfully.`);
    } else {
      alert(`‚úÖ Success!\n\n${productsToSave.length} product(s) added to ${currentShopData.shopName}!`);
    }
    
  } catch (error) {
    console.error('‚ùå Error saving products:', error);
    showSyncIndicator('Save failed', 1500);
    alert('‚ùå Error saving products: ' + error.message);
  }
}


/**
 * ==========================================
 * CART MANAGEMENT SYSTEM
 * ==========================================
 */

// Global cart state
let cart = {
  items: [],
  shopId: null,
  shopName: null,
  shopOwnerId: null
};

// Pending item for shop conflict resolution
let pendingCartItem = null;

/**
 * Initialize Cart from Storage
 */
function initializeCart() {
  try {
    const savedCart = localStorage.getItem('ue2shop_cart');
    if (savedCart) {
      cart = JSON.parse(savedCart);
      console.log('‚úÖ Cart loaded from storage:', cart);
      updateMiniCart();
    }
  } catch (error) {
    console.error('‚ùå Error loading cart:', error);
    cart = { items: [], shopId: null, shopName: null, shopOwnerId: null };
  }
}

/**
 * Save Cart to Storage
 */
function saveCart() {
  try {
    localStorage.setItem('ue2shop_cart', JSON.stringify(cart));
    console.log('üíæ Cart saved to storage');
  } catch (error) {
    console.error('‚ùå Error saving cart:', error);
  }
}

/**
 * Add Product to Cart
 */
function addToCart(product) {
  console.log('üõí Add to cart:', product);
  
  // Check if customer
  if (!window.currentUser || window.currentUser.role !== 'customer') {
    alert('‚ö†Ô∏è Only customers can add items to cart. Please sign in as a customer.');
    return;
  }
  
  // Check stock
  if (product.stock <= 0) {
    alert('‚ùå This product is out of stock!');
    return;
  }
  
  // Check shop conflict
  if (cart.shopId && cart.shopId !== product.shopId) {
    // Different shop - show conflict modal
    pendingCartItem = product;
    showShopConflictModal(cart.shopName, product.shopName);
    return;
  }
  
  // Set shop info if first item
  if (!cart.shopId) {
    cart.shopId = product.shopId;
    cart.shopName = product.shopName;
    cart.shopOwnerId = product.ownerId;
  }
  
  // Check if product already in cart
  const existingItem = cart.items.find(item => item.id === product.id);
  
  if (existingItem) {
    // Increase quantity
    if (existingItem.quantity < product.stock) {
      existingItem.quantity++;
      console.log('‚úÖ Increased quantity:', existingItem.quantity);
    } else {
      alert('‚ö†Ô∏è Cannot add more. Stock limit reached!');
      return;
    }
  } else {
    // Add new item
    cart.items.push({
      id: product.id,
      name: product.name,
      price: product.price || 0,
      stock: product.stock,
      quantity: 1,
      brand: product.brand || '',
      size: product.size || '',
      shopId: product.shopId,
      shopName: product.shopName,
      ownerId: product.ownerId
    });
    console.log('‚úÖ Added new item to cart');
  }
  
  // Save and update UI
  saveCart();
  updateMiniCart();
  updateCartPage();
  renderShopProducts(allShopProducts); // Re-render to show stepper
  
  // Show success animation
  showMiniCartBriefly();
}
/**
 * Update Item Quantity in Cart
 */
 function updateCartQuantity(productId, change) {
  const item = cart.items.find(i => i.id === productId);
  
  if (!item) {
    console.warn('‚ö†Ô∏è Item not found in cart:', productId);
    return;
  }
  
  const newQuantity = item.quantity + change;
  
  // ‚úÖ Remove item if quantity becomes 0 or negative
  if (newQuantity <= 0) {
    console.log('üóëÔ∏è Quantity reached 0, removing item');
    removeFromCart(productId);
    return;
  }
  
  // Check stock limit
  if (newQuantity > item.stock) {
    alert('‚ö†Ô∏è Cannot add more. Stock limit reached!');
    return;
  }
  
  // Update quantity
  item.quantity = newQuantity;
  console.log(`‚úÖ Updated quantity: ${item.name} = ${item.quantity}`);
  
  saveCart();
  updateMiniCart(); // ‚úÖ Will hide if cart becomes empty
  updateCartPage();
  
  // Update product page
  if (typeof allShopProducts !== 'undefined' && allShopProducts) {
    renderShopProducts(allShopProducts);
  }
}

/**
 * Remove Item from Cart
 */
 function removeFromCart(productId) {
  const itemIndex = cart.items.findIndex(i => i.id === productId);
  
  if (itemIndex === -1) return;
  
  const item = cart.items[itemIndex];
  console.log('üóëÔ∏è Removing from cart:', item.name);
  
  cart.items.splice(itemIndex, 1);
  
  // Clear shop info if cart is empty
  if (cart.items.length === 0) {
    cart.shopId = null;
    cart.shopName = null;
    cart.shopOwnerId = null;
    console.log('üßπ Cart cleared - no more items');
  }
  
  saveCart();
  updateMiniCart(); // ‚úÖ This will hide mini-cart if empty
  updateCartPage();
  
  // Update product page if available
  if (typeof allShopProducts !== 'undefined' && allShopProducts) {
    renderShopProducts(allShopProducts);
  }
}
/**
 * Clear Entire Cart
 */
 function clearCart() {
  console.log('üóëÔ∏è Clearing entire cart');
  
  cart = { 
    items: [], 
    shopId: null, 
    shopName: null, 
    shopOwnerId: null 
  };
  
  saveCart();
  updateMiniCart(); // ‚úÖ This will hide mini-cart
  updateCartPage();
  
  // Update product page if available
  if (typeof renderShopProducts === 'function' && typeof allShopProducts !== 'undefined' && allShopProducts) {
    renderShopProducts(allShopProducts);
  }
  
  // ‚úÖ Force hide mini-cart
  const miniCartFooter = document.getElementById('miniCartFooter');
  if (miniCartFooter) {
    miniCartFooter.style.display = 'none';
    miniCartFooter.classList.remove('show');
  }
  
  console.log('‚úÖ Cart cleared successfully');
}

/**
 * Update Mini-Cart Footer
 */
 function updateMiniCart() {
  const miniCartFooter = document.getElementById('miniCartFooter');
  const miniCartCount = document.getElementById('miniCartCount');
  const miniCartPreview = document.getElementById('miniCartPreview');
  const miniCartTotal = document.getElementById('miniCartTotal');
  
  if (!miniCartFooter) return;
  
  const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
  const totalAmount = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  // ‚úÖ FIXED: Hide mini-cart when empty
  if (totalItems === 0 || cart.items.length === 0) {
    miniCartFooter.style.display = 'none';
    miniCartFooter.classList.remove('show');
    console.log('üö´ Mini-cart hidden (0 items)');
    return;
  }
  
  // Show mini-cart
  miniCartFooter.style.display = 'block';
  miniCartFooter.classList.add('show');
  
  // Update count
  if (miniCartCount) {
    miniCartCount.textContent = totalItems;
  }
  
  // Update preview (first 2 items)
  if (miniCartPreview) {
    const preview = cart.items.slice(0, 2).map(item => item.name).join(', ');
    const remaining = cart.items.length > 2 ? ` +${cart.items.length - 2} more` : '';
    miniCartPreview.textContent = preview + remaining;
  }
  
  // Update total
  if (miniCartTotal) {
    miniCartTotal.textContent = `‚Çπ${totalAmount.toFixed(2)}`;
  }
  
  console.log('‚úÖ Mini-cart updated:', totalItems, 'items, ‚Çπ', totalAmount);
}

/**
 * Show Mini-Cart Briefly (After Add)
 */
function showMiniCartBriefly() {
  const miniCartFooter = document.getElementById('miniCartFooter');
  if (!miniCartFooter) return;
  
  miniCartFooter.style.transform = 'translateY(0)';
  miniCartFooter.style.animation = 'pulse 0.3s ease';
  
  setTimeout(() => {
    miniCartFooter.style.animation = '';
  }, 300);
}

/**
 * Navigate to Cart Page
 */
function navigateToCart() {
  console.log('üõí Navigating to Cart Page');
  
  if (cart.items.length === 0) {
    alert('‚ö†Ô∏è Your cart is empty!');
    return;
  }
  
  // Hide all pages
  const mainApp = document.getElementById('mainApp');
  const shopProductsPage = document.getElementById('shopProductsPage');
  const cartPage = document.getElementById('cartPage');
  
  if (mainApp) mainApp.style.display = 'none';
  if (shopProductsPage) shopProductsPage.style.display = 'none';
  
  // Show cart page
  if (cartPage) {
    cartPage.style.display = 'block';
    cartPage.classList.add('active');
  }
  
  // Update cart page
  updateCartPage();
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  window.location.hash = '#cart';
}
/**
 * Update Cart Page
 */
 function updateCartPage() {
  const cartItemsList = document.getElementById('cartItemsList');
  const emptyCartState = document.getElementById('emptyCartState');
  const cartSummary = document.getElementById('cartSummary');
  const cartShopInfo = document.getElementById('cartShopInfo');
  
  if (!cartItemsList) return;
  
  // ‚úÖ Check if cart is empty
  if (!cart.items || cart.items.length === 0) {
    // Show empty state
    cartItemsList.innerHTML = '';
    if (emptyCartState) emptyCartState.style.display = 'block';
    if (cartSummary) cartSummary.style.display = 'none';
    if (cartShopInfo) cartShopInfo.style.display = 'none';
    
    // ‚úÖ Force hide mini-cart
    const miniCartFooter = document.getElementById('miniCartFooter');
    if (miniCartFooter) {
      miniCartFooter.style.display = 'none';
      miniCartFooter.classList.remove('show');
    }
    
    console.log('üìã Cart page: Empty state shown');
    return;
  }
  
  // Hide empty state
  if (emptyCartState) emptyCartState.style.display = 'none';
  if (cartSummary) cartSummary.style.display = 'block';
  if (cartShopInfo) cartShopInfo.style.display = 'block';
  
  // Render shop info
  if (cartShopInfo && cart.shopName) {
    cartShopInfo.innerHTML = `
      <div class="card-body">
        <h5 style="font-weight: 700; margin-bottom: 10px;">
          <i class="bi bi-shop"></i> ${escapeHtml(cart.shopName)}
        </h5>
        <p class="text-muted mb-0" style="font-size: 0.9rem;">
          <i class="bi bi-info-circle"></i> All items are from this shop
        </p>
      </div>
    `;
  }
  
  // Render cart items
  let html = '';
  cart.items.forEach(item => {
    html += `
      <div class="cart-item-card">
        <div style="display: flex; align-items: start; gap: 15px;">
          
          <!-- Product Image Placeholder -->
          <div style="
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
          ">
            <i class="bi bi-box-seam" style="font-size: 2rem; color: #1976d2;"></i>
          </div>
          
          <!-- Product Details -->
          <div style="flex: 1;">
            <h6 style="font-weight: 600; margin-bottom: 5px;">${escapeHtml(item.name)}</h6>
            ${item.brand ? `<p class="text-muted mb-1" style="font-size: 0.85rem;">Brand: ${escapeHtml(item.brand)}</p>` : ''}
            ${item.size ? `<p class="text-muted mb-1" style="font-size: 0.85rem;">Size: ${escapeHtml(item.size)}</p>` : ''}
            <p style="font-weight: 700; font-size: 1.1rem; color: #25D366; margin-bottom: 10px;">‚Çπ${item.price.toFixed(2)}</p>
            
            <!-- Quantity Stepper -->
            <div class="quantity-stepper">
              <button onclick="updateCartQuantity('${item.id}', -1)" ${item.quantity <= 1 ? 'disabled' : ''}>
                <i class="bi bi-dash"></i>
              </button>
              <span>${item.quantity}</span>
              <button onclick="updateCartQuantity('${item.id}', 1)" ${item.quantity >= item.stock ? 'disabled' : ''}>
                <i class="bi bi-plus"></i>
              </button>
            </div>
            
            ${item.quantity >= item.stock ? '<p class="text-warning mt-2 mb-0" style="font-size: 0.85rem;"><i class="bi bi-exclamation-triangle"></i> Stock limit reached</p>' : ''}
          </div>
          
          <!-- Remove Button -->
          <button 
            class="btn btn-sm btn-outline-danger" 
            onclick="removeFromCart('${item.id}')"
            title="Remove">
            <i class="bi bi-trash"></i>
          </button>
          
        </div>
      </div>
    `;
  });
  
  cartItemsList.innerHTML = html;
  
  // Update summary
  const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
  const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  const summaryItemCount = document.getElementById('summaryItemCount');
  const summarySubtotal = document.getElementById('summarySubtotal');
  const summaryTotal = document.getElementById('summaryTotal');
  
  if (summaryItemCount) summaryItemCount.textContent = totalItems;
  if (summarySubtotal) summarySubtotal.textContent = `‚Çπ${subtotal.toFixed(2)}`;
  if (summaryTotal) summaryTotal.textContent = `‚Çπ${subtotal.toFixed(2)}`;
  
  console.log('‚úÖ Cart page updated:', totalItems, 'items');
}


/**
 * Force Hide Mini-Cart (Utility Function)
 */
 function hideMiniCart() {
  const miniCartFooter = document.getElementById('miniCartFooter');
  if (miniCartFooter) {
    miniCartFooter.style.display = 'none';
    miniCartFooter.classList.remove('show');
    miniCartFooter.style.transform = 'translateY(100%)';
    console.log('üö´ Mini-cart forcibly hidden');
  }
}

// Make global
window.hideMiniCart = hideMiniCart;


/**
 * Go Back from Cart
 */
function goBackFromCart() {
  const cartPage = document.getElementById('cartPage');
  if (cartPage) {
    cartPage.style.display = 'none';
    cartPage.classList.remove('active');
  }
  
  // Check if coming from shop products page
  if (window.location.hash.includes('shop-products')) {
    const shopProductsPage = document.getElementById('shopProductsPage');
    if (shopProductsPage) {
      shopProductsPage.style.display = 'block';
      shopProductsPage.classList.add('active');
    }
  } else {
    goBackHome();
  }
}

/**
 * Show Shop Conflict Modal
 */
function showShopConflictModal(currentShop, newShop) {
  document.getElementById('currentShopName').textContent = currentShop;
  document.getElementById('newShopName').textContent = newShop;
  
  const modal = new bootstrap.Modal(document.getElementById('shopConflictModal'));
  modal.show();
}

/**
 * Close Shop Conflict Modal
 */
function closeShopConflictModal() {
  const modal = bootstrap.Modal.getInstance(document.getElementById('shopConflictModal'));
  if (modal) modal.hide();
  pendingCartItem = null;
}
/**
 * Confirm Replace Cart
 */
 function confirmReplaceCart() {
  console.log('üîÑ Replacing cart with new shop items');
  
  // ‚úÖ Hide mini-cart before clearing
  hideMiniCart();
  
  // Clear current cart
  clearCart();
  
  // Add pending item
  if (pendingCartItem) {
    addToCart(pendingCartItem);
    pendingCartItem = null;
  }
  
  // Close modal
  closeShopConflictModal();
}



/**
 * Get Cart Item by Product ID
 */
function getCartItem(productId) {
  return cart.items.find(item => item.id === productId);
}

/**
 * Check if Product is in Cart
 */
function isInCart(productId) {
  return cart.items.some(item => item.id === productId);
}

// Initialize cart on page load
document.addEventListener('DOMContentLoaded', function() {
  initializeCart();
  console.log('‚úÖ Cart system initialized');
});



/**
 * ==========================================
 * EDIT PRODUCT FUNCTIONALITY (SHOPOWNERS ONLY)
 * ==========================================
 */

// Store current editing product
let currentEditingProduct = null;

/**
 * Open Edit Product Modal
 */
function openEditProductModal(productId) {
  console.log('‚úèÔ∏è Opening edit modal for product:', productId);
  
  // Check if user is shop owner
  if (!window.currentUser || window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can edit products.');
    return;
  }
  
  if (!currentShopData || currentShopData.ownerId !== window.currentUser.uid) {
    alert('‚ö†Ô∏è You can only edit products in your own shop.');
    return;
  }
  
  // Find product in allShopProducts
  const product = allShopProducts.find(p => p.id === productId);
  
  if (!product) {
    alert('‚ùå Product not found!');
    return;
  }
  
  // Store current editing product
  currentEditingProduct = { ...product };
  
  // Populate form fields
  document.getElementById('editProductId').value = product.id;
  document.getElementById('editProductName').value = product.name || '';
  document.getElementById('editProductPrice').value = product.price || 0;
  document.getElementById('editProductStock').value = product.stock || 0;
  document.getElementById('editProductBrand').value = product.brand || '';
  document.getElementById('editProductSize').value = product.size || '';
  document.getElementById('editProductCategory').value = product.category || '';
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
  modal.show();
  
  // Focus on name field
  setTimeout(() => {
    document.getElementById('editProductName').focus();
  }, 200);
}

/**
 * Adjust Stock in Edit Modal
 */
function adjustEditStock(change) {
  const stockInput = document.getElementById('editProductStock');
  if (!stockInput) return;
  
  let currentStock = parseInt(stockInput.value) || 0;
  let newStock = currentStock + change;
  
  // Prevent negative stock
  if (newStock < 0) newStock = 0;
  
  stockInput.value = newStock;
  console.log(`üì¶ Stock adjusted: ${currentStock} ‚Üí ${newStock}`);
}

/**
 * Save Edited Product
 */
async function saveEditedProduct() {
  console.log('üíæ Saving edited product...');
  
  // Get form values
  const productId = document.getElementById('editProductId').value;
  const name = document.getElementById('editProductName').value.trim();
  const price = parseFloat(document.getElementById('editProductPrice').value) || 0;
  const stock = parseInt(document.getElementById('editProductStock').value) || 0;
  const brand = document.getElementById('editProductBrand').value.trim();
  const size = document.getElementById('editProductSize').value.trim();
  const category = document.getElementById('editProductCategory').value.trim();
  
  // Validate
  if (!name || name.length === 0) {
    alert('‚ö†Ô∏è Please enter a product name!');
    document.getElementById('editProductName').focus();
    return;
  }
  
  if (price < 0) {
    alert('‚ö†Ô∏è Price cannot be negative!');
    document.getElementById('editProductPrice').focus();
    return;
  }
  
  if (stock < 0) {
    alert('‚ö†Ô∏è Stock cannot be negative!');
    document.getElementById('editProductStock').focus();
    return;
  }
  
  try {
    showSyncIndicator('Saving changes...', null);
    
    const { doc, updateDoc } = window.firebaseImports;
    
    // Prepare update data
    const updateData = {
      name: name,
      price: price,
      stock: stock,
      brand: brand,
      size: size,
      category: category,
      updatedAt: new Date().toISOString()
    };
    
    // Update in Firebase
    const productRef = doc(window.db, 'shops', currentShopData.id, 'products', productId);
    await updateDoc(productRef, updateData);
    
    console.log('‚úÖ Product updated in Firebase:', updateData);
    
    // Update local cache
    const productIndex = allShopProducts.findIndex(p => p.id === productId);
    if (productIndex !== -1) {
      allShopProducts[productIndex] = {
        ...allShopProducts[productIndex],
        ...updateData
      };
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
    if (modal) modal.hide();
    
    // Re-render products
    renderShopProducts(allShopProducts);
    
    showSyncIndicator('Changes saved!', 2000);
    
    // Show success message
    alert(`‚úÖ Product updated successfully!\n\nName: ${name}\nPrice: ‚Çπ${price}\nStock: ${stock}`);
    
    currentEditingProduct = null;
    
  } catch (error) {
    console.error('‚ùå Error saving product:', error);
    showSyncIndicator('Save failed', 1500);
    alert('‚ùå Error saving product: ' + error.message);
  }
}


/**
 * ==========================================
 * CHECKOUT SYSTEM
 * ==========================================
 */

 let currentCheckoutStep = 1;

/**
 * Proceed to Checkout
 */
function proceedToCheckout() {
  console.log('üõí Proceeding to checkout');
  
  if (!window.currentUser || window.currentUser.role !== 'customer') {
    alert('‚ö†Ô∏è Only customers can place orders. Please sign in as a customer.');
    return;
  }
  
  if (cart.items.length === 0) {
    alert('‚ö†Ô∏è Your cart is empty!');
    return;
  }
  
  // Reset checkout step
  currentCheckoutStep = 1;
  
  // Pre-fill user details if available
  if (window.currentUser) {
    document.getElementById('checkoutName').value = window.currentUser.displayName || '';
    document.getElementById('checkoutPhone').value = window.currentUser.phoneNumber || window.currentUser.mobile || '';
  }
  
  // Show checkout modal
  const modal = new bootstrap.Modal(document.getElementById('checkoutModal'));
  modal.show();
  
  // Update UI
  updateCheckoutUI();
}

/**
 * Update Checkout UI
 */
function updateCheckoutUI() {
  // Update step circles
  document.getElementById('step1Circle').className = currentCheckoutStep >= 1 ? 'step-circle active' : 'step-circle';
  document.getElementById('step2Circle').className = currentCheckoutStep >= 2 ? 'step-circle active' : 'step-circle';
  document.getElementById('step3Circle').className = currentCheckoutStep >= 3 ? 'step-circle active' : 'step-circle';
  
  // Update step lines
  document.getElementById('step1Line').style.background = currentCheckoutStep >= 2 ? '#25D366' : '#e0e0e0';
  document.getElementById('step2Line').style.background = currentCheckoutStep >= 3 ? '#25D366' : '#e0e0e0';
  
  // Show/hide steps
  document.getElementById('checkoutStep1').style.display = currentCheckoutStep === 1 ? 'block' : 'none';
  document.getElementById('checkoutStep2').style.display = currentCheckoutStep === 2 ? 'block' : 'none';
  document.getElementById('checkoutStep3').style.display = currentCheckoutStep === 3 ? 'block' : 'none';
  
  // Show/hide buttons
  document.getElementById('checkoutBackBtn').style.display = currentCheckoutStep === 2 ? 'inline-block' : 'none';
  document.getElementById('checkoutCancelBtn').style.display = currentCheckoutStep === 3 ? 'none' : 'inline-block';
  document.getElementById('checkoutNextBtn').style.display = currentCheckoutStep === 1 ? 'inline-block' : 'none';
  document.getElementById('checkoutConfirmBtn').style.display = currentCheckoutStep === 2 ? 'inline-block' : 'none';
  document.getElementById('checkoutDoneBtn').style.display = currentCheckoutStep === 3 ? 'inline-block' : 'none';
  
  // Populate step 2 if needed
  if (currentCheckoutStep === 2) {
    populateOrderSummary();
  }
}

/**
 * Checkout Next
 */
function checkoutNext() {
  if (currentCheckoutStep === 1) {
    // Validate delivery details
    const name = document.getElementById('checkoutName').value.trim();
    const phone = document.getElementById('checkoutPhone').value.trim();
    const address = document.getElementById('checkoutAddress').value.trim();
    
    if (!name || name.length === 0) {
      alert('‚ö†Ô∏è Please enter your full name!');
      document.getElementById('checkoutName').focus();
      return;
    }
    
    if (!phone || phone.length !== 10 || !/^[0-9]{10}$/.test(phone)) {
      alert('‚ö†Ô∏è Please enter a valid 10-digit phone number!');
      document.getElementById('checkoutPhone').focus();
      return;
    }
    
    if (!address || address.length === 0) {
      alert('‚ö†Ô∏è Please enter your house/flat number!');
      document.getElementById('checkoutAddress').focus();
      return;
    }
    
    // Move to step 2
    currentCheckoutStep = 2;
    updateCheckoutUI();
  }
}

/**
 * Checkout Back
 */
function checkoutBack() {
  if (currentCheckoutStep > 1) {
    currentCheckoutStep--;
    updateCheckoutUI();
  }
}

/**
 * Populate Order Summary
 */
function populateOrderSummary() {
  // Delivery address
  const name = document.getElementById('checkoutName').value;
  const phone = document.getElementById('checkoutPhone').value;
  const address = document.getElementById('checkoutAddress').value;
  const area = document.getElementById('checkoutArea').value;
  const landmark = document.getElementById('checkoutLandmark').value;
  
  const deliverySummary = document.getElementById('deliverySummary');
  deliverySummary.innerHTML = `
    <strong>${escapeHtml(name)}</strong><br>
    ${escapeHtml(address)}<br>
    ${escapeHtml(area)}<br>
    ${landmark ? `Landmark: ${escapeHtml(landmark)}<br>` : ''}
    <i class="bi bi-phone me-2"></i>${escapeHtml(phone)}
  `;
  
  // Order items
  const orderItemsSummary = document.getElementById('orderItemsSummary');
  let itemsHtml = '';
  cart.items.forEach(item => {
    itemsHtml += `
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;">
        <div>
          <strong>${escapeHtml(item.name)}</strong><br>
          <small class="text-muted">Qty: ${item.quantity} √ó ‚Çπ${item.price.toFixed(2)}</small>
        </div>
        <div style="font-weight: 600;">
          ‚Çπ${(item.quantity * item.price).toFixed(2)}
        </div>
      </div>
    `;
  });
  orderItemsSummary.innerHTML = itemsHtml;
  
  // Price details
  const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
  const subtotal = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  document.getElementById('summaryItemCountCheckout').textContent = totalItems;
  document.getElementById('summarySubtotalCheckout').textContent = `‚Çπ${subtotal.toFixed(2)}`;
  document.getElementById('summaryTotalCheckout').textContent = `‚Çπ${subtotal.toFixed(2)}`;
}

/**
 * Confirm Order
 */
async function confirmOrder() {
  console.log('üì¶ Placing order...');
  
  try {
    showSyncIndicator('Placing order...', null);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // Prepare order data
    const orderData = {
      orderId: 'ORD' + Date.now(),
      customerId: window.currentUser.uid,
      customerName: document.getElementById('checkoutName').value.trim(),
      customerPhone: document.getElementById('checkoutPhone').value.trim(),
      deliveryAddress: {
        name: document.getElementById('checkoutName').value.trim(),
        phone: document.getElementById('checkoutPhone').value.trim(),
        address: document.getElementById('checkoutAddress').value.trim(),
        area: document.getElementById('checkoutArea').value.trim(),
        landmark: document.getElementById('checkoutLandmark').value.trim()
      },
      shopId: cart.shopId,
      shopName: cart.shopName,
      shopOwnerId: cart.shopOwnerId,
      items: cart.items.map(item => ({
        id: item.id,
        name: item.name,
        price: item.price,
        quantity: item.quantity,
        brand: item.brand || '',
        size: item.size || ''
      })),
      subtotal: cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
      deliveryFee: 0,
      total: cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
      paymentMethod: 'COD',
      status: 'pending',
      deliveryTime: null,
      placedAt: new Date().toISOString(),
      acceptedAt: null,
      deliveredAt: null
    };
    
    // Save to Firebase: shops/{shopId}/orders
    const ordersRef = collection(window.db, 'shops', cart.shopId, 'orders');
    await addDoc(ordersRef, orderData);
    
    console.log('‚úÖ Order placed successfully:', orderData.orderId);
    
    // Show order ID
    document.getElementById('confirmedOrderId').textContent = orderData.orderId;
    
    // Move to step 3
    currentCheckoutStep = 3;
    updateCheckoutUI();
    
    // Clear cart
    clearCart();
    
    showSyncIndicator('Order placed!', 2000);
    
  } catch (error) {
    console.error('‚ùå Error placing order:', error);
    showSyncIndicator('Order failed', 1500);
    alert('‚ùå Error placing order: ' + error.message);
  }
}

/**
 * Close Checkout Modal
 */
function closeCheckoutModal() {
  const modal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
  if (modal) modal.hide();
  
  // Reset
  currentCheckoutStep = 1;
  updateCheckoutUI();
  
  // Go to customer orders page
  if (typeof navigateToCustomerOrders === 'function') {
    navigateToCustomerOrders();
  } else {
    goBackHome();
  }
}


/**
 * ==========================================
 * ORDERS MANAGEMENT SYSTEM
 * ==========================================
 */

 let currentShopOrders = [];
let currentOrderFilter = 'all';

/**
 * Navigate to Shop Orders Page
 */
async function navigateToShopOrders(shopId, shopName) {
  console.log('üì¶ Navigating to orders for shop:', shopId, shopName);
  
  // Check if shopowner
  if (!window.currentUser || window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can view orders.');
    return;
  }
  
  // Store current shop data
  currentShopData = cachedShops.find(shop => shop.id === shopId);
  
  if (!currentShopData) {
    alert('‚ùå Shop not found!');
    return;
  }
  
  // Check ownership
  if (currentShopData.ownerId !== window.currentUser.uid) {
    alert('‚ö†Ô∏è You can only view orders for your own shop.');
    return;
  }
  
  // Hide other pages
  const mainApp = document.getElementById('mainApp');
  const ordersPage = document.getElementById('ordersPage');
  
  if (mainApp) mainApp.style.display = 'none';
  if (ordersPage) {
    ordersPage.style.display = 'block';
    ordersPage.classList.add('active');
  }
  
  // Update page title
  document.getElementById('ordersPageTitle').textContent = `${shopName} - Orders`;
  
  // Render shop info
  const ordersShopInfo = document.getElementById('ordersShopInfo');
  if (ordersShopInfo) {
    ordersShopInfo.style.display = 'block';
    ordersShopInfo.innerHTML = `
      <div class="card-body">
        <h5 style="font-weight: 700; margin-bottom: 10px;">
          <i class="bi bi-shop"></i> ${escapeHtml(shopName)}
        </h5>
        <p class="text-muted mb-0" style="font-size: 0.9rem;">
          <i class="bi bi-info-circle"></i> Manage orders from customers
        </p>
      </div>
    `;
  }
  
  // Load orders
  await loadShopOrders(shopId);
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  window.location.hash = '#shop-orders/' + shopId;
}

/**
 * Load Shop Orders from Firebase
 */
async function loadShopOrders(shopId) {
  console.log('üîÑ Loading orders for shop:', shopId);
  
  const ordersContainer = document.getElementById('ordersListContainer');
  const emptyState = document.getElementById('ordersEmptyState');
  
  if (!ordersContainer) return;
  
  // Show loading
  ordersContainer.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div class="spinner-border text-warning" role="status"></div>
      <p class="mt-3">Loading orders...</p>
    </div>
  `;
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    // Load orders from shops/{shopId}/orders
    const ordersRef = collection(window.db, 'shops', shopId, 'orders');
    const ordersSnap = await getDocs(ordersRef);
    
    currentShopOrders = [];
    ordersSnap.forEach((doc) => {
      currentShopOrders.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Sort by placedAt (newest first)
    currentShopOrders.sort((a, b) => {
      const dateA = new Date(a.placedAt).getTime();
      const dateB = new Date(b.placedAt).getTime();
      return dateB - dateA;
    });
    
    console.log(`‚úÖ Loaded ${currentShopOrders.length} orders`);
    
    // Render orders
    renderShopOrders();
    
  } catch (error) {
    console.error('‚ùå Error loading orders:', error);
    ordersContainer.innerHTML = `
      <div class="alert alert-danger" style="border-radius: 12px;">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Error loading orders:</strong> ${error.message}
      </div>
    `;
  }
}

/**
 * Filter Orders
 */
function filterOrders(filter) {
  console.log('üîç Filtering orders:', filter);
  currentOrderFilter = filter;
  
  // Update button states
  document.querySelectorAll('#ordersPage .btn-group button').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1))?.classList.add('active');
  
  renderShopOrders();
}

/**
 * Render Shop Orders
 */
function renderShopOrders() {
  const ordersContainer = document.getElementById('ordersListContainer');
  const emptyState = document.getElementById('ordersEmptyState');
  
  if (!ordersContainer) return;
  
  // Filter orders
  let filteredOrders = currentShopOrders;
  if (currentOrderFilter !== 'all') {
    filteredOrders = currentShopOrders.filter(order => order.status === currentOrderFilter);
  }
  
  if (filteredOrders.length === 0) {
    ordersContainer.innerHTML = '';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  if (emptyState) emptyState.style.display = 'none';
  
  let html = '';
  filteredOrders.forEach(order => {
    const statusClass = order.status || 'pending';
    const statusText = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
    
    html += `
      <div class="order-card ${statusClass}">
        
        <!-- Order Header -->
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
          <div>
            <h5 style="font-weight: 700; margin-bottom: 5px;">
              <i class="bi bi-receipt"></i> ${escapeHtml(order.orderId)}
            </h5>
            <p class="text-muted mb-0" style="font-size: 0.85rem;">
              <i class="bi bi-clock"></i> ${formatDate(order.placedAt)}
            </p>
          </div>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        
        <!-- Customer Info -->
        <div class="card mb-3" style="background: #f8f9fa; border: none; border-radius: 8px;">
          <div class="card-body" style="padding: 12px;">
            <h6 style="font-weight: 600; margin-bottom: 8px;">
              <i class="bi bi-person-circle text-primary"></i> Customer Details
            </h6>
            <p class="mb-1"><strong>${escapeHtml(order.customerName)}</strong></p>
            <p class="mb-1"><i class="bi bi-phone"></i> ${escapeHtml(order.customerPhone)}</p>
            <p class="mb-0"><i class="bi bi-geo-alt"></i> ${escapeHtml(order.deliveryAddress.address)}, ${escapeHtml(order.deliveryAddress.area)}</p>
            ${order.deliveryAddress.landmark ? `<p class="mb-0 text-muted" style="font-size: 0.85rem;">Landmark: ${escapeHtml(order.deliveryAddress.landmark)}</p>` : ''}
          </div>
        </div>
        
        <!-- Order Items -->
        <div class="mb-3">
          <h6 style="font-weight: 600; margin-bottom: 10px;">
            <i class="bi bi-cart text-success"></i> Order Items (${order.items.length})
          </h6>
          ${order.items.map(item => `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
              <div>
                <strong>${escapeHtml(item.name)}</strong>
                <small class="text-muted d-block">Qty: ${item.quantity}</small>
              </div>
              <span style="font-weight: 600;">‚Çπ${(item.price * item.quantity).toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        
        <!-- Total -->
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
          <span style="font-weight: 600;">Total Amount:</span>
          <span style="font-size: 1.3rem; font-weight: 700; color: #25D366;">‚Çπ${order.total.toFixed(2)}</span>
        </div>
        
        <!-- Payment Method -->
        <div class="alert alert-warning mb-3" style="padding: 10px; border-radius: 8px; font-size: 0.85rem;">
          <i class="bi bi-cash-coin"></i> Payment: <strong>Cash on Delivery (COD)</strong>
        </div>
        
        ${order.status === 'pending' ? `
          <!-- Accept Order Form -->
          <div class="card" style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px;">
            <div class="card-body">
              <h6 style="font-weight: 600; margin-bottom: 15px;">
                <i class="bi bi-clock-history"></i> Set Delivery Time
              </h6>
              <div class="mb-3">
                <label class="form-label" style="font-weight: 600;">Estimated delivery time (minutes)</label>
                <input 
                  type="number" 
                  class="form-control" 
                  id="deliveryTime_${order.id}" 
                  placeholder="e.g., 30"
                  min="10"
                  max="300"
                  value="30"
                  style="border-radius: 8px;"
                >
                <small class="text-muted">How many minutes will it take to deliver?</small>
              </div>
              <button 
                class="btn btn-success w-100" 
                onclick="acceptOrder('${order.id}')"
                style="border-radius: 8px; padding: 12px; font-weight: 600;">
                <i class="bi bi-check-circle me-2"></i>Accept Order & Start Preparing
              </button>
            </div>
          </div>
        ` : order.status === 'accepted' ? `
          <!-- Delivery Info -->
          <div class="alert alert-success" style="border-radius: 8px;">
            <i class="bi bi-check-circle me-2"></i>
            <strong>Order Accepted!</strong><br>
            Estimated delivery: ${order.deliveryTime} minutes<br>
            Accepted at: ${formatDate(order.acceptedAt)}
          </div>
          <button 
            class="btn btn-primary w-100" 
            onclick="markAsDelivered('${order.id}')"
            style="border-radius: 8px; padding: 12px; font-weight: 600;">
            <i class="bi bi-check2-all me-2"></i>Mark as Delivered
          </button>
        ` : `
          <!-- Delivered -->
          <div class="alert alert-info" style="border-radius: 8px;">
            <i class="bi bi-check2-all me-2"></i>
            <strong>Order Delivered!</strong><br>
            Delivered at: ${formatDate(order.deliveredAt)}
          </div>
        `}
        
      </div>
    `;
  });
  
  ordersContainer.innerHTML = html;
  console.log(`‚úÖ Rendered ${filteredOrders.length} orders`);
}

/**
 * Accept Order
 */
async function acceptOrder(orderId) {
  console.log('‚úÖ Accepting order:', orderId);
  
  const deliveryTimeInput = document.getElementById('deliveryTime_' + orderId);
  if (!deliveryTimeInput) return;
  
  const deliveryTime = parseInt(deliveryTimeInput.value);
  
  if (!deliveryTime || deliveryTime < 10) {
    alert('‚ö†Ô∏è Please enter a valid delivery time (minimum 10 minutes)');
    deliveryTimeInput.focus();
    return;
  }
  
  try {
    showSyncIndicator('Accepting order...', null);
    
    const { doc, updateDoc } = window.firebaseImports;
    
    // Update order status
    const orderRef = doc(window.db, 'shops', currentShopData.id, 'orders', orderId);
    await updateDoc(orderRef, {
      status: 'accepted',
      deliveryTime: deliveryTime,
      acceptedAt: new Date().toISOString()
    });
    
    console.log('‚úÖ Order accepted successfully');
    
    // Update local cache
    const orderIndex = currentShopOrders.findIndex(o => o.id === orderId);
    if (orderIndex !== -1) {
      currentShopOrders[orderIndex].status = 'accepted';
      currentShopOrders[orderIndex].deliveryTime = deliveryTime;
      currentShopOrders[orderIndex].acceptedAt = new Date().toISOString();
    }
    
    // Re-render
    renderShopOrders();
    
    showSyncIndicator('Order accepted!', 2000);
    
    alert(`‚úÖ Order Accepted!\n\nDelivery time: ${deliveryTime} minutes\n\nThe customer has been notified.`);
    
  } catch (error) {
    console.error('‚ùå Error accepting order:', error);
    showSyncIndicator('Failed to accept', 1500);
    alert('‚ùå Error accepting order: ' + error.message);
  }
}

/**
 * Mark Order as Delivered
 */
async function markAsDelivered(orderId) {
  const confirmed = confirm('Mark this order as delivered?\n\nThis action cannot be undone.');
  
  if (!confirmed) return;
  
  try {
    showSyncIndicator('Updating status...', null);
    
    const { doc, updateDoc } = window.firebaseImports;
    
    // Update order status
    const orderRef = doc(window.db, 'shops', currentShopData.id, 'orders', orderId);
    await updateDoc(orderRef, {
      status: 'delivered',
      deliveredAt: new Date().toISOString()
    });
    
    console.log('‚úÖ Order marked as delivered');
    
    // Update local cache
    const orderIndex = currentShopOrders.findIndex(o => o.id === orderId);
    if (orderIndex !== -1) {
      currentShopOrders[orderIndex].status = 'delivered';
      currentShopOrders[orderIndex].deliveredAt = new Date().toISOString();
    }
    
    // Re-render
    renderShopOrders();
    
    showSyncIndicator('Order delivered!', 2000);
    
    alert('‚úÖ Order marked as delivered successfully!');
    
  } catch (error) {
    console.error('‚ùå Error updating order:', error);
    showSyncIndicator('Update failed', 1500);
    alert('‚ùå Error updating order: ' + error.message);
  }
}

/**
 * Go Back from Orders Page
 */
function goBackFromOrders() {
  const ordersPage = document.getElementById('ordersPage');
  if (ordersPage) {
    ordersPage.style.display = 'none';
    ordersPage.classList.remove('active');
  }
  
  goBackHome();
}

/**
 * Navigate to Customer Orders
 */
async function navigateToCustomerOrders() {
  console.log('üë§ Navigating to customer orders');
  
  if (!window.currentUser || window.currentUser.role !== 'customer') {
    alert('‚ö†Ô∏è Only customers can view their orders.');
    return;
  }
  
  // Hide other pages
  const mainApp = document.getElementById('mainApp');
  const customerOrdersPage = document.getElementById('customerOrdersPage');
  
  if (mainApp) mainApp.style.display = 'none';
  if (customerOrdersPage) {
    customerOrdersPage.style.display = 'block';
    customerOrdersPage.classList.add('active');
  }
  
  // Load customer orders
  await loadCustomerOrders();
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  window.location.hash = '#my-orders';
}

/**
 * Load Customer Orders
 */
async function loadCustomerOrders() {
  console.log('üîÑ Loading customer orders...');
  
  const ordersList = document.getElementById('customerOrdersList');
  const emptyState = document.getElementById('customerOrdersEmptyState');
  
  if (!ordersList) return;
  
  // Show loading
  ordersList.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3">Loading your orders...</p>
    </div>
  `;
  
  try {
    const { collectionGroup, query, where, getDocs } = window.firebaseImports;
    
    // Query all orders across all shops where customerId matches
    const ordersQuery = query(
      collectionGroup(window.db, 'orders'),
      where('customerId', '==', window.currentUser.uid)
    );
    
    const ordersSnap = await getDocs(ordersQuery);
    
    let customerOrders = [];
    ordersSnap.forEach((doc) => {
      customerOrders.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Sort by placedAt (newest first)
    customerOrders.sort((a, b) => {
      const dateA = new Date(a.placedAt).getTime();
      const dateB = new Date(b.placedAt).getTime();
      return dateB - dateA;
    });
    
    console.log(`‚úÖ Loaded ${customerOrders.length} customer orders`);
    
    if (customerOrders.length === 0) {
      ordersList.innerHTML = '';
      if (emptyState) emptyState.style.display = 'block';
      return;
    }
    
    if (emptyState) emptyState.style.display = 'none';
    
    // Render customer orders
    let html = '';
    customerOrders.forEach(order => {
      const statusClass = order.status || 'pending';
      const statusText = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
      
      html += `
        <div class="order-card ${statusClass}">
          
          <!-- Order Header -->
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
            <div style="flex: 1;">
              <h5 style="font-weight: 700; margin-bottom: 5px;">
                <i class="bi bi-receipt"></i> ${escapeHtml(order.orderId)}
              </h5>
              <p class="text-muted mb-1" style="font-size: 0.85rem;">
                <i class="bi bi-shop"></i> ${escapeHtml(order.shopName)}
              </p>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">
                <i class="bi bi-clock"></i> ${formatDate(order.placedAt)}
              </p>
            </div>
            <span class="status-badge ${statusClass}">${statusText}</span>
          </div>
          
          <!-- Order Items -->
          <div class="mb-3">
            ${order.items.map(item => `
              <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                <div>
                  <strong>${escapeHtml(item.name)}</strong>
                  <small class="text-muted d-block">Qty: ${item.quantity}</small>
                </div>
                <span style="font-weight: 600;">‚Çπ${(item.price * item.quantity).toFixed(2)}</span>
              </div>
            `).join('')}
          </div>
          
          <!-- Total -->
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
            <span style="font-weight: 600;">Total:</span>
            <span style="font-size: 1.2rem; font-weight: 700; color: #25D366;">‚Çπ${order.total.toFixed(2)}</span>
          </div>
          
          <!-- Status Info -->
          ${order.status === 'pending' ? `
            <div class="alert alert-warning" style="border-radius: 8px; margin-bottom: 0;">
              <i class="bi bi-hourglass-split me-2"></i>
              <strong>Waiting for shop to accept...</strong>
            </div>
          ` : order.status === 'accepted' ? `
            <div class="alert alert-success" style="border-radius: 8px; margin-bottom: 0;">
              <i class="bi bi-check-circle me-2"></i>
              <strong>Order Accepted!</strong><br>
              Estimated delivery: ${order.deliveryTime} minutes<br>
              <small class="text-muted">The shop is preparing your order</small>
            </div>
          ` : `
            <div class="alert alert-info" style="border-radius: 8px; margin-bottom: 0;">
              <i class="bi bi-check2-all me-2"></i>
              <strong>Order Delivered!</strong><br>
              Delivered at: ${formatDate(order.deliveredAt)}
            </div>
          `}
          
        </div>
      `;
    });
    
    ordersList.innerHTML = html;
    
  } catch (error) {
    console.error('‚ùå Error loading customer orders:', error);
    ordersList.innerHTML = `
      <div class="alert alert-danger" style="border-radius: 12px;">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Error loading orders:</strong> ${error.message}
      </div>
    `;
  }
}

/**
 * Format Date Helper
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleString('en-IN', {
    day: '2-digit',
    month: 'short',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
}


</script>

</body>
</html>
