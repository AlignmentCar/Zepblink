<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Urban Estate 2 Local Shop</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#25D366">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="UE2 Shop">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
      import {
        getAuth,
        signInWithPopup,
        signInWithEmailAndPassword,
        signInAnonymously,  // ‚úÖ ADDED
        GoogleAuthProvider,
        onAuthStateChanged,
        signOut
      } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
      import {
        getFirestore,
        collection,
        collectionGroup,  // ‚úÖ ADDED
        doc,
        getDoc,
        getDocs,
        setDoc,
        addDoc,
        updateDoc,
        deleteDoc,  // ‚úÖ ADDED
        query,
        where,
        orderBy,  // ‚úÖ ADDED
        serverTimestamp
      } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBLt_z6QrkwXwK2l8tDq-n7choUJ6vUJf0",
        authDomain: "zepblink-3e1c7.firebaseapp.com",
        projectId: "zepblink-3e1c7",
        storageBucket: "zepblink-3e1c7.firebasestorage.app",
        messagingSenderId: "275105674132",
        appId: "1:275105674132:web:1e0460f6765a580c461581"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.auth = auth;
      window.db = db;
      
      // ‚úÖ UPDATED: Added missing imports
      window.firebaseImports = {
        // Firestore
        collection, 
        collectionGroup,  // ‚úÖ ADDED
        doc, 
        getDoc, 
        getDocs, 
        setDoc, 
        addDoc, 
        updateDoc,
        deleteDoc,  // ‚úÖ ADDED
        query, 
        where,
        orderBy,  // ‚úÖ ADDED
        serverTimestamp,
        // Auth
        signInWithPopup,
        signInWithEmailAndPassword,
        signInAnonymously,  // ‚úÖ ADDED
        GoogleAuthProvider, 
        onAuthStateChanged,
        signOut
      };

      console.log("‚úÖ Firebase SDK loaded successfully!");
      console.log("‚úÖ Available imports:", Object.keys(window.firebaseImports));

    // Auth State Listener (UPDATED with address loading)
onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log('‚úÖ User signed in:', user.email || user.uid);

    let userRole = 'customer'; // Default role
    
    try {
      const userDocRef = doc(db, 'users', user.uid);
      const userDoc = await getDoc(userDocRef);

      if (userDoc.exists()) {
        userRole = userDoc.data().role || 'customer';
        console.log('üìù User role from Firestore:', userRole);
        
        // Update last login
        await setDoc(userDocRef, {
          lastLogin: serverTimestamp()
        }, { merge: true });
      } else {
        // ‚úÖ Check if email exists before using it
        const userEmail = user.email || `anonymous_${user.uid.slice(0, 8)}@ue2shop.test`;
        
        // Determine role based on email
        userRole = (user.email && isAuthorizedShopowner(user.email)) ? 'shopowner' : 'customer';
        
        // Create new user document
        await setDoc(userDocRef, {
          email: userEmail,
          displayName: user.displayName || userEmail.split('@')[0] || 'User',
          photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=25D366&color=fff`,
          location: 'Urban Estate 2, Hisar',
          role: userRole,
          createdAt: serverTimestamp(),
          lastLogin: serverTimestamp()
        });
        console.log('‚úÖ New user created with role:', userRole);
      }
    } catch (error) {
      console.error('‚ùå Error checking user data:', error);
    }

    // ‚úÖ Store user info with safe fallbacks
    const userEmail = user.email || `anonymous_${user.uid.slice(0, 8)}@ue2shop.test`;
    const displayName = user.displayName || userEmail.split('@')[0] || 'User';

    window.currentUser = {
      email: userEmail,
      uid: user.uid,
      displayName: displayName,
      photoURL: user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=25D366&color=fff`,
      role: userRole
    };

    console.log('‚úÖ Current user:', window.currentUser);

    // Show main app
    showApp();
    
    // ‚úÖ Update sidebar based on user role
    if (typeof updateSidebarForUser === 'function') {
      updateSidebarForUser();
    }
    
    // ‚úÖ Update user info in header
    if (typeof updateUserInfo === 'function') {
      updateUserInfo();
    }
    
    // ‚úÖ NEW: Load saved delivery address
    if (typeof loadSavedDeliveryAddress === 'function') {
      loadSavedDeliveryAddress().catch(err => {
        console.warn('‚ö†Ô∏è Could not load delivery address:', err);
      });
    }
    
  } else {
    console.log('‚ùå No user signed in');
    window.currentUser = null;
    savedDeliveryAddress = null; // ‚úÖ Clear saved address
    showAuthScreen();
  }
});


      // Check if email is authorized shopowner
      function isAuthorizedShopowner(email) {
        const authorizedEmails = [
          'sharma.uday8831@gmail.com',
          'shopowner2@example.com',
          'shopowner3@example.com'
          // Add more authorized shopowner emails here
        ];
        return authorizedEmails.includes(email.toLowerCase());
      }

      window.isAuthorizedShopowner = isAuthorizedShopowner;

   /**
 * Show Main App (UPDATED with featured products, cart, and mobile nav)
 */
function showApp() {
  console.log('üì± Showing main app...');
  
  const authScreen = document.getElementById('authScreen');
  const mainApp = document.getElementById('mainApp');
  
  // Hide auth screen
  if (authScreen) {
    authScreen.style.display = 'none';
  }
  
  // Show main app
  if (mainApp) {
    mainApp.style.display = 'block';
    mainApp.classList.add('active');
  }
  
  // Update user info in navbar
  if (typeof updateUserInfo === 'function') {
    updateUserInfo();
  }
  
  // ‚úÖ Initialize cart from storage
  if (typeof initializeCart === 'function') {
    initializeCart();
  }
  
  // ‚úÖ Load shops and featured products after showing app
  setTimeout(() => {
    if (typeof loadShopsFromFirestore === 'function') {
      loadShopsFromFirestore();
    } else if (typeof loadShops === 'function') {
      loadShops();
    }
    
    // Load featured products
    if (typeof loadFeaturedProducts === 'function') {
      loadFeaturedProducts();
    }
    
    // ‚úÖ NEW: Initialize mobile bottom nav
    if (typeof initializeMobileBottomNav === 'function') {
      initializeMobileBottomNav();
    }
  }, 500);
  
  console.log('‚úÖ Main app displayed');
}

// Make it global
window.showApp = showApp;


      function showAuthScreen() {
        document.getElementById('authScreen').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
      }

      function updateUserInfo() {
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userEmailDropdown = document.getElementById('userEmailDropdown');
        const userEmailMobile = document.getElementById('userEmailMobile');
        const userAvatar = document.getElementById('userAvatar');
        const userAvatarMobile = document.getElementById('userAvatarMobile');
        const userRole = document.getElementById('userRole');
        const userRoleDropdown = document.getElementById('userRoleDropdown');
        const userRoleDropdownMobile = document.getElementById('userRoleDropdownMobile');
        const userRoleMobile = document.getElementById('userRoleMobile');

        if (window.currentUser) {
          const displayName = window.currentUser.displayName;
          const email = window.currentUser.email;
          const role = window.currentUser.role || 'customer';
          
          // Update user name
          if (userName) userName.textContent = displayName;
          if (userEmail) userEmail.textContent = email;
          if (userEmailDropdown) userEmailDropdown.textContent = email;
          if (userEmailMobile) userEmailMobile.textContent = email;
          
          // Update avatar
          const avatarUrl = window.currentUser.photoURL || 
                           `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=25D366&color=fff`;
          if (userAvatar) userAvatar.src = avatarUrl;
          if (userAvatarMobile) userAvatarMobile.src = avatarUrl;
          
          // Update role badges
          let roleText = '';
          let roleColor = '';
          
          if (role === 'shopowner') {
            roleText = 'üè™ Shopowner';
            roleColor = 'background: #ffc107; color: #000;';
          } else if (role === 'customer') {
            roleText = 'üõçÔ∏è Customer';
            roleColor = 'background: #0d6efd; color: white;';
          } else {
            roleText = 'üë§ Guest';
            roleColor = 'background: #6c757d; color: white;';
          }
          
          if (userRole) {
            userRole.textContent = roleText;
            userRole.setAttribute('style', `font-size: 0.65rem; padding: 2px 8px; margin-top: 2px; ${roleColor} border-radius: 10px;`);
          }
          
          if (userRoleDropdown) {
            userRoleDropdown.textContent = roleText;
            userRoleDropdown.setAttribute('style', `font-size: 0.7rem; ${roleColor} border-radius: 10px; padding: 3px 8px;`);
          }
          
          if (userRoleDropdownMobile) {
            userRoleDropdownMobile.textContent = roleText;
            userRoleDropdownMobile.setAttribute('style', `font-size: 0.7rem; ${roleColor} border-radius: 10px; padding: 3px 8px;`);
          }
          
          if (userRoleMobile) {
            userRoleMobile.textContent = roleText.split(' ')[0];
            userRoleMobile.setAttribute('style', `position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px; ${roleColor} border-radius: 10px;`);
          }
          
          // Show/Hide Register Shop Button based on role
          const registerShopBtn = document.getElementById('registerShopBtn');
          const registerShopBtnMobile = document.getElementById('registerShopBtnMobile');
          
          if (role === 'shopowner') {
            if (registerShopBtn) {
              registerShopBtn.classList.remove('d-none');
              registerShopBtn.style.display = 'block';
            }
            if (registerShopBtnMobile) {
              registerShopBtnMobile.style.display = 'block';
            }
          } else {
            if (registerShopBtn) {
              registerShopBtn.classList.add('d-none');
              registerShopBtn.style.display = 'none';
            }
            if (registerShopBtnMobile) {
              registerShopBtnMobile.style.display = 'none';
            }
          }
          
        } else {
          // Guest mode
          if (userName) userName.textContent = 'Guest User';
          if (userEmail) userEmail.textContent = 'guest@ue2shop.local';
          if (userEmailDropdown) userEmailDropdown.textContent = 'guest@ue2shop.local';
          if (userEmailMobile) userEmailMobile.textContent = 'guest@ue2shop.local';
          
          const guestAvatar = 'https://ui-avatars.com/api/?name=Guest&background=6c757d&color=fff';
          if (userAvatar) userAvatar.src = guestAvatar;
          if (userAvatarMobile) userAvatarMobile.src = guestAvatar;
          
          const guestRole = 'üë§ Guest';
          const guestStyle = 'background: #6c757d; color: white; border-radius: 10px;';
          
          if (userRole) {
            userRole.textContent = guestRole;
            userRole.setAttribute('style', `font-size: 0.65rem; padding: 2px 8px; margin-top: 2px; ${guestStyle}`);
          }
          if (userRoleDropdown) {
            userRoleDropdown.textContent = guestRole;
            userRoleDropdown.setAttribute('style', `font-size: 0.7rem; ${guestStyle} padding: 3px 8px;`);
          }
          if (userRoleDropdownMobile) {
            userRoleDropdownMobile.textContent = guestRole;
            userRoleDropdownMobile.setAttribute('style', `font-size: 0.7rem; ${guestStyle} padding: 3px 8px;`);
          }
          if (userRoleMobile) {
            userRoleMobile.textContent = 'üë§';
            userRoleMobile.setAttribute('style', `position: absolute; top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px; ${guestStyle}`);
          }
          
          const registerShopBtn = document.getElementById('registerShopBtn');
          const registerShopBtnMobile = document.getElementById('registerShopBtnMobile');
          
          if (registerShopBtn) {
            registerShopBtn.classList.add('d-none');
            registerShopBtn.style.display = 'none';
          }
          if (registerShopBtnMobile) {
            registerShopBtnMobile.style.display = 'none';
          }
        }
      }

    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>

<!-- ============================================
     AUTHENTICATION SCREEN
     ============================================ -->
<div id="authScreen" style="display: block;">
  <div class="auth-container">
    <div class="auth-card">

      <!-- App Icon & Branding -->
      <div class="auth-header">
        <div class="app-icon">
          <i class="bi bi-shop"></i>
        </div>
        <h1 class="app-title">Urban Estate 2</h1>
        <p class="app-subtitle">Local Shop - Hisar</p>
        <p class="location-badge">
          <i class="bi bi-geo-alt-fill"></i> Urban Estate 2, Hisar Only
        </p>
      </div>

      <!-- Welcome Message -->
      <div class="auth-body">
        <h2 class="welcome-text">Welcome Back!</h2>
        <p class="welcome-subtext">Order from your favorite local shops in Urban Estate 2</p>

        <!-- Google Sign-In Button (FOR CUSTOMERS) -->
        <button 
          onclick="handleGoogleSignIn()" 
          class="btn-google-signin" 
          id="googleSignInBtn"
        >
          <svg width="20" height="20" viewBox="0 0 18 18" class="google-icon">
            <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
            <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
            <path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/>
            <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
          </svg>
          <span class="btn-text">Continue with Google</span>
        </button>

        <!-- Divider -->
        <div class="position-relative my-4">
          <hr style="border-top: 1px solid #dee2e6;">
          <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 0 15px; color: #6c757d; font-size: 0.875rem;">
            OR
          </span>
        </div>

        <!-- Email/Password Sign-In (FOR AUTHORIZED SHOPOWNERS ONLY) -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Shopowner Email" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>

          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>

          <button type="submit" id="loginButton" class="btn btn-outline-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In with Email
          </button>
        </form>

        <p class="text-muted mt-3" style="font-size: 0.8rem; text-align: center;">
          <i class="bi bi-info-circle"></i> Email sign-in is for authorized shopowners only
        </p>
<!-- ‚úÖ TEST LOGIN BUTTONS (Development Only) -->
<div class="mt-4 pt-3" style="border-top: 1px solid #dee2e6;">
  <p class="text-muted mb-2" style="font-size: 0.75rem; text-align: center;">
    <i class="bi bi-code-slash"></i> Development Testing Only
  </p>
  
  <button onclick="testLoginAsCustomer()" class="btn btn-sm w-100 mb-2" style="background: rgba(13, 110, 253, 0.1); color: #0d6efd; border: 1px dashed #0d6efd; border-radius: 8px; padding: 10px; font-weight: 600;">
    <i class="bi bi-person-circle me-2"></i>Test Login as Customer
  </button>
  
  <button onclick="testLoginAsShopowner()" class="btn btn-sm w-100 mb-2" style="background: rgba(255, 193, 7, 0.1); color: #856404; border: 1px dashed #856404; border-radius: 8px; padding: 10px; font-weight: 600;">
    <i class="bi bi-shop me-2"></i>Test Login as Shopowner
  </button>
  
  <button onclick="skipLogin()" class="btn btn-sm w-100" style="background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 1px dashed #6c757d; border-radius: 8px; padding: 8px; font-weight: 600;">
    <i class="bi bi-skip-forward-circle me-2"></i>Browse as Guest
  </button>
</div>


        <!-- Features -->
        <div class="auth-features">
          <div class="feature-item">
            <i class="bi bi-lightning-charge-fill"></i>
            <span>Quick Orders</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-truck"></i>
            <span>Local Delivery</span>
          </div>
          <div class="feature-item">
            <i class="bi bi-shield-check"></i>
            <span>Secure Payment</span>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="auth-footer">
        <p class="security-text">
          <i class="bi bi-shield-lock"></i> 
          Secured by Firebase Authentication
        </p>
      </div>

    </div>
  </div>
</div>

<!-- ============================================
     MAIN APP - HOMEPAGE
     ============================================ -->
<div id="mainApp" style="display: none;">

  <!-- ============================================
       HAMBURGER BUTTON & SIDEBAR
       ============================================ -->
  <!-- Hamburger Menu Button -->
  <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
    <i class="bi bi-list"></i>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar Menu -->
<nav class="sidebar-menu" id="sidebarMenu">
  
  <!-- Sidebar Header -->
  <div class="sidebar-header">
    <i class="bi bi-shop" style="font-size: 32px;"></i>
    <h4 class="mt-2">UE2 Shop Menu</h4>
  </div>
  
  <!-- Home -->
  <div class="sidebar-item" onclick="goToHome()">
    <i class="bi bi-house-door"></i>
    <span>Home</span>
  </div>
  
  <!-- SHOPPING Section -->
  <div class="sidebar-section-title">SHOPPING</div>
  
  <div class="sidebar-item" onclick="navigateTo('categories')">
    <i class="bi bi-grid-3x3-gap"></i>
    <span>Shop by Category</span>
  </div>
  
  <div class="sidebar-item" onclick="navigateTo('shops')">
    <i class="bi bi-shop-window"></i>
    <span>All Shops</span>
  </div>
  
  <div class="sidebar-item" onclick="navigateTo('deals')">
    <i class="bi bi-tag-fill"></i>
    <span>Deals & Offers</span>
  </div>
  
  <!-- MY ACCOUNT Section -->
  <div class="sidebar-section-title">MY ACCOUNT</div>
  
  <!-- ‚úÖ FIXED: Customer Orders Link -->
  <div id="myOrdersLink" style="display: none;">
    <div class="sidebar-item" onclick="navigateToCustomerOrders()">
      <i class="bi bi-bag-check"></i>
      <span>My Orders</span>
    </div>
  </div>
  
  <div class="sidebar-item" onclick="navigateTo('cart')">
    <i class="bi bi-cart3"></i>
    <span>Shopping Cart</span>
  </div>
  
  <div class="sidebar-item" onclick="navigateTo('favorites')">
    <i class="bi bi-heart-fill"></i>
    <span>Favorites</span>
  </div>
  
  <div class="sidebar-item" onclick="navigateTo('address')">
    <i class="bi bi-geo-alt-fill"></i>
    <span>Delivery Address</span>
  </div>
  
  <!-- SETTINGS Section -->
  <div class="sidebar-section-title">SETTINGS</div>
  
  <div class="sidebar-item" onclick="navigateTo('profile')">
    <i class="bi bi-person-circle"></i>
    <span>Profile Settings</span>
  </div>
  
  <div class="sidebar-item" onclick="navigateTo('help')">
    <i class="bi bi-question-circle"></i>
    <span>Help & Support</span>
  </div>
  
</nav>


  <!-- ‚úÖ NAVBAR - Professional with User Dropdown + Register Shop Button -->
<nav id="mainNavbar" class="navbar navbar-dark sticky-top" 
style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 12px 0; padding-left: 70px;">
<div class="container-fluid">
<div class="w-100">
 
 <!-- Row 1: App Name + Buttons -->
 <div class="d-flex align-items-center justify-content-between">
   <!-- App Name -->
   <span class="navbar-brand mb-0 h1 d-flex align-items-center" style="margin: 0; font-size: 1.3rem;">
     <i class="bi bi-shop me-2" style="font-size: 1.5rem;"></i>
     <span>UE2 Shop</span>
   </span>
   
   <!-- Right Side: Register Shop Button + User Dropdown -->
   <div class="d-flex align-items-center gap-3">
     
     <!-- ‚úÖ NEW: Register Shop Button (Shopowners Only) -->
     <button 
       id="registerShopBtn" 
       class="btn btn-light d-none" 
       onclick="openRegisterShopModal()" 
       style="border-radius: 10px; font-weight: 600; padding: 8px 16px; display: none;">
       <i class="bi bi-shop me-2"></i>Register Shop
     </button>
     
     <!-- Desktop: User Dropdown with Role Badge -->
     <div class="dropdown d-none d-md-block">
       <button class="btn text-white d-flex align-items-center" 
               type="button" 
               id="userDropdown" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 10px; font-weight: 600; padding: 8px 16px;">
         <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
         <div class="d-flex flex-column align-items-start me-2">
           <span id="userName" style="font-size: 0.9rem;">Loading...</span>
           <span id="userRole" class="badge" style="font-size: 0.65rem; padding: 2px 8px; margin-top: 2px;">Guest</span>
         </div>
         <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
       </button>
       
       <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown" style="border-radius: 10px; min-width: 250px; border: none;">
         <li>
           <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
             <div class="d-flex align-items-center">
               <img id="userAvatar" src="https://ui-avatars.com/api/?name=Guest&background=25D366&color=fff" alt="User" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
               <div style="flex: 1;">
                 <strong id="userEmailDropdown" style="font-size: 0.85rem; display: block;">user@example.com</strong>
                 <span id="userRoleDropdown" class="badge mt-1" style="font-size: 0.7rem;">Guest</span>
               </div>
             </div>
           </div>
         </li>
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('orders'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-bag me-2" style="color: #25D366;"></i>
             <span style="font-weight: 500;">My Orders</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('favorites'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-heart me-2" style="color: #dc3545;"></i>
             <span style="font-weight: 500;">Favorites</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('address'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-geo-alt me-2" style="color: #0d6efd;"></i>
             <span style="font-weight: 500;">Delivery Address</span>
           </a>
         </li>
         
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <button class="dropdown-item d-flex align-items-center" onclick="handleSignOut()" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
             <i class="bi bi-box-arrow-right me-2" style="color: #128C7E;"></i>
             <span style="color: #128C7E; font-weight: 500;">Sign Out</span>
           </button>
         </li>
       </ul>
     </div>
     
     <!-- Mobile: User Icon Button with Badge -->
     <div class="dropdown d-md-none">
       <button class="btn text-white position-relative" 
               type="button" 
               data-bs-toggle="dropdown" 
               aria-expanded="false"
               style="background: rgba(255, 255, 255, 0.2); border: none; border-radius: 10px; padding: 8px 12px;">
         <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
         <span id="userRoleMobile" class="badge position-absolute" style="top: -5px; right: -5px; font-size: 0.6rem; padding: 2px 6px;">Guest</span>
       </button>
       
       <ul class="dropdown-menu dropdown-menu-end shadow" style="border-radius: 10px; min-width: 250px; border: none;">
         <li>
           <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
             <div class="d-flex align-items-center">
               <img id="userAvatarMobile" src="https://ui-avatars.com/api/?name=Guest&background=25D366&color=fff" alt="User" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
               <div style="flex: 1;">
                 <strong id="userEmailMobile" style="font-size: 0.85rem; display: block;">user@example.com</strong>
                 <span id="userRoleDropdownMobile" class="badge mt-1" style="font-size: 0.7rem;">Guest</span>
               </div>
             </div>
           </div>
         </li>
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <!-- ‚úÖ NEW: Mobile Register Shop Button -->
         <li id="registerShopBtnMobile" style="display: none;">
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="openRegisterShopModal(); return false;" style="padding: 12px 16px; background: rgba(37, 211, 102, 0.1);">
             <i class="bi bi-shop me-2" style="color: #25D366;"></i>
             <span style="font-weight: 600; color: #128C7E;">Register Shop</span>
           </a>
           <hr class="dropdown-divider" style="margin: 0;">
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('orders'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-bag me-2" style="color: #25D366;"></i>
             <span style="font-weight: 500;">My Orders</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('favorites'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-heart me-2" style="color: #dc3545;"></i>
             <span style="font-weight: 500;">Favorites</span>
           </a>
         </li>
         
         <li>
           <a class="dropdown-item d-flex align-items-center" href="#" onclick="navigateTo('address'); return false;" style="padding: 12px 16px;">
             <i class="bi bi-geo-alt me-2" style="color: #0d6efd;"></i>
             <span style="font-weight: 500;">Delivery Address</span>
           </a>
         </li>
         
         <li><hr class="dropdown-divider" style="margin: 0;"></li>
         
         <li>
           <button class="dropdown-item d-flex align-items-center" onclick="handleSignOut()" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
             <i class="bi bi-box-arrow-right me-2" style="color: #128C7E;"></i>
             <span style="color: #128C7E; font-weight: 500;">Sign Out</span>
           </button>
         </li>
       </ul>
     </div>
     
   </div>
   
 </div>
 
</div>
</div>
</nav>

<!-- ‚úÖ Sync Indicator -->
<div id="syncIndicator" class="sync-indicator" style="display: none;">
<i class="bi bi-arrow-repeat"></i> 
<span id="syncText">Syncing...</span>
</div>


<!-- ============================================
     REGISTER SHOP MODAL
     ============================================ -->
     <div class="modal fade" id="registerShopModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-shop me-2"></i>Register Your Shop
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <form id="registerShopForm">
              
              <!-- Shop Name -->
              <div class="mb-3">
                <label for="shopName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-shop me-2" style="color: #25D366;"></i>Shop Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="shopName" 
                  placeholder="e.g., ABC Tiles & Sanitaryware"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Owner Name -->
              <div class="mb-3">
                <label for="ownerName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-person me-2" style="color: #128C7E;"></i>Owner Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="ownerName" 
                  placeholder="e.g., Rajesh Kumar"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Mobile Number -->
              <div class="mb-3">
                <label for="shopMobile" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-phone me-2" style="color: #0d6efd;"></i>Mobile Number <span style="color: red;">*</span>
                </label>
                <input 
                  type="tel" 
                  class="form-control form-control-lg" 
                  id="shopMobile" 
                  placeholder="e.g., 9876543210"
                  required
                  pattern="[0-9]{10}"
                  maxlength="10"
                  style="border-radius: 10px;"
                >
                <small class="text-muted">Enter 10-digit mobile number</small>
              </div>
              
              <!-- Address -->
              <div class="mb-3">
                <label for="shopAddress" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-geo-alt me-2" style="color: #dc3545;"></i>Shop Address <span style="color: red;">*</span>
                </label>
                <textarea 
                  class="form-control" 
                  id="shopAddress" 
                  rows="3" 
                  placeholder="e.g., Shop No. 45, Urban Estate 2, Hisar"
                  required
                  style="border-radius: 10px;"
                ></textarea>
              </div>
              
            </form>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn" onclick="handleRegisterShop()" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-check-circle me-2"></i>Register Shop
            </button>
          </div>
          
        </div>
      </div>
    </div>
    


    
    



  <!-- Main Content -->
  <main class="main-content" style="padding: 20px 0; min-height: calc(100vh - 70px); background: #F8F9F8;">
    <div class="container">

      <!-- Welcome Banner -->
      <div class="card mb-4" style="border: none; border-radius: 15px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white;">
        <div class="card-body p-4">
          <h2 class="mb-2" style="color: white; font-weight: 700;">
            <i class="bi bi-emoji-smile"></i> Welcome to Urban Estate 2 Shop!
          </h2>
          <p class="mb-0" style="opacity: 0.95;">Order from your favorite local shops, delivered to your doorstep.</p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-shop" style="font-size: 2rem; color: #25D366;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">12</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Active Shops</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-box-seam" style="font-size: 2rem; color: #128C7E;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">450+</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Products</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-truck" style="font-size: 2rem; color: #0d6efd;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">Fast</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Delivery</p>
            </div>
          </div>
        </div>

        <div class="col-md-3 col-6">
          <div class="card text-center" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
            <div class="card-body">
              <i class="bi bi-shield-check" style="font-size: 2rem; color: #198754;"></i>
              <h3 class="mt-2 mb-0" style="font-size: 1.5rem; font-weight: 700; color: #333;">100%</h3>
              <p class="text-muted mb-0" style="font-size: 0.85rem;">Secure</p>
            </div>
          </div>
        </div>
      </div>

   <!-- Featured Products Section (UPDATED - Dynamic Loading) -->
<div class="mb-4" id="featuredProductsSection">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 style="font-weight: 700; color: #333; margin: 0;">
      <i class="bi bi-star-fill me-2" style="color: #ffc107;"></i>
      Featured Products
    </h3>
    <a href="#" onclick="scrollToShops(); return false;" class="text-decoration-none" style="color: #25D366; font-weight: 600; font-size: 0.9rem;">
      View All Shops <i class="bi bi-arrow-right"></i>
    </a>
  </div>

  <!-- Loading State -->
  <div id="featuredProductsLoading" class="text-center py-5">
    <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading featured products...</p>
  </div>

  <!-- Products Container (Will be populated dynamically) -->
  <div class="row g-3" id="featuredProductsContainer" style="display: none;">
    <!-- Products will be rendered here by JavaScript -->
  </div>

  <!-- Empty State (if no products found) -->
  <div id="featuredProductsEmpty" class="text-center py-5" style="display: none;">
    <i class="bi bi-box-seam" style="font-size: 4rem; color: #ccc;"></i>
    <h5 class="mt-3 text-muted">No products available yet</h5>
    <p class="text-muted">Check back soon for featured products from local shops!</p>
  </div>
</div>

<!-- Development Notice (UPDATED) -->
<div class="alert alert-success mt-4" role="alert" style="border-radius: 12px; border: none; border-left: 4px solid #25D366;">
  <i class="bi bi-check-circle me-2"></i>
  <strong>Live Shopping:</strong> Browse products from local shops, add to cart, and place orders for delivery in Urban Estate 2!
</div>

</div>
</main>

</div>


<!-- ============================================
     SHOP PRODUCTS PAGE
     ============================================ -->
     <div class="page-view" id="shopProductsPage" style="display: none;">
  
      <!-- Header -->
<div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <button class="btn btn-light" onclick="goBackHome()" style="border-radius: 10px; font-weight: 600;">
    <i class="bi bi-arrow-left me-2"></i>Back
  </button>
  <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
    <i class="bi bi-shop me-2"></i><span id="shopProductsPageTitle">Shop Products</span>
  </h3>
  <!-- ‚úÖ NEW: Add Products Button (Shopowners Only) -->
  <button id="addProductsBtn" class="btn btn-light" onclick="openAddProductsModal()" style="border-radius: 10px; font-weight: 600; display: none;">
    <i class="bi bi-plus-lg me-2"></i>Add Products
  </button>
  <div id="headerSpacer" style="width: 80px;"></div> <!-- Spacer for centering -->
</div>

      
      <!-- Shop Info Card -->
      <div class="container-fluid" style="padding: 20px;">
        <div id="shopInfoCard" class="card mb-4" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
          <!-- Shop info will be dynamically inserted here -->
        </div>
        
        <!-- Search Box -->
        <div class="mb-3">
          <input 
            type="text" 
            class="form-control form-control-lg" 
            id="searchShopProductsInput" 
            placeholder="üîç Search products..." 
            onkeyup="filterShopProducts(this.value)"
            style="border-radius: 10px; max-width: 600px; margin: 0 auto; display: block;"
          >
        </div>
        
        <!-- Products Grid -->
        <div id="shopProductsGrid" class="row g-3">
          <!-- Products will be rendered here -->
          <div class="col-12" style="text-align: center; padding: 40px;">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-3">Loading products...</p>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="shopProductsEmptyState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-box-seam" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">No Products Yet</h4>
          <p class="text-muted">This shop hasn't added any products yet.</p>
        </div>
      </div>
      
    </div>

    <!-- ============================================
     ADD PRODUCTS MODAL (FOR SHOPOWNERS)
     ============================================ -->
<div class="modal fade" id="addProductsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
        <h5 class="modal-title" style="font-weight: 700;">
          <i class="bi bi-plus-circle me-2"></i>Add Multiple Products
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-4">
        
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter product names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each product, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="productInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., Ceramic Tiles, Wall Tiles, Floor Tiles..."
          onkeydown="handleProductInputKeydown(event)"
          oninput="window.lastProductInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-success w-100"
          onclick="addProductToList()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="productsPreviewCount">
            üìù Products to Save (0):
          </p>
          <div id="productsPreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No products added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border: none; padding: 20px;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
        <button type="button" class="btn btn-success" onclick="saveAllProducts()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
          <i class="bi bi-check-circle me-2"></i>Save All Products
        </button>
      </div>
      
    </div>
  </div>
</div>

<!-- ============================================
     CART PAGE (FOR CUSTOMERS)
     ============================================ -->
     <div class="page-view" id="cartPage" style="display: none;">
  
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <button class="btn btn-light" onclick="goBackFromCart()" style="border-radius: 10px; font-weight: 600;">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <h3 style="margin: 0; font-weight: 700; flex: 1; text-align: center;">
          <i class="bi bi-cart me-2"></i>Shopping Cart
        </h3>
        <div style="width: 80px;"></div> <!-- Spacer -->
      </div>
      
      <!-- Cart Content -->
      <div class="container-fluid" style="padding: 20px; padding-bottom: 100px;">
        
        <!-- Shop Info Card (Shows which shop items are from) -->
        <div id="cartShopInfo" class="card mb-4" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none;">
          <!-- Will be populated dynamically -->
        </div>
        
        <!-- Cart Items List -->
        <div id="cartItemsList" class="mb-4">
          <!-- Cart items will be rendered here -->
        </div>
        
        <!-- Empty Cart State -->
        <div id="emptyCartState" style="display: none; text-align: center; padding: 60px 20px;">
          <i class="bi bi-cart-x" style="font-size: 64px; color: #ccc;"></i>
          <h4 style="margin-top: 20px;">Your cart is empty</h4>
          <p class="text-muted">Add products from shops to get started!</p>
          <button class="btn btn-success mt-3" onclick="goBackHome()" style="border-radius: 10px; padding: 10px 24px;">
            <i class="bi bi-shop me-2"></i>Browse Shops
          </button>
        </div>
        
        <!-- Cart Summary Card -->
        <div id="cartSummary" class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: none;">
          <div class="card-body">
            <h5 style="font-weight: 700; margin-bottom: 20px;">Price Details</h5>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <span>Price (<span id="summaryItemCount">0</span> items)</span>
              <span id="summarySubtotal">‚Çπ0</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
              <span>Delivery Charges</span>
              <span id="summaryDelivery" style="color: #25D366;">FREE</span>
            </div>
            
            <hr>
            
            <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700;">
              <span>Total Amount</span>
              <span style="color: #25D366;" id="summaryTotal">‚Çπ0</span>
            </div>
            
            <!-- Proceed to Checkout Button -->
<button 
onclick="proceedToCheckout()" 
class="btn btn-success btn-lg w-100 mt-3" 
style="border-radius: 10px; font-weight: 700; padding: 15px; font-size: 1.1rem;">
<i class="bi bi-credit-card me-2"></i>Proceed to Checkout
</button>

          </div>
        </div>
        
      </div>
      
    </div>



<!-- ============================================
     ORDERS RECEIVED PAGE (SHOPOWNERS ONLY)
     ============================================ -->
     <div class="page-view" id="ordersReceivedPage" style="display: none;">
  
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 20px; text-align: center;">
        <h3 style="margin: 0; font-weight: 700;">
          <i class="bi bi-inbox-fill me-2"></i>Orders Received
        </h3>
        <p style="margin: 5px 0 0 0; font-size: 0.85rem; opacity: 0.9;">Manage customer orders</p>
      </div>
      
      <!-- Order Stats -->
      <div class="container-fluid" style="padding: 15px;">
        <div class="row g-2">
          <div class="col-4">
            <div class="card text-center" style="border-radius: 10px; border: none; background: #fff3cd;">
              <div class="card-body" style="padding: 10px;">
                <i class="bi bi-clock-history text-warning" style="font-size: 1.5rem;"></i>
                <h4 class="mt-1 mb-0" id="shopPendingCount">0</h4>
                <small style="font-size: 0.7rem;">Pending</small>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card text-center" style="border-radius: 10px; border: none; background: #d1ecf1;">
              <div class="card-body" style="padding: 10px;">
                <i class="bi bi-check-circle text-info" style="font-size: 1.5rem;"></i>
                <h4 class="mt-1 mb-0" id="shopAcceptedCount">0</h4>
                <small style="font-size: 0.7rem;">Accepted</small>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="card text-center" style="border-radius: 10px; border: none; background: #d4edda;">
              <div class="card-body" style="padding: 10px;">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 1.5rem;"></i>
                <h4 class="mt-1 mb-0" id="shopDeliveredCount">0</h4>
                <small style="font-size: 0.7rem;">Delivered</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filter Buttons -->
      <div class="container-fluid" style="padding: 0 15px 15px 15px;">
        <div class="d-flex gap-2" style="overflow-x: auto; white-space: nowrap; padding-bottom: 5px;">
          <button class="btn btn-sm btn-success" onclick="filterShopOrders('all')" style="border-radius: 20px;">All</button>
          <button class="btn btn-sm btn-outline-warning" onclick="filterShopOrders('pending')" style="border-radius: 20px;">Pending</button>
          <button class="btn btn-sm btn-outline-info" onclick="filterShopOrders('accepted')" style="border-radius: 20px;">Accepted</button>
          <button class="btn btn-sm btn-outline-success" onclick="filterShopOrders('delivered')" style="border-radius: 20px;">Delivered</button>
        </div>
      </div>
      
      <!-- Orders List -->
      <div class="container-fluid" style="padding: 0 15px 80px 15px;">
        <div id="shopOrdersList">
          <!-- Orders will be rendered here -->
          <div style="text-align:center; padding:40px;">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-3">Loading orders...</p>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div id="shopOrdersEmptyState" style="display:none; text-align:center; padding:60px 20px;">
        <i class="bi bi-inbox" style="font-size:64px; color:#ccc;"></i>
        <h4 style="margin-top:20px;">No Orders Yet</h4>
        <p>You'll see customer orders here when they place orders from your shops.</p>
      </div>
      
    </div>
    




    <!-- ============================================
     MOBILE SETTINGS PAGE (PLACEHOLDER)
     ============================================ -->
<div class="page-view" id="mobileSettingsPage" style="display: none;">
  
  <!-- Header -->
  <div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 20px; text-align: center;">
    <h3 style="margin: 0; font-weight: 700;">
      <i class="bi bi-gear-fill me-2"></i>Settings
    </h3>
  </div>
  
  <!-- Content -->
  <div class="container-fluid" style="padding: 20px; text-align: center; padding-top: 60px;">
    <i class="bi bi-gear" style="font-size: 80px; color: #ccc;"></i>
    <h4 style="margin-top: 20px; color: #333;">Settings Coming Soon</h4>
    <p class="text-muted">We're working on an amazing settings page for you!</p>
    
    <div style="margin-top: 40px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
      <h6 style="font-weight: 700; margin-bottom: 15px;">Upcoming Features:</h6>
      <ul style="list-style: none; padding: 0;">
        <li style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
          <i class="bi bi-person-circle me-2" style="color: #25D366;"></i>Profile Management
        </li>
        <li style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
          <i class="bi bi-geo-alt me-2" style="color: #25D366;"></i>Delivery Addresses
        </li>
        <li style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
          <i class="bi bi-bell me-2" style="color: #25D366;"></i>Notifications
        </li>
        <li style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;">
          <i class="bi bi-shield-check me-2" style="color: #25D366;"></i>Privacy & Security
        </li>
      </ul>
    </div>
  </div>
  
</div>


<!-- ============================================
     MOBILE BOTTOM NAVIGATION (SHOPOWNERS ONLY)
     ============================================ -->
     <div id="mobileBottomNavShopowner" class="mobile-bottom-nav" style="display: none;">
  
      <!-- Home Tab -->
      <div class="nav-tab active" onclick="switchShopownerMobileTab('home')" data-tab="home">
        <i class="bi bi-house-door-fill"></i>
        <span>Home</span>
      </div>
      
      <!-- Orders Received Tab -->
      <div class="nav-tab" onclick="switchShopownerMobileTab('orders-received')" data-tab="orders-received">
        <div style="position: relative;">
          <i class="bi bi-inbox-fill"></i>
          <!-- Orders Badge -->
          <span id="mobileOrdersBadge" class="mobile-cart-badge" style="display: none;">0</span>
        </div>
        <span>Orders</span>
      </div>
      
      <!-- Settings Tab -->
      <div class="nav-tab" onclick="switchShopownerMobileTab('settings')" data-tab="settings">
        <i class="bi bi-gear-fill"></i>
        <span>Settings</span>
      </div>
      
    </div>
    




    <!-- ============================================
     MINI-CART FOOTER (PERSISTENT)
     ============================================ -->
<div id="miniCartFooter" style="
position: fixed;
bottom: 0;
left: 0;
right: 0;
background: white;
box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
padding: 12px 20px;
display: none;
z-index: 9999;
cursor: pointer;
transition: transform 0.3s ease;
" onclick="navigateToCart()">

<div style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto;">
  
  <!-- Left: Item Count & Preview -->
  <div style="flex: 1;">
    <div style="font-weight: 700; font-size: 1rem; color: #333;">
      <i class="bi bi-cart3"></i> <span id="miniCartCount">0</span> Item(s)
    </div>
    <div style="font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="miniCartPreview">
      <!-- Product names preview -->
    </div>
  </div>
  
  <!-- Right: Total & CTA -->
  <div style="display: flex; align-items: center; gap: 20px;">
    <div style="text-align: right;">
      <div style="font-size: 0.85rem; color: #666;">Total</div>
      <div style="font-weight: 700; font-size: 1.2rem; color: #25D366;" id="miniCartTotal">‚Çπ0</div>
    </div>
    <button class="btn btn-success" style="border-radius: 10px; padding: 10px 20px; font-weight: 600; white-space: nowrap;">
      View Cart <i class="bi bi-arrow-right ms-1"></i>
    </button>
  </div>
  
</div>

</div>

<!-- ‚úÖ NEW: Spacer to prevent content from being hidden behind cart -->
<div id="miniCartSpacer" style="height: 80px; display: none;"></div>


<!-- ============================================
     SHOP CONFLICT MODAL
     ============================================ -->
     <div class="modal fade" id="shopConflictModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-exclamation-triangle me-2"></i>Different Shop Detected
            </h5>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <p style="font-size: 1rem; margin-bottom: 20px;">
              Your cart contains items from <strong id="currentShopName">Shop A</strong>.
            </p>
            <p style="font-size: 1rem; margin-bottom: 20px;">
              You're trying to add an item from <strong id="newShopName">Shop B</strong>.
            </p>
            <div class="alert alert-warning" style="border-radius: 10px;">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Note:</strong> You can only order from one shop at a time. Do you want to replace your current cart?
            </div>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" onclick="closeShopConflictModal()" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmReplaceCart()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-arrow-repeat me-2"></i>Replace Cart
            </button>
          </div>
          
        </div>
      </div>
    </div>
    
<!-- ============================================
     EDIT PRODUCT MODAL (SHOPOWNERS ONLY)
     ============================================ -->
     <div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-pencil-square me-2"></i>Edit Product
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            <form id="editProductForm">
              
              <!-- Hidden Product ID -->
              <input type="hidden" id="editProductId">
              
              <!-- Product Name -->
              <div class="mb-3">
                <label for="editProductName" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-box-seam me-2" style="color: #1976d2;"></i>Product Name <span style="color: red;">*</span>
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductName" 
                  placeholder="e.g., Ceramic Tiles"
                  required
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Price -->
              <div class="mb-3">
                <label for="editProductPrice" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-currency-rupee me-2" style="color: #25D366;"></i>Price (‚Çπ) <span style="color: red;">*</span>
                </label>
                <input 
                  type="number" 
                  class="form-control form-control-lg" 
                  id="editProductPrice" 
                  placeholder="e.g., 499"
                  required
                  min="0"
                  step="0.01"
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Stock -->
              <div class="mb-3">
                <label for="editProductStock" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-boxes me-2" style="color: #ff9800;"></i>Stock Quantity <span style="color: red;">*</span>
                </label>
                <div class="input-group" style="border-radius: 10px; overflow: hidden;">
                  <button 
                    type="button" 
                    class="btn btn-outline-danger" 
                    onclick="adjustEditStock(-1)"
                    style="border-radius: 10px 0 0 10px; padding: 0 20px;">
                    <i class="bi bi-dash-lg"></i>
                  </button>
                  <input 
                    type="number" 
                    class="form-control form-control-lg text-center" 
                    id="editProductStock" 
                    placeholder="0"
                    required
                    min="0"
                    style="border: 1px solid #dee2e6; font-weight: 600; font-size: 1.2rem;"
                  >
                  <button 
                    type="button" 
                    class="btn btn-outline-success" 
                    onclick="adjustEditStock(1)"
                    style="border-radius: 0 10px 10px 0; padding: 0 20px;">
                    <i class="bi bi-plus-lg"></i>
                  </button>
                </div>
                <small class="text-muted">Use - and + buttons or type directly</small>
              </div>
              
              <!-- Brand (Optional) -->
              <div class="mb-3">
                <label for="editProductBrand" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-tag me-2" style="color: #9c27b0;"></i>Brand (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductBrand" 
                  placeholder="e.g., Samsung"
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Size (Optional) -->
              <div class="mb-3">
                <label for="editProductSize" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-rulers me-2" style="color: #f44336;"></i>Size (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductSize" 
                  placeholder="e.g., 2x2 ft"
                  style="border-radius: 10px;"
                >
              </div>
              
              <!-- Category (Optional) -->
              <div class="mb-3">
                <label for="editProductCategory" class="form-label" style="font-weight: 600; color: #333;">
                  <i class="bi bi-folder me-2" style="color: #ff5722;"></i>Category (Optional)
                </label>
                <input 
                  type="text" 
                  class="form-control form-control-lg" 
                  id="editProductCategory" 
                  placeholder="e.g., Floor Tiles"
                  style="border-radius: 10px;"
                >
              </div>
              
            </form>
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="saveEditedProduct()" style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
              <i class="bi bi-check-circle me-2"></i>Save Changes
            </button>
          </div>
          
        </div>
      </div>
    </div>
    
<!-- ============================================
     CHECKOUT MODAL (CUSTOMERS ONLY) - UPDATED WITH SAVED ADDRESS
     ============================================ -->
     <div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false" style="z-index: 10000;">
      <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content" style="border-radius: 15px; border: none; overflow: hidden;">
          
          <!-- Modal Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
            <h5 class="modal-title" style="font-weight: 700;">
              <i class="bi bi-credit-card me-2"></i>Checkout
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body p-4">
            
            <!-- ==================== DELIVERY ADDRESS SECTION (UPDATED) ==================== -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 style="font-weight: 700; margin: 0; color: #333;">
                  <i class="bi bi-geo-alt text-danger me-2"></i>Delivery Address
                </h6>
                <button 
                  type="button" 
                  class="btn btn-sm btn-outline-primary" 
                  onclick="openDeliveryAddressModal()"
                  style="border-radius: 6px; font-weight: 600;">
                  <i class="bi bi-pencil me-1"></i>Edit
                </button>
              </div>
              
              <!-- Saved Address Display -->
              <div id="checkoutSavedAddress" class="card" style="border: 2px solid #0d6efd; border-radius: 10px; display: none;">
                <div class="card-body">
                  <div class="d-flex align-items-start">
                    <i class="bi bi-geo-alt-fill text-danger me-3" style="font-size: 1.5rem;"></i>
                    <div style="flex: 1;">
                      <p style="margin: 0; font-weight: 600; font-size: 1rem;" id="savedAddressName">Loading...</p>
                      <p style="margin: 5px 0; color: #666;" id="savedAddressDetails">Loading address...</p>
                      <p style="margin: 5px 0; color: #666;">
                        <i class="bi bi-phone me-1"></i>
                        <span id="savedAddressPhone">Loading...</span>
                      </p>
                    </div>
                    <span class="badge bg-success" style="height: fit-content;">
                      <i class="bi bi-check-circle me-1"></i>Saved
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- No Address State -->
              <div id="checkoutNoAddress" class="alert alert-warning" style="border-radius: 10px; display: none;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>No delivery address saved.</strong>
                <br>
                <small>Click the "Edit" button above to add your delivery address.</small>
              </div>
              
              <!-- Urban Estate 2 Notice -->
              <div class="alert alert-info mt-3" style="border-radius: 10px; font-size: 0.9rem;">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Delivery Area:</strong> We currently deliver only within <strong>Urban Estate 2, Hisar</strong>
              </div>
              
            </div>
            
            <hr>
            
            <!-- ==================== ORDER SUMMARY SECTION ==================== -->
            <div class="mb-4">
              <h6 style="font-weight: 700; margin-bottom: 15px; color: #333;">
                <i class="bi bi-receipt text-success me-2"></i>Order Summary
              </h6>
              
              <!-- Cart Items -->
              <div class="card mb-3" style="border: 1px solid #e0e0e0; border-radius: 10px;">
                <div class="card-body">
                  <div id="checkoutItemsList">
                    <!-- Will be populated by JavaScript -->
                  </div>
                </div>
              </div>
              
              <!-- Price Breakdown -->
              <div class="card" style="border: 1px solid #e0e0e0; border-radius: 10px;">
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2">
                    <span style="color: #666;">Subtotal (<span id="checkoutItemCount">0</span> items)</span>
                    <span style="font-weight: 600;">‚Çπ<span id="checkoutSubtotal">0</span></span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span style="color: #666;">Delivery Fee</span>
                    <span style="color: #25D366; font-weight: 600;">FREE</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span style="color: #666;">Tax (GST)</span>
                    <span style="font-weight: 600;">‚Çπ0</span>
                  </div>
                  <hr style="margin: 10px 0;">
                  <div class="d-flex justify-content-between">
                    <span style="font-size: 1.1rem; font-weight: 700; color: #333;">Total Amount</span>
                    <span style="font-size: 1.3rem; font-weight: 700; color: #25D366;">‚Çπ<span id="checkoutTotal">0</span></span>
                  </div>
                </div>
              </div>
            </div>
            
            <hr>
            
            <!-- ==================== PAYMENT METHOD SECTION ==================== -->
            <div class="mb-3">
              <h6 style="font-weight: 700; margin-bottom: 15px; color: #333;">
                <i class="bi bi-cash-coin text-warning me-2"></i>Payment Method
              </h6>
              
              <div class="alert alert-warning" style="border-radius: 10px; border-left: 4px solid #ffc107;">
                <div class="d-flex align-items-center">
                  <i class="bi bi-cash-stack" style="font-size: 2rem; margin-right: 15px;"></i>
                  <div>
                    <strong>Cash on Delivery (COD)</strong><br>
                    <small>Pay when you receive your order</small>
                  </div>
                </div>
              </div>
              
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Currently, only Cash on Delivery is available. Online payment options coming soon!
              </small>
            </div>
            
          </div>
          
          <!-- Modal Footer -->
          <div class="modal-footer" style="border: none; padding: 20px; background: #f8f9fa;">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px; padding: 10px 24px;">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </button>
            <button type="button" class="btn btn-success" onclick="confirmCheckoutOrder()" id="confirmOrderBtn" style="border-radius: 8px; padding: 10px 30px; font-weight: 700; font-size: 1.1rem;">
              <i class="bi bi-check-circle me-2"></i>Confirm Order
            </button>
          </div>
          
        </div>
      </div>
    </div>
    










<!-- ============================================
     MY ORDERS PAGE (CUSTOMERS ONLY)
     ============================================ -->
     <div class="page-view" id="myOrdersPage">
  
      <!-- Header -->
      <div class="page-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <button class="back-btn" onclick="goBackFromOrders()" style="background: rgba(255,255,255,0.2); border: none; color: white;">
          <i class="bi bi-arrow-left"></i> Back
        </button>
        <h3 style="margin: 0; font-weight: 700;">
          <i class="bi bi-bag-check"></i> My Orders
        </h3>
        <div style="width: 40px;"></div>
      </div>
      
      <!-- Order Statistics -->
      <div id="orderStats" class="container-fluid" style="padding: 20px; display: none;">
        <div class="row g-3">
          <div class="col-6 col-md-3">
            <div class="card text-center" style="border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-body">
                <i class="bi bi-bag-fill text-primary" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="totalOrdersCount">0</h3>
                <small class="text-muted">Total Orders</small>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center" style="border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-body">
                <i class="bi bi-clock-history text-warning" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="pendingOrdersCount">0</h3>
                <small class="text-muted">Pending</small>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center" style="border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-body">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="deliveredOrdersCount">0</h3>
                <small class="text-muted">Delivered</small>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-3">
            <div class="card text-center" style="border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <div class="card-body">
                <i class="bi bi-currency-rupee text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0" id="totalSpentAmount">‚Çπ0</h3>
                <small class="text-muted">Total Spent</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Filters & Search -->
      <div class="container-fluid" style="padding: 20px; padding-bottom: 10px;">
        
        <!-- Search Box -->
        <input 
          type="text" 
          class="form-control mb-3" 
          id="searchOrdersInput" 
          placeholder="üîç Search orders (Order ID, shop name, items...)" 
          onkeyup="searchOrders(this.value)"
          style="border-radius: 10px; padding: 12px;"
        >
        
        <!-- Filter Buttons -->
        <div class="d-flex gap-2 mb-3" style="overflow-x: auto; white-space: nowrap; padding-bottom: 10px;">
          <button class="order-filter-btn active" data-status="all" onclick="filterOrdersByStatus('all')" style="border-radius: 20px; padding: 8px 20px; border: 2px solid #25D366; background: #25D366; color: white; font-weight: 600; flex-shrink: 0;">
            All Orders
          </button>
          <button class="order-filter-btn" data-status="pending" onclick="filterOrdersByStatus('pending')" style="border-radius: 20px; padding: 8px 20px; border: 2px solid #ffc107; background: white; color: #ffc107; font-weight: 600; flex-shrink: 0;">
            Pending
          </button>
          <button class="order-filter-btn" data-status="accepted" onclick="filterOrdersByStatus('accepted')" style="border-radius: 20px; padding: 8px 20px; border: 2px solid #17a2b8; background: white; color: #17a2b8; font-weight: 600; flex-shrink: 0;">
            Accepted
          </button>
          <button class="order-filter-btn" data-status="delivered" onclick="filterOrdersByStatus('delivered')" style="border-radius: 20px; padding: 8px 20px; border: 2px solid #28a745; background: white; color: #28a745; font-weight: 600; flex-shrink: 0;">
            Delivered
          </button>
          <button class="order-filter-btn" data-status="cancelled" onclick="filterOrdersByStatus('cancelled')" style="border-radius: 20px; padding: 8px 20px; border: 2px solid #dc3545; background: white; color: #dc3545; font-weight: 600; flex-shrink: 0;">
            Cancelled
          </button>
        </div>
        
        <!-- Sort Dropdown -->
        <div class="mb-3">
          <select class="form-select" onchange="sortOrders(this.value)" style="border-radius: 10px; padding: 10px; max-width: 250px;">
            <option value="newest">Sort: Newest First</option>
            <option value="oldest">Sort: Oldest First</option>
            <option value="highest">Sort: Highest Amount</option>
            <option value="lowest">Sort: Lowest Amount</option>
          </select>
        </div>
        
      </div>
      
      <!-- Orders List Container -->
      <div class="container-fluid" style="padding: 0 20px 20px 20px;">
        <div id="ordersListContainer">
          <!-- Orders will be rendered here by JavaScript -->
          <div style="text-align:center; padding:40px;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading your orders...</p>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div id="ordersEmptyState" style="display:none; text-align:center; padding:60px 20px;">
        <i class="bi bi-bag-x" style="font-size:64px; color:#ccc;"></i>
        <h4 style="margin-top:20px;">No Orders Yet</h4>
        <p>Start shopping from local shops in Urban Estate 2!</p>
        <button class="btn btn-success mt-3" onclick="goBackFromOrders()">
          <i class="bi bi-shop"></i> Browse Shops
        </button>
      </div>
      
    </div>
    
   <!-- ============================================
     ORDER DETAILS MODAL (SHOPOWNERS)
     ============================================ -->
<div class="modal fade" id="shopOrderDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable" style="max-width: 500px;">
    <div class="modal-content" style="border-radius: 12px; border: none;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;">
        <h5 class="modal-title" style="font-weight: 700;">
          <i class="bi bi-receipt-cutoff"></i> Order Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body" id="shopOrderDetailsBody" style="padding: 0;">
        <!-- Content will be populated here -->
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border-top: 1px solid #eee; padding: 15px;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">
          <i class="bi bi-x-circle"></i> Close
        </button>
        <button type="button" class="btn btn-success" onclick="updateOrderStatus()" style="border-radius: 8px;">
          <i class="bi bi-check-circle"></i> Update Status
        </button>
      </div>
      
    </div>
  </div>
</div>


    <!-- ============================================
     DELIVERY ADDRESS MODAL
     ============================================ -->
<div class="modal fade" id="deliveryAddressModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none;">
      
      <!-- Modal Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: white; border: none; border-radius: 15px 15px 0 0;">
        <h5 class="modal-title" style="font-weight: 700;">
          <i class="bi bi-geo-alt me-2"></i>Delivery Address
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body p-4">
        
        <!-- Info Alert -->
        <div class="alert alert-info" style="border-radius: 10px; border-left: 4px solid #0d6efd;">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Delivery Area:</strong> Urban Estate 2, Hisar
        </div>
        
        <form id="deliveryAddressForm">
          
          <!-- Full Name -->
          <div class="mb-3">
            <label for="addressName" class="form-label" style="font-weight: 600;">
              <i class="bi bi-person me-1"></i>Full Name <span class="text-danger">*</span>
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="addressName" 
              placeholder="Enter your full name"
              required
              style="border-radius: 8px; padding: 12px;">
          </div>
          
          <!-- Phone Number -->
          <div class="mb-3">
            <label for="addressPhone" class="form-label" style="font-weight: 600;">
              <i class="bi bi-phone me-1"></i>Phone Number <span class="text-danger">*</span>
            </label>
            <input 
              type="tel" 
              class="form-control" 
              id="addressPhone" 
              placeholder="10-digit mobile number"
              required
              pattern="[0-9]{10}"
              maxlength="10"
              style="border-radius: 8px; padding: 12px;">
            <small class="text-muted">Example: 9876543210</small>
          </div>
          
          <!-- House/Flat Number -->
          <div class="mb-3">
            <label for="addressHouse" class="form-label" style="font-weight: 600;">
              <i class="bi bi-house me-1"></i>House/Flat Number <span class="text-danger">*</span>
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="addressHouse" 
              placeholder="e.g., House No. 123, Block A"
              required
              style="border-radius: 8px; padding: 12px;">
          </div>
          
          <!-- Area/Locality (Pre-filled, Read-only) -->
          <div class="mb-3">
            <label for="addressArea" class="form-label" style="font-weight: 600;">
              <i class="bi bi-map me-1"></i>Area/Locality
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="addressArea" 
              value="Urban Estate 2, Hisar"
              readonly
              style="border-radius: 8px; padding: 12px; background-color: #e9ecef;">
            <small class="text-success">
              <i class="bi bi-check-circle"></i> Fixed delivery area
            </small>
          </div>
          
          <!-- Landmark (Optional) -->
          <div class="mb-3">
            <label for="addressLandmark" class="form-label" style="font-weight: 600;">
              <i class="bi bi-signpost me-1"></i>Landmark (Optional)
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="addressLandmark" 
              placeholder="e.g., Near Park, Behind Market"
              style="border-radius: 8px; padding: 12px;">
          </div>
          
        </form>
        
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border: none; padding: 20px; background: #f8f9fa;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px; padding: 10px 24px;">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveDeliveryAddress()" style="border-radius: 8px; padding: 10px 24px; font-weight: 600;">
          <i class="bi bi-check-circle me-2"></i>Save Address
        </button>
      </div>
      
    </div>
  </div>
</div>


<!-- ============================================
     MOBILE BOTTOM NAVIGATION (CUSTOMERS ONLY)
     ============================================ -->
     <div id="mobileBottomNav" class="mobile-bottom-nav" style="display: none;">
  
      <!-- Home Tab -->
      <div class="nav-tab active" onclick="switchMobileTab('home')" data-tab="home">
        <i class="bi bi-house-door-fill"></i>
        <span>Home</span>
      </div>
      
      <!-- Orders Tab -->
      <div class="nav-tab" onclick="switchMobileTab('orders')" data-tab="orders">
        <i class="bi bi-bag-fill"></i>
        <span>Orders</span>
      </div>
      
      <!-- Cart Tab -->
      <div class="nav-tab" onclick="switchMobileTab('cart')" data-tab="cart">
        <div style="position: relative;">
          <i class="bi bi-cart-fill"></i>
          <!-- Cart Badge -->
          <span id="mobileCartBadge" class="mobile-cart-badge" style="display: none;">0</span>
        </div>
        <span>Cart</span>
      </div>
      
      <!-- Settings Tab -->
      <div class="nav-tab" onclick="switchMobileTab('settings')" data-tab="settings">
        <i class="bi bi-gear-fill"></i>
        <span>Settings</span>
      </div>
      
    </div>
    




    <!-- Customer Module -->
<script src="customer.js"></script>

<!-- ============================================
     JAVASCRIPT
     ============================================ -->
<script>

function skipLogin() {
  console.log('‚è≠Ô∏è Skipping login - Guest mode');

  // Set temporary guest user
  window.currentUser = {
    email: 'guest@ue2shop.local',
    uid: 'guest_' + Date.now(),
    displayName: 'Guest User',
    photoURL: null,
    role: 'guest',  // ‚úÖ Add guest role
    isGuest: true
  };

  // Hide auth screen and show app
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  // Update UI
  if (typeof window.updateUserInfo === 'function') {
    window.updateUserInfo();
  }

  // Show notification
  setTimeout(() => {
    alert('‚ö†Ô∏è Guest Mode: You are browsing without authentication.\n\nSign in with Google or Email to place orders.');
  }, 500);
}


/**
 * Handle Google Sign-In (FOR CUSTOMERS)
 */
async function handleGoogleSignIn() {
  const googleSignInBtn = document.getElementById('googleSignInBtn');

  if (googleSignInBtn) {
    googleSignInBtn.disabled = true;
    googleSignInBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }

  try {
    console.log('üîê Starting Google Sign-In...');

    const { signInWithPopup, GoogleAuthProvider } = window.firebaseImports;
    const provider = new GoogleAuthProvider();

    provider.setCustomParameters({
      prompt: 'select_account'
    });

    const result = await signInWithPopup(window.auth, provider);
    const user = result.user;

    console.log('‚úÖ Google Sign-In successful!', user.email);

  } catch (error) {
    console.error('‚ùå Google Sign-In error:', error);

    let errorMessage = 'Google Sign-In failed. Please try again.';

    if (error.code === 'auth/popup-closed-by-user') {
      errorMessage = 'Sign-in cancelled. Please try again.';
    } else if (error.code === 'auth/popup-blocked') {
      errorMessage = 'Pop-up blocked. Please enable pop-ups for this site.';
    } else if (error.code === 'auth/cancelled-popup-request') {
      errorMessage = 'Only one sign-in at a time please.';
    } else if (error.code === 'auth/network-request-failed') {
      errorMessage = 'Network error. Check your internet connection.';
    }

    alert(errorMessage);

    if (googleSignInBtn) {
      googleSignInBtn.disabled = false;
      googleSignInBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 18 18" class="google-icon"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/><path fill="#FBBC05" d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/></svg><span class="btn-text">Continue with Google</span>';
    }
  }
}

/**
 * Handle Email/Password Sign-In (FOR AUTHORIZED SHOPOWNERS ONLY)
 */
 async function handleEmailPasswordAuth(event) {
  event.preventDefault();

  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const loginButton = document.getElementById('loginButton');

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  if (!window.isAuthorizedShopowner(email)) {
    alert('‚ùå Unauthorized! This email is not registered as a shopowner.\n\nCustomers should use Google Sign-In.');
    return;
  }

  if (loginButton) {
    loginButton.disabled = true;
    loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }

  try {
    console.log('üîê Starting Email/Password Sign-In for:', email);

    const { signInWithEmailAndPassword, doc, setDoc } = window.firebaseImports;
    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
    const user = userCredential.user;

    console.log('‚úÖ Email/Password Sign-In successful!', user.email);

    // ‚úÖ UPDATE: Set role as shopowner in Firestore
    try {
      const userDocRef = doc(window.db, 'users', user.uid);
      await setDoc(userDocRef, {
        email: user.email,
        displayName: user.displayName || user.email.split('@')[0],
        lastLogin: new Date().toISOString(),
        role: 'shopowner',  // ‚úÖ Email sign-in = shopowner
        location: 'Urban Estate 2, Hisar'
      }, { merge: true });
      
      console.log('‚úÖ Role updated to shopowner in Firestore');
      
      // ‚úÖ Update window.currentUser with role
      if (window.currentUser) {
        window.currentUser.role = 'shopowner';
      }
      
    } catch (firestoreError) {
      console.error('‚ö†Ô∏è Error updating Firestore:', firestoreError);
      // Continue anyway - auth was successful
    }

  } catch (error) {
    console.error('‚ùå Email/Password Sign-In error:', error);

    let errorMessage = 'Sign-in failed. Please try again.';

    if (error.code === 'auth/user-not-found') {
      errorMessage = 'No account found with this email. Please contact admin.';
    } else if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect password. Please try again.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email format.';
    } else if (error.code === 'auth/user-disabled') {
      errorMessage = 'This account has been disabled. Contact admin.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/invalid-credential') {
      errorMessage = 'Invalid email or password. Please try again.';
    }

    alert(errorMessage);

    if (loginButton) {
      loginButton.disabled = false;
      loginButton.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In with Email';
    }
  }
}


/**
 * Toggle Password Visibility
 */
function togglePasswordVisibility() {
  const passwordInput = document.getElementById('userPasswordInput');
  const toggleIcon = document.getElementById('passwordToggleIcon');

  if (passwordInput.type === 'password') {
    passwordInput.type = 'text';
    toggleIcon.classList.remove('bi-eye');
    toggleIcon.classList.add('bi-eye-slash');
  } else {
    passwordInput.type = 'password';
    toggleIcon.classList.remove('bi-eye-slash');
    toggleIcon.classList.add('bi-eye');
  }
}
/**
 * Handle Sign Out (Updated for Anonymous Auth)
 */
 async function handleSignOut() {
  // Check if test user or guest
  if (window.currentUser && window.currentUser.isGuest) {
    // Guest mode - just reload page
    if (confirm('Return to login screen?')) {
      location.reload();
    }
    return;
  }

  // Real authenticated user (including anonymous test users)
  if (confirm('Are you sure you want to sign out?')) {
    try {
      // Delete test user data from Firestore if it's a test user
      if (window.currentUser && window.currentUser.isTestUser) {
        try {
          const { doc, deleteDoc } = window.firebaseImports;
          await deleteDoc(doc(window.db, 'users', window.currentUser.uid));
          console.log('‚úÖ Test user deleted from Firestore');
        } catch (error) {
          console.warn('‚ö†Ô∏è Could not delete test user:', error);
        }
      }
      
      // Sign out from Firebase Auth
      await window.auth.signOut();
      console.log('‚úÖ User signed out');
      location.reload();
    } catch (error) {
      console.error('‚ùå Sign out error:', error);
      alert('Failed to sign out. Please try again.');
    }
  }
}


/**
 * ==========================================
 * SIDEBAR MENU FUNCTIONALITY
 * ==========================================
 */

// Current page tracker
let currentPage = 'home';

/**
 * Toggle Sidebar
 */
function toggleSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    // Prevent body scroll when sidebar is open
    document.body.style.overflow = 'hidden';
  }
}

/**
 * Close Sidebar
 */
function closeSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  document.body.style.overflow = '';
}

/**
 * Go to Home function
 */
function goToHome() {
  console.log('üìç Going to Home');
  closeSidebar();
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Update active page
  currentPage = 'home';
  updateSidebarActive('home');
}

/**
 * Navigate to Different Pages (UPDATED with address handling)
 */
 function navigateTo(page) {
  console.log('üìç Navigating to:', page);
  
  // Update current page
  currentPage = page;
  
  // Close sidebar
  closeSidebar();
  
  // Update active state
  updateSidebarActive(page);
  
  // ‚úÖ Handle specific pages
  if (page === 'orders') {
    // Navigate to My Orders page (customer only)
    if (typeof navigateToCustomerOrders === 'function') {
      navigateToCustomerOrders();
    } else {
      console.error('‚ùå navigateToCustomerOrders function not found');
      alert('‚ö†Ô∏è My Orders page is not available. Please refresh the page.');
    }
    return;
  }
  
  if (page === 'cart') {
    // Navigate to cart
    if (typeof navigateToCart === 'function') {
      navigateToCart();
    } else {
      alert('‚ö†Ô∏è Cart page is not available.');
    }
    return;
  }
  
  // ‚úÖ NEW: Handle Delivery Address
  if (page === 'address') {
    if (!window.currentUser) {
      alert('‚ö†Ô∏è Please sign in to manage your delivery address.');
      return;
    }
    
    if (typeof openDeliveryAddressModal === 'function') {
      openDeliveryAddressModal();
    } else {
      console.error('‚ùå openDeliveryAddressModal function not found');
      alert('‚ö†Ô∏è Delivery address feature is not available.');
    }
    return;
  }
  
  // Handle other pages with coming soon message
  const pageNames = {
    'categories': 'üìÇ Categories',
    'shops': 'üè™ All Shops',
    'deals': 'üè∑Ô∏è Deals & Offers',
    'favorites': '‚ù§Ô∏è Favorites',
    'profile': 'üë§ Profile Settings',
    'help': '‚ùì Help & Support'
  };
  
  const pageName = pageNames[page] || page;
  
  // Show coming soon alert
  alert(`‚è≥ "${pageName}" feature coming soon!\n\nThis will be implemented in the next phase.`);
}


/**
 * Sidebar Action function (for future use)
 */
function sidebarAction(action) {
  console.log('Sidebar action:', action);
  
  // Show coming soon for disabled items
  const actionName = action.replace(/([A-Z])/g, ' $1').trim();
  alert(`‚è≥ "${actionName}" feature coming soon!\n\nThis will be implemented in the next phase.`);
  
  closeSidebar();
}

/**
 * Update Active State in Sidebar
 */
function updateSidebarActive(page) {
  // Remove active class from all items
  const allItems = document.querySelectorAll('.sidebar-item');
  allItems.forEach(item => {
    item.classList.remove('active');
  });
  
  console.log('‚úÖ Active page:', page);
}

/**
 * Close sidebar on window resize (desktop view)
 */
window.addEventListener('resize', function() {
  if (window.innerWidth > 768) {
    closeSidebar();
  }
});

/**
 * Close sidebar on Escape key
 */
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeSidebar();
  }
});

/**
 * ==========================================
 * SHOP REGISTRATION FUNCTIONS
 * ==========================================
 */

// Global variable to store shops
let cachedShops = [];

/**
 * Open Register Shop Modal
 */
function openRegisterShopModal() {
  // Check if user is shopowner
  if (!window.currentUser || window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can register shops.\n\nPlease sign in with authorized email.');
    return;
  }
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('registerShopModal'));
  modal.show();
  
  // Clear form
  document.getElementById('registerShopForm').reset();
}

/**
 * Handle Shop Registration
 */
async function handleRegisterShop() {
  const shopName = document.getElementById('shopName').value.trim();
  const ownerName = document.getElementById('ownerName').value.trim();
  const shopMobile = document.getElementById('shopMobile').value.trim();
  const shopAddress = document.getElementById('shopAddress').value.trim();
  
  // Validation
  if (!shopName || !ownerName || !shopMobile || !shopAddress) {
    alert('‚ùå Please fill all required fields');
    return;
  }
  
  // Validate mobile number
  if (!/^[0-9]{10}$/.test(shopMobile)) {
    alert('‚ùå Please enter a valid 10-digit mobile number');
    return;
  }
  
  // Check if user is authenticated
  if (!window.currentUser || !window.currentUser.uid) {
    alert('‚ùå You must be signed in to register a shop');
    return;
  }
  
  // Show loading
  showSyncIndicator('Registering shop...', null);
  
  try {
    console.log('üè™ Registering shop:', shopName);
    
    const { collection, doc, setDoc } = window.firebaseImports;
    
    // Create shop document
    const shopData = {
      shopName: shopName,
      ownerName: ownerName,
      mobile: shopMobile,
      address: shopAddress,
      ownerId: window.currentUser.uid,
      ownerEmail: window.currentUser.email,
      status: 'active',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    
    // Save to Firestore: shops/{shopId}
    const shopId = 'shop_' + Date.now();
    const shopRef = doc(window.db, 'shops', shopId);
    await setDoc(shopRef, shopData);
    
    console.log('‚úÖ Shop registered successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('registerShopModal'));
    modal.hide();
    
    // Show success message
    showSyncIndicator('Shop registered successfully!', 2000);
    
    // Reload shops
    await loadShopsFromFirestore();
    
    // Show success alert
    setTimeout(() => {
      alert('‚úÖ Shop Registered Successfully!\n\n' +
            'Shop Name: ' + shopName + '\n' +
            'Owner: ' + ownerName + '\n\n' +
            'Your shop is now visible on the homepage!');
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error registering shop:', error);
    showSyncIndicator('Registration failed', 1500);
    alert('‚ùå Failed to register shop: ' + error.message + '\n\nPlease try again.');
  }
}

/**
 * Load Shops from Firestore
 */
async function loadShopsFromFirestore() {
  try {
    console.log('üîÑ Loading shops from Firestore...');
    
    const { collection, getDocs, query, where } = window.firebaseImports;
    
    // Load all active shops
    const shopsRef = collection(window.db, 'shops');
    const shopsQuery = query(shopsRef, where('status', '==', 'active'));
    const shopsSnap = await getDocs(shopsQuery);
    
    cachedShops = [];
    shopsSnap.forEach((doc) => {
      cachedShops.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${cachedShops.length} shops`);
    
    // Save to cache
    localStorage.setItem('ue2shop_shops_cache', JSON.stringify(cachedShops));
    
    // Render shops on homepage
    renderShopsOnHomepage();
    
  } catch (error) {
    console.error('‚ùå Error loading shops:', error);
    
    // Load from cache
    try {
      cachedShops = JSON.parse(localStorage.getItem('ue2shop_shops_cache') || '[]');
      renderShopsOnHomepage();
    } catch (e) {
      console.error('Failed to load from cache:', e);
    }
  }
}

/**
 * Render Shops on Homepage
 */
function renderShopsOnHomepage() {
  // Find the container (after featured products section)
  const mainContent = document.querySelector('.main-content .container');
  
  if (!mainContent) {
    console.warn('‚ö†Ô∏è Main content container not found');
    return;
  }
  
  // Remove existing shops section if any
  const existingSection = document.getElementById('shopsSection');
  if (existingSection) {
    existingSection.remove();
  }
  
  // Create shops section
  const shopsHTML = `
    <div id="shopsSection" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 style="font-weight: 700; color: #333; margin: 0;">
          <i class="bi bi-shop me-2" style="color: #25D366;"></i>
          Local Shops in Urban Estate 2
        </h3>
        <span class="badge" style="background: #25D366; color: white; font-size: 0.9rem; padding: 6px 12px; border-radius: 10px;">
          ${cachedShops.length} Shop${cachedShops.length !== 1 ? 's' : ''}
        </span>
      </div>
      
      <div class="row g-3" id="shopsGrid">
        ${cachedShops.length === 0 ? `
          <div class="col-12">
            <div class="alert alert-info" style="border-radius: 12px; border: none;">
              <i class="bi bi-info-circle me-2"></i>
              <strong>No shops registered yet.</strong><br>
              ${window.currentUser && window.currentUser.role === 'shopowner' ? 
                'Click "Register Shop" button to add your shop!' : 
                'Be the first to discover local shops here!'}
            </div>
          </div>
        ` : cachedShops.map(shop => `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
              
              <!-- Shop Header -->
              <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; color: white;">
                <div class="d-flex align-items-start justify-content-between">
                  <div style="flex: 1;">
                    <h5 style="font-weight: 700; color: white; margin-bottom: 5px;">
                      <i class="bi bi-shop me-2"></i>${escapeHtml(shop.shopName)}
                    </h5>
                    <p style="font-size: 0.85rem; opacity: 0.9; margin: 0;">
                      <i class="bi bi-person me-1"></i>${escapeHtml(shop.ownerName)}
                    </p>
                  </div>
                  <span class="badge" style="background: rgba(255,255,255,0.3); color: white; font-size: 0.75rem;">Active</span>
                </div>
              </div>
              
              <!-- Shop Body -->
              <div class="card-body">
                <!-- Mobile -->
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-phone" style="color: #0d6efd; font-size: 1.2rem; margin-right: 10px;"></i>
                  <div>
                    <small class="text-muted" style="font-size: 0.75rem;">Mobile</small>
                    <p style="margin: 0; font-weight: 600; color: #333;">${escapeHtml(shop.mobile)}</p>
                  </div>
                </div>
                
                <!-- Address -->
                <div class="d-flex align-items-start mb-3">
                  <i class="bi bi-geo-alt-fill" style="color: #dc3545; font-size: 1.2rem; margin-right: 10px;"></i>
                  <div>
                    <small class="text-muted" style="font-size: 0.75rem;">Address</small>
                    <p style="margin: 0; font-size: 0.9rem; color: #666; line-height: 1.4;">${escapeHtml(shop.address)}</p>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-2">
                  <button class="btn btn-sm flex-fill" style="background: #25D366; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;">
                    <i class="bi bi-telephone me-1"></i>Call
                  </button>
                 <button class="btn btn-sm flex-fill" onclick="navigateToShopProducts('${shop.id}', '${escapeHtml(shop.shopName)}')" style="background: #128C7E; color: white; border: none; border-radius: 8px; padding: 8px; font-weight: 600;">
  <i class="bi bi-eye me-1"></i>View Products
</button>
                </div>
              </div>
              
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  // Insert before "Featured Products" section
  const featuredSection = mainContent.querySelector('.mb-4');
  if (featuredSection) {
    featuredSection.insertAdjacentHTML('afterend', shopsHTML);
  } else {
    mainContent.insertAdjacentHTML('afterbegin', shopsHTML);
  }
}


/**
 * Call Shop
 */
 function callShop(mobile) {
  console.log('üìû Calling:', mobile);
  window.location.href = 'tel:' + mobile;
}


/**
 * Sync Helper Functions
 */
function showSyncIndicator(msg = 'Syncing...', hideAfterMs = null) {
  const el = document.getElementById('syncIndicator');
  const textEl = document.getElementById('syncText');
  
  if (el && textEl) {
    textEl.textContent = msg;
    el.style.display = 'block';
    
    if (hideAfterMs) {
      setTimeout(() => {
        el.style.display = 'none';
      }, hideAfterMs);
    }
  }
}

function hideSyncIndicator() {
  const el = document.getElementById('syncIndicator');
  if (el) {
    el.style.display = 'none';
  }
}

/**
 * Escape HTML to prevent XSS
 */
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Load shops when app initializes
 * This runs after DOM is loaded and Firebase is ready
 */
 window.addEventListener('DOMContentLoaded', function() {
  console.log('üîÑ DOM loaded, waiting for auth...');
  
  // Check periodically if user is authenticated
  const checkAuthInterval = setInterval(() => {
    if (window.auth && window.auth.currentUser && document.getElementById('mainApp').style.display === 'block') {
      console.log('‚úÖ User authenticated, loading shops...');
      loadShopsFromFirestore();
      clearInterval(checkAuthInterval);
    }
  }, 500);
  
  // Stop checking after 10 seconds
  setTimeout(() => {
    clearInterval(checkAuthInterval);
  }, 10000);
});

/**
 * ==========================================
 * SHOP PRODUCTS PAGE FUNCTIONS
 * ==========================================
 */

// Global variables
let currentShopData = null;
let allShopProducts = [];

/**
 * Navigate to Shop Products Page (UPDATED - Show button for all shopowners)
 */
 function navigateToShopProducts(shopId, shopName) {
  console.log('üè™ Navigating to Shop Products:', shopId, shopName);
  
  // Store current shop data
  currentShopData = cachedShops.find(shop => shop.id === shopId);
  
  if (!currentShopData) {
    console.error('‚ùå Shop not found:', shopId);
    alert('Shop not found!');
    return;
  }
  
  // Hide main app and navbar
  const mainApp = document.getElementById('mainApp');
  const mainNavbar = document.getElementById('mainNavbar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  
  if (mainApp) mainApp.style.display = 'none';
  if (mainNavbar) mainNavbar.style.display = 'none';
  if (sidebarToggleBtn) sidebarToggleBtn.style.display = 'none';
  
  // Show shop products page
  const shopProductsPage = document.getElementById('shopProductsPage');
  if (shopProductsPage) {
    shopProductsPage.style.display = 'block';
    shopProductsPage.classList.add('active');
  }
  
  // Update page title
  const pageTitle = document.getElementById('shopProductsPageTitle');
  if (pageTitle) {
    pageTitle.textContent = shopName;
  }
  
  // Render shop info
  renderShopInfo(currentShopData);
  
  // Load shop products
  loadShopProducts(currentShopData.id);
  
  // ‚úÖ UPDATED: Show/Hide Add Products button (SAME LOGIC AS REGISTER SHOP)
  console.log('üîç Checking Add Products Button Visibility');
  console.log('  - Current User Role:', window.currentUser?.role);
  
  const addProductsBtn = document.getElementById('addProductsBtn');
  const headerSpacer = document.getElementById('headerSpacer');
  
  // ‚úÖ NEW LOGIC: Show for ANY shopowner (not just shop owner)
  if (window.currentUser && window.currentUser.role === 'shopowner') {
    // User is a shopowner - show Add Products button
    console.log('‚úÖ SHOWING Add Products Button (User is shopowner)');
    if (addProductsBtn) {
      addProductsBtn.classList.remove('d-none');
      addProductsBtn.style.display = 'block';
    }
    if (headerSpacer) {
      headerSpacer.style.display = 'none';
    }
  } else {
    // Hide button for customers
    console.log('üö´ HIDING Add Products Button (User is not shopowner)');
    if (addProductsBtn) {
      addProductsBtn.classList.add('d-none');
      addProductsBtn.style.display = 'none';
    }
    if (headerSpacer) {
      headerSpacer.style.display = 'block';
    }
  }
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Update hash
  window.location.hash = '#shop-products/' + shopId;
  
  // ‚úÖ INSURANCE: Re-check button after short delay (in case currentUser loads late)
  setTimeout(() => {
    if (window.currentUser && window.currentUser.role === 'shopowner') {
      const btn = document.getElementById('addProductsBtn');
      if (btn) {
        btn.classList.remove('d-none');
        btn.style.display = 'block';
        console.log('‚úÖ Button re-checked after delay: visible');
      }
      const spacer = document.getElementById('headerSpacer');
      if (spacer) spacer.style.display = 'none';
    }
  }, 500);
}


/**
 * Render Shop Info Card
 */
function renderShopInfo(shop) {
  const shopInfoCard = document.getElementById('shopInfoCard');
  
  if (!shopInfoCard) return;
  
  shopInfoCard.innerHTML = `
    <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; color: white;">
      <div class="d-flex align-items-start justify-content-between">
        <div style="flex: 1;">
          <h4 style="font-weight: 700; color: white; margin-bottom: 8px;">
            <i class="bi bi-shop me-2"></i>${escapeHtml(shop.shopName)}
          </h4>
          <p style="font-size: 0.95rem; opacity: 0.95; margin-bottom: 4px;">
            <i class="bi bi-person me-2"></i>${escapeHtml(shop.ownerName)}
          </p>
          <p style="font-size: 0.9rem; opacity: 0.9; margin: 0;">
            <i class="bi bi-phone me-2"></i>${escapeHtml(shop.mobile)}
          </p>
        </div>
        <span class="badge" style="background: rgba(255,255,255,0.3); color: white; font-size: 0.85rem; padding: 6px 12px;">Active</span>
      </div>
    </div>
    <div class="card-body">
      <p style="margin: 0; color: #666;">
        <i class="bi bi-geo-alt-fill me-2" style="color: #dc3545;"></i>${escapeHtml(shop.address)}
      </p>
    </div>
  `;
}
/**
 * Load Shop Products from Firestore (SHOP-SPECIFIC)
 */
 async function loadShopProducts(shopId) {
  console.log('üîÑ Loading products for shop:', shopId);
  
  const productsGrid = document.getElementById('shopProductsGrid');
  const emptyState = document.getElementById('shopProductsEmptyState');
  
  if (!productsGrid) {
    console.error('‚ùå Products grid not found');
    return;
  }
  
  // Show loading
  productsGrid.innerHTML = `
    <div class="col-12" style="text-align: center; padding: 40px;">
      <div class="spinner-border text-success" role="status"></div>
      <p class="mt-3">Loading products...</p>
    </div>
  `;
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // ‚úÖ NEW: Load from shops/{shopId}/products instead of tenants/{ownerId}/products
    const productsRef = collection(window.db, 'shops', shopId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    allShopProducts = [];
    productsSnap.forEach((doc) => {
      allShopProducts.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${allShopProducts.length} products for shop: ${shopId}`);
    
    // Render products
    renderShopProducts(allShopProducts);
    
  } catch (error) {
    console.error('‚ùå Error loading shop products:', error);
    
    productsGrid.innerHTML = `
      <div class="col-12">
        <div class="alert alert-danger" style="border-radius: 12px;">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Error loading products:</strong> ${error.message}
        </div>
      </div>
    `;
  }
}
/**
 * Render Shop Products (UPDATED - Edit button for all shopowners + Remove on minus)
 */
 function renderShopProducts(products) {
  const productsGrid = document.getElementById('shopProductsGrid');
  const emptyState = document.getElementById('shopProductsEmptyState');
  
  if (!productsGrid) return;
  
  // Clear grid
  productsGrid.innerHTML = '';
  
  if (products.length === 0) {
    productsGrid.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  productsGrid.style.display = 'flex';
  if (emptyState) emptyState.style.display = 'none';
  
  // ‚úÖ Check if user is ANY shopowner (not just shop owner)
  const isShopowner = window.currentUser && window.currentUser.role === 'shopowner';
  
  console.log('üì¶ Rendering products:');
  console.log('  - User is shopowner?', isShopowner);
  console.log('  - Will show edit buttons?', isShopowner);
  
  // Render each product
  products.forEach(product => {
    // Check if product is in cart
    const cartItem = getCartItem(product.id);
    const inCart = !!cartItem;
    const quantity = cartItem ? cartItem.quantity : 0;
    const stock = product.stock || 0;
    const price = product.price || 0;
    
    // Prepare product data for addToCart
    const productData = {
      id: product.id,
      name: product.name || 'Unnamed Product',
      price: price,
      stock: stock,
      brand: product.brand || '',
      size: product.size || '',
      category: product.category || '',
      shopId: product.shopId || currentShopData?.id,
      shopName: product.shopName || currentShopData?.shopName,
      ownerId: product.ownerId || currentShopData?.ownerId
    };
    
    const productCard = `
      <div class="col-md-4 col-sm-6 col-12">
        <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; transition: transform 0.2s; position: relative;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
          
          ${isShopowner ? `
            <!-- ‚úÖ EDIT BUTTON (ALL SHOPOWNERS) -->
            <button 
              onclick="openEditProductModal('${product.id}')" 
              style="
                position: absolute; 
                top: 10px; 
                right: 10px; 
                background: rgba(25, 118, 210, 0.95); 
                color: white; 
                border: none; 
                border-radius: 50%; 
                width: 36px; 
                height: 36px; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                cursor: pointer; 
                z-index: 10;
                transition: all 0.2s;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
              "
              onmouseover="this.style.background='rgba(21, 101, 192, 0.95)'; this.style.transform='scale(1.1)'"
              onmouseout="this.style.background='rgba(25, 118, 210, 0.95)'; this.style.transform='scale(1)'"
              title="Edit Product">
              <i class="bi bi-pencil-fill"></i>
            </button>
          ` : ''}
          
          <!-- Product Image/Icon -->
          <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); height: 150px; display: flex; align-items: center; justify-content: center;">
            <i class="bi bi-box-seam" style="font-size: 3rem; color: #1976d2;"></i>
          </div>
          
          <!-- Product Body -->
          <div class="card-body">
            <h6 class="mb-2" style="font-weight: 600; color: #333; min-height: 40px;">
              ${escapeHtml(product.name || 'Unnamed Product')}
            </h6>
            
            <div class="mb-2">
              ${product.brand ? `<span class="badge" style="background: #e3f2fd; color: #1976d2; font-size: 0.75rem; margin-right: 5px;">${escapeHtml(product.brand)}</span>` : ''}
              ${product.size ? `<span class="badge" style="background: #f3e5f5; color: #7b1fa2; font-size: 0.75rem;">${escapeHtml(product.size)}</span>` : ''}
              ${product.category ? `<span class="badge" style="background: #fff3e0; color: #e65100; font-size: 0.75rem; margin-left: 5px;">${escapeHtml(product.category)}</span>` : ''}
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span style="font-size: 1.2rem; font-weight: 700; color: #25D366;">
                ${price > 0 ? `‚Çπ${formatPrice(price)}` : '<span style="color: #999; font-size: 0.9rem;">Price TBD</span>'}
              </span>
              <span class="text-muted" style="font-size: 0.85rem;">
                ${stock > 0 ? `Stock: ${stock}` : '<span style="color: #dc3545;">Out of Stock</span>'}
              </span>
            </div>
            
            ${!isShopowner ? `
              <!-- ‚úÖ CART BUTTON (CUSTOMERS ONLY) -->
              <div id="cartBtn_${product.id}">
                ${inCart ? `
                  <!-- ‚úÖ UPDATED: Quantity Stepper (No disabled, red trash when qty=1) -->
                  <div class="quantity-stepper w-100" style="justify-content: space-between; padding: 10px 15px;">
                    <button 
                      onclick="event.stopPropagation(); updateCartQuantity('${product.id}', -1);" 
                      title="${quantity <= 1 ? 'Remove from cart' : 'Decrease quantity'}"
                      style="
                        background: ${quantity <= 1 ? '#dc3545' : '#ffc107'};
                        color: white;
                        border: none;
                        border-radius: 6px;
                        width: 36px;
                        height: 36px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        font-size: 1rem;
                        transition: all 0.2s;
                      "
                      onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'"
                      onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                      <i class="bi bi-${quantity <= 1 ? 'trash' : 'dash'}"></i>
                    </button>
                    <span style="font-size: 1.1rem; font-weight: 600;">${quantity}</span>
                    <button 
                      onclick="event.stopPropagation(); updateCartQuantity('${product.id}', 1);" 
                      ${quantity >= stock ? 'disabled' : ''}
                      title="${quantity >= stock ? 'Stock limit reached' : 'Increase quantity'}"
                      style="
                        background: ${quantity >= stock ? '#ccc' : '#25D366'};
                        color: white;
                        border: none;
                        border-radius: 6px;
                        width: 36px;
                        height: 36px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: ${quantity >= stock ? 'not-allowed' : 'pointer'};
                        font-size: 1rem;
                        transition: all 0.2s;
                      "
                      ${quantity < stock ? "onmouseover=\"this.style.transform='scale(1.1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)'\" onmouseout=\"this.style.transform='scale(1)'; this.style.boxShadow='none'\"" : ''}>
                      <i class="bi bi-plus"></i>
                    </button>
                  </div>
                  ${quantity >= stock ? '<p class="text-warning text-center mb-0 mt-2" style="font-size: 0.75rem;"><i class="bi bi-exclamation-triangle"></i> Max stock reached</p>' : ''}
                ` : `
                  <!-- Add to Cart Button -->
                  <button 
                    class="btn btn-sm w-100 btn-add-to-cart" 
                    style="background: ${stock > 0 ? '#25D366' : '#ccc'}; color: white; border: none; border-radius: 8px; padding: 10px; font-weight: 600; transition: all 0.2s;" 
                    onclick="event.stopPropagation(); addToCart(${JSON.stringify(productData).replace(/"/g, '&quot;')});"
                    ${stock <= 0 ? 'disabled' : ''}
                    onmouseover="if(this.style.background === 'rgb(37, 211, 102)') this.style.background='#128C7E'"
                    onmouseout="if(!this.disabled) this.style.background='#25D366'">
                    <i class="bi bi-cart-plus me-1"></i>${stock > 0 ? 'Add to Cart' : 'Out of Stock'}
                  </button>
                `}
              </div>
            ` : `
              <!-- ‚úÖ SHOPOWNER INFO (NO CART BUTTONS) -->
              <div class="alert alert-info mb-0" style="border-radius: 8px; padding: 8px; font-size: 0.85rem;">
                <i class="bi bi-info-circle me-1"></i> Click <strong>Edit</strong> to manage this product
              </div>
            `}
            
          </div>
          
        </div>
      </div>
    `;
    
    productsGrid.insertAdjacentHTML('beforeend', productCard);
  });
  
  console.log(`‚úÖ Rendered ${products.length} products (Shopowner mode: ${isShopowner})`);
}


/**
 * Filter Shop Products
 */
function filterShopProducts(searchTerm) {
  const term = searchTerm.toLowerCase().trim();
  
  if (!term) {
    renderShopProducts(allShopProducts);
    return;
  }
  
  const filtered = allShopProducts.filter(product => {
    const name = (product.name || '').toLowerCase();
    const brand = (product.brand || '').toLowerCase();
    const size = (product.size || '').toLowerCase();
    
    return name.includes(term) || brand.includes(term) || size.includes(term);
  });
  
  renderShopProducts(filtered);
}

/**
 * Go Back to Home
 */
function goBackHome() {
  console.log('üè† Going back to home');
  
  // Hide shop products page
  const shopProductsPage = document.getElementById('shopProductsPage');
  if (shopProductsPage) {
    shopProductsPage.style.display = 'none';
    shopProductsPage.classList.remove('active');
  }
  
  // Show main app and navbar
  const mainApp = document.getElementById('mainApp');
  const mainNavbar = document.getElementById('mainNavbar');
  const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
  
  if (mainApp) {
    mainApp.style.display = 'block';
  }
  
  if (mainNavbar) {
    mainNavbar.style.display = 'flex';
  }
  
  if (sidebarToggleBtn) {
    sidebarToggleBtn.style.display = 'block';
  }
  
  // Clear search
  const searchInput = document.getElementById('searchShopProductsInput');
  if (searchInput) {
    searchInput.value = '';
  }
  
  // Reset current shop data
  currentShopData = null;
  allShopProducts = [];
  
  // Update hash
  window.location.hash = '#home';
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Format Price
 */
function formatPrice(price) {
  return Number(price || 0).toLocaleString('en-IN', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}


/**
 * ==========================================
 * ADD PRODUCTS FUNCTIONALITY (SHOPOWNERS ONLY)
 * ==========================================
 */

// Global variables
let pendingProducts = [];
/**
 * Open Add Products Modal (UPDATED - No ownership check)
 */
 function openAddProductsModal() {
  console.log('‚ûï Opening Add Products Modal');
  
  // ‚úÖ SIMPLIFIED: Only check if user is shopowner
  if (!window.currentUser) {
    console.error('‚ùå No user signed in');
    alert('‚ö†Ô∏è Please sign in to add products.');
    return;
  }
  
  if (window.currentUser.role !== 'shopowner') {
    console.error('‚ùå User is not a shopowner');
    alert('‚ö†Ô∏è Only shopowners can add products.');
    return;
  }
  
  // ‚úÖ REMOVED: Ownership check - any shopowner can add products to any shop
  
  if (!currentShopData) {
    console.error('‚ùå No shop data available');
    alert('‚ùå Shop data not found. Please go back and try again.');
    return;
  }
  
  console.log('‚úÖ All checks passed, opening modal...');
  console.log('  - Shop:', currentShopData.shopName);
  console.log('  - User:', window.currentUser.email);
  
  // Reset pending products
  pendingProducts = [];
  
  // Clear input
  const productInput = document.getElementById('productInput');
  if (productInput) {
    productInput.value = '';
    window.lastProductInput = '';
  }
  
  // Update preview
  updateProductsPreviewList();
  
  // Open modal
  const modalElement = document.getElementById('addProductsModal');
  if (!modalElement) {
    console.error('‚ùå addProductsModal element not found');
    alert('‚ùå Modal not found');
    return;
  }
  
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
  console.log('‚úÖ Modal opened');
  
  // Focus on input
  setTimeout(() => {
    if (productInput) {
      productInput.focus();
      console.log('‚úÖ Input focused');
    }
  }, 300);
}

// Make it global
window.openAddProductsModal = openAddProductsModal;


/**
 * Handle Product Input Keydown (Enter or Comma)
 */
function handleProductInputKeydown(event) {
  const input = document.getElementById('productInput');
  if (!input) return;
  
  // Check if Enter or Comma key
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    let value = window.lastProductInput || input.value;
    value = value.trim();
    
    // Remove trailing comma if present
    if (value.endsWith(',')) {
      value = value.slice(0, -1).trim();
    }
    
    if (value && value.length > 0) {
      // Check if already in pending list
      if (pendingProducts.includes(value)) {
        alert('‚ö†Ô∏è This product is already in the list!');
      } else {
        // Add to pending products
        pendingProducts.push(value);
        console.log('‚úÖ Product added to preview:', value);
        
        // Update preview
        updateProductsPreviewList();
      }
    }
    
    // Clear input
    forceClearProductInput();
  }
}

/**
 * Add Product to List (Button Click)
 */
function addProductToList() {
  const input = document.getElementById('productInput');
  if (!input) return;
  
  let value = window.lastProductInput || input.value;
  value = value.trim();
  
  if (!value || value.length === 0) {
    alert('‚ö†Ô∏è Please enter a product name');
    return;
  }
  
  // Check for duplicates
  if (pendingProducts.includes(value)) {
    alert('‚ö†Ô∏è This product is already in the list!');
    return;
  }
  
  // Add to pending list
  pendingProducts.push(value);
  console.log('‚úÖ Product added to preview:', value);
  
  // Update preview
  updateProductsPreviewList();
  
  // Clear input
  forceClearProductInput();
  
  // Focus back
  setTimeout(() => {
    if (input) input.focus();
  }, 50);
}

/**
 * Force Clear Product Input
 */
function forceClearProductInput() {
  document.querySelectorAll('#productInput').forEach(inp => {
    inp.value = '';
    inp.setAttribute('value', '');
    window.lastProductInput = '';
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
  console.log('üßπ Product input cleared');
}

/**
 * Update Products Preview List
 */
function updateProductsPreviewList() {
  const previewList = document.getElementById('productsPreviewList');
  const previewCount = document.getElementById('productsPreviewCount');
  
  if (!previewList) {
    console.error('‚ùå productsPreviewList not found');
    return;
  }
  
  if (previewCount) {
    previewCount.textContent = `üìù Products to Save (${pendingProducts.length}):`;
  }
  
  if (pendingProducts.length === 0) {
    previewList.innerHTML = `
      <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
        No products added yet
      </div>
    `;
    return;
  }
  
  let html = '';
  pendingProducts.forEach((product, index) => {
    html += `
      <div style="
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 12px; border-bottom: 1px solid #e0e0e0;
        background: white; transition: background 0.2s;
      " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
        
        <span style="font-size: 14px; color: #333; flex: 1;">
          <strong style="color: #007bff;">${index + 1}.</strong> 
          <span style="margin-left: 8px;">${escapeHtml(product)}</span>
        </span>
        
        <button onclick="removePendingProduct(${index})" style="
          background: #dc3545; color: white; border: none; 
          padding: 5px 10px; border-radius: 5px; cursor: pointer;
          font-size: 12px; font-weight: 600; transition: background 0.2s;
        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
  console.log(`üìã Updated preview: ${pendingProducts.length} products`);
}

/**
 * Remove Pending Product
 */
function removePendingProduct(index) {
  if (index < 0 || index >= pendingProducts.length) return;
  
  const removed = pendingProducts.splice(index, 1);
  console.log('üóëÔ∏è Removed product:', removed[0]);
  updateProductsPreviewList();
}
/**
 * Save All Products to Firebase (SHOP-SPECIFIC)
 */
 async function saveAllProducts() {
  if (pendingProducts.length === 0) {
    alert('‚ö†Ô∏è Please add at least one product');
    return;
  }
  
  if (!currentShopData || !currentShopData.id) {
    alert('‚ùå Shop data not found');
    return;
  }
  
  console.log('üíæ Saving', pendingProducts.length, 'products to shop:', currentShopData.shopName);
  
  try {
    showSyncIndicator('Saving products...', null);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // ‚úÖ NEW: Save to shops/{shopId}/products instead of tenants/{ownerId}/products
    const productsRef = collection(window.db, 'shops', currentShopData.id, 'products');
    
    const productsToSave = [...pendingProducts];
    
    // Save each product
    const savePromises = productsToSave.map(async (productName) => {
      try {
        await addDoc(productsRef, {
          name: productName,
          price: 0,
          stock: 0,
          brand: '',
          size: '',
          category: '',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          shopId: currentShopData.id,
          shopName: currentShopData.shopName,
          ownerId: currentShopData.ownerId,
          ownerName: currentShopData.ownerName
        });
        console.log('‚úÖ Firebase: Product saved to shop:', productName);
        return { success: true, product: productName };
      } catch (error) {
        console.error('‚ùå Firebase: Failed to save product:', productName, error);
        return { success: false, product: productName, error };
      }
    });
    
    const results = await Promise.all(savePromises);
    const failed = results.filter(r => !r.success);
    
    // Clear input
    document.querySelectorAll('#productInput').forEach(inp => {
      inp.value = '';
      inp.setAttribute('value', '');
      window.lastProductInput = '';
      inp.dispatchEvent(new Event('input', { bubbles: true }));
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addProductsModal'));
    if (modal) modal.hide();
    
    // Clear pending
    pendingProducts = [];
    
    // Reload products
    await loadShopProducts(currentShopData.id);
    
    showSyncIndicator('Products saved!', 2000);
    
    if (failed.length > 0) {
      alert(`‚ö†Ô∏è Warning: ${failed.length} product(s) failed to save.\n\n${productsToSave.length - failed.length} products saved successfully.`);
    } else {
      alert(`‚úÖ Success!\n\n${productsToSave.length} product(s) added to ${currentShopData.shopName}!`);
    }
    
  } catch (error) {
    console.error('‚ùå Error saving products:', error);
    showSyncIndicator('Save failed', 1500);
    alert('‚ùå Error saving products: ' + error.message);
  }
}


/**
 * ==========================================
 * EDIT PRODUCT FUNCTIONALITY (ALL SHOPOWNERS)
 * ==========================================
 */

// Store current editing product
let currentEditingProduct = null;

/**
 * Open Edit Product Modal (UPDATED - All shopowners can edit)
 */
function openEditProductModal(productId) {
  console.log('‚úèÔ∏è Opening edit modal for product:', productId);
  
  // ‚úÖ SIMPLIFIED: Only check if user is shopowner (not shop ownership)
  if (!window.currentUser) {
    alert('‚ö†Ô∏è Please sign in to edit products.');
    return;
  }
  
  if (window.currentUser.role !== 'shopowner') {
    alert('‚ö†Ô∏è Only shopowners can edit products.');
    return;
  }
  
  // ‚úÖ REMOVED: Shop ownership check - any shopowner can edit any product
  
  if (!currentShopData) {
    alert('‚ùå Shop data not found. Please go back and try again.');
    return;
  }
  
  // Find product in allShopProducts
  const product = allShopProducts.find(p => p.id === productId);
  
  if (!product) {
    alert('‚ùå Product not found!');
    return;
  }
  
  console.log('‚úÖ Opening edit modal for:', product.name);
  console.log('  - Shop:', currentShopData.shopName);
  console.log('  - User:', window.currentUser.email);
  
  // Store current editing product
  currentEditingProduct = { ...product };
  
  // Populate form fields
  document.getElementById('editProductId').value = product.id;
  document.getElementById('editProductName').value = product.name || '';
  document.getElementById('editProductPrice').value = product.price || 0;
  document.getElementById('editProductStock').value = product.stock || 0;
  document.getElementById('editProductBrand').value = product.brand || '';
  document.getElementById('editProductSize').value = product.size || '';
  document.getElementById('editProductCategory').value = product.category || '';
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
  modal.show();
  
  // Focus on name field
  setTimeout(() => {
    document.getElementById('editProductName').focus();
  }, 300);
}

/**
 * Adjust Stock in Edit Modal
 */
function adjustEditStock(change) {
  const stockInput = document.getElementById('editProductStock');
  if (!stockInput) return;
  
  let currentStock = parseInt(stockInput.value) || 0;
  let newStock = currentStock + change;
  
  // Prevent negative stock
  if (newStock < 0) newStock = 0;
  
  stockInput.value = newStock;
  console.log(`üì¶ Stock adjusted: ${currentStock} ‚Üí ${newStock}`);
}

/**
 * Save Edited Product (UPDATED - All shopowners can save)
 */
async function saveEditedProduct() {
  console.log('üíæ Saving edited product...');
  
  // Get form values
  const productId = document.getElementById('editProductId').value;
  const name = document.getElementById('editProductName').value.trim();
  const price = parseFloat(document.getElementById('editProductPrice').value) || 0;
  const stock = parseInt(document.getElementById('editProductStock').value) || 0;
  const brand = document.getElementById('editProductBrand').value.trim();
  const size = document.getElementById('editProductSize').value.trim();
  const category = document.getElementById('editProductCategory').value.trim();
  
  // Validate
  if (!name || name.length === 0) {
    alert('‚ö†Ô∏è Please enter a product name!');
    document.getElementById('editProductName').focus();
    return;
  }
  
  if (price < 0) {
    alert('‚ö†Ô∏è Price cannot be negative!');
    document.getElementById('editProductPrice').focus();
    return;
  }
  
  if (stock < 0) {
    alert('‚ö†Ô∏è Stock cannot be negative!');
    document.getElementById('editProductStock').focus();
    return;
  }
  
  if (!currentShopData || !currentShopData.id) {
    alert('‚ùå Shop data not found');
    return;
  }
  
  try {
    showSyncIndicator('Saving changes...', null);
    
    const { doc, updateDoc } = window.firebaseImports;
    
    // Prepare update data
    const updateData = {
      name: name,
      price: price,
      stock: stock,
      brand: brand,
      size: size,
      category: category,
      updatedAt: new Date().toISOString()
    };
    
    console.log('üìù Updating product in shop:', currentShopData.shopName);
    console.log('  - Product ID:', productId);
    console.log('  - Update data:', updateData);
    
    // Update in Firebase
    const productRef = doc(window.db, 'shops', currentShopData.id, 'products', productId);
    await updateDoc(productRef, updateData);
    
    console.log('‚úÖ Product updated in Firebase');
    
    // Update local cache
    const productIndex = allShopProducts.findIndex(p => p.id === productId);
    if (productIndex !== -1) {
      allShopProducts[productIndex] = {
        ...allShopProducts[productIndex],
        ...updateData
      };
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
    if (modal) modal.hide();
    
    // Re-render products
    renderShopProducts(allShopProducts);
    
    showSyncIndicator('Changes saved!', 2000);
    
    // Show success message
    alert(`‚úÖ Product updated successfully!\n\nName: ${name}\nPrice: ‚Çπ${price}\nStock: ${stock}`);
    
    currentEditingProduct = null;
    
  } catch (error) {
    console.error('‚ùå Error saving product:', error);
    showSyncIndicator('Save failed', 1500);
    alert('‚ùå Error saving product: ' + error.message);
  }
}

// Make functions global
window.openEditProductModal = openEditProductModal;
window.adjustEditStock = adjustEditStock;
window.saveEditedProduct = saveEditedProduct;

console.log('‚úÖ Edit product functionality loaded (All shopowners)');


/**
 * Test Login as Customer (FIXED with null checks)
 */
 async function testLoginAsCustomer() {
  console.log('üß™ TEST LOGIN: Customer');
  
  try {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Logging in...';
    
    const { signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
    const { doc, setDoc, serverTimestamp } = window.firebaseImports;
    
    // Sign in anonymously
    const userCredential = await signInAnonymously(window.auth);
    const user = userCredential.user;
    
    console.log('‚úÖ Anonymous auth successful:', user.uid);
    
    // ‚úÖ Generate safe email
    const testEmail = `testcustomer_${user.uid.slice(0, 8)}@ue2shop.test`;
    
    // Create test customer document
    const userDocRef = doc(window.db, 'users', user.uid);
    await setDoc(userDocRef, {
      email: testEmail,
      displayName: 'Test Customer',
      photoURL: 'https://ui-avatars.com/api/?name=Test+Customer&background=0d6efd&color=fff',
      location: 'Urban Estate 2, Hisar',
      role: 'customer',
      isTestUser: true,
      isAnonymous: true,
      mobile: '9876543210',
      address: 'Test Address, Urban Estate 2',
      createdAt: serverTimestamp(),
      lastLogin: serverTimestamp()
    });
    
    console.log('‚úÖ Test customer created in Firestore');
    
    // ‚úÖ Set window.currentUser with all required fields
    window.currentUser = {
      email: testEmail,
      uid: user.uid,
      displayName: 'Test Customer',
      photoURL: 'https://ui-avatars.com/api/?name=Test+Customer&background=0d6efd&color=fff',
      role: 'customer',
      isTestUser: true,
      isAnonymous: true,
      mobile: '9876543210',
      address: 'Test Address, Urban Estate 2'
    };
    
    console.log('‚úÖ Logged in as Test Customer:', window.currentUser);
    
    // Success message
    setTimeout(() => {
      alert('‚úÖ Logged in as Test Customer!\n\nYou can now:\n‚Ä¢ Browse products\n‚Ä¢ Add items to cart\n‚Ä¢ Place orders\n‚Ä¢ View order history');
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Test login error:', error);
    alert('‚ùå Test login failed: ' + error.message);
    
    if (event && event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '<i class="bi bi-person-circle me-2"></i>Test Login as Customer';
    }
  }
}

/**
 * Test Login as Shopowner (FIXED with null checks)
 */
async function testLoginAsShopowner() {
  console.log('üß™ TEST LOGIN: Shopowner');
  
  try {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Logging in...';
    
    const { signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');
    const { doc, setDoc, serverTimestamp } = window.firebaseImports;
    
    // Sign in anonymously
    const userCredential = await signInAnonymously(window.auth);
    const user = userCredential.user;
    
    console.log('‚úÖ Anonymous auth successful:', user.uid);
    
    // ‚úÖ Generate safe email
    const testEmail = `testshopowner_${user.uid.slice(0, 8)}@ue2shop.test`;
    
    // Create test shopowner document
    const userDocRef = doc(window.db, 'users', user.uid);
    await setDoc(userDocRef, {
      email: testEmail,
      displayName: 'Test Shopowner',
      photoURL: 'https://ui-avatars.com/api/?name=Test+Shopowner&background=ffc107&color=000',
      location: 'Urban Estate 2, Hisar',
      role: 'shopowner',
      isTestUser: true,
      isAnonymous: true,
      mobile: '9876543210',
      createdAt: serverTimestamp(),
      lastLogin: serverTimestamp()
    });
    
    console.log('‚úÖ Test shopowner created in Firestore');
    
    // ‚úÖ Set window.currentUser with all required fields
    window.currentUser = {
      email: testEmail,
      uid: user.uid,
      displayName: 'Test Shopowner',
      photoURL: 'https://ui-avatars.com/api/?name=Test+Shopowner&background=ffc107&color=000',
      role: 'shopowner',
      isTestUser: true,
      isAnonymous: true,
      mobile: '9876543210'
    };
    
    console.log('‚úÖ Logged in as Test Shopowner:', window.currentUser);
    
    // Success message
    setTimeout(() => {
      alert('‚úÖ Logged in as Test Shopowner!\n\nYou can now:\n‚Ä¢ Register your shop\n‚Ä¢ Add products\n‚Ä¢ Manage orders\n‚Ä¢ Edit shop details');
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Test login error:', error);
    alert('‚ùå Test login failed: ' + error.message);
    
    if (event && event.target) {
      event.target.disabled = false;
      event.target.innerHTML = '<i class="bi bi-shop me-2"></i>Test Login as Shopowner';
    }
  }
}


/**
 * Skip Login (Updated - Guest Mode)
 */
function skipLogin() {
  console.log('‚è≠Ô∏è Skipping login - Guest mode');

  // Set temporary guest user
  window.currentUser = {
    email: 'guest@ue2shop.local',
    uid: 'guest_' + Date.now(),
    displayName: 'Guest User',
    photoURL: null,
    role: 'guest',
    isGuest: true
  };

  // Hide auth screen and show app
  document.getElementById('authScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';

  // Update UI
  if (typeof updateUserInfo === 'function') {
    updateUserInfo();
  }
  
  // Update sidebar
  if (typeof updateSidebarForUser === 'function') {
    updateSidebarForUser();
  }
  
  if (typeof renderSidebarMenu === 'function') {
    renderSidebarMenu();
  }
  
  // Load shops
  setTimeout(async () => {
    if (typeof loadAllShops === 'function') {
      await loadAllShops();
    }
    if (typeof renderShopsOnHomepage === 'function') {
      await renderShopsOnHomepage();
    }
  }, 500);

  // Show notification
  setTimeout(() => {
    alert('‚ö†Ô∏è Guest Mode: You are browsing without authentication.\n\nSign in with Google or Email to place orders.');
  }, 1000);
}


/**
 * ==========================================
 * FEATURED PRODUCTS ON HOMEPAGE (FIXED)
 * ==========================================
 */

// Global variable for featured products
let featuredProducts = [];

/**
 * Load Featured Products from Firestore (FIXED - No composite index needed)
 */
async function loadFeaturedProducts() {
  console.log('üåü Loading featured products...');
  
  const loadingDiv = document.getElementById('featuredProductsLoading');
  const containerDiv = document.getElementById('featuredProductsContainer');
  const emptyDiv = document.getElementById('featuredProductsEmpty');
  
  if (loadingDiv) loadingDiv.style.display = 'block';
  if (containerDiv) containerDiv.style.display = 'none';
  if (emptyDiv) emptyDiv.style.display = 'none';
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // Get all shops
    const shopsRef = collection(window.db, 'shops');
    const shopsSnapshot = await getDocs(shopsRef);
    
    console.log(`üì¶ Found ${shopsSnapshot.size} shops`);
    
    let allProducts = [];
    
    // Fetch products from each shop
    for (const shopDoc of shopsSnapshot.docs) {
      const shopData = shopDoc.data();
      const shopId = shopDoc.id;
      
      console.log(`üîÑ Loading products from shop: ${shopId} (${shopData.shopName})`);
      
      try {
        // ‚úÖ SIMPLIFIED: Just get all products (no complex query)
        const productsRef = collection(window.db, 'shops', shopId, 'products');
        const productsSnapshot = await getDocs(productsRef);
        
        console.log(`  ‚ûú Found ${productsSnapshot.size} products in ${shopData.shopName}`);
        
        productsSnapshot.forEach(productDoc => {
          const productData = productDoc.data();
          
          // ‚úÖ FILTER: Only include products with stock > 0
          if (productData.stock && productData.stock > 0) {
            allProducts.push({
              id: productDoc.id,
              shopId: shopId,
              shopName: shopData.shopName || 'Local Shop',
              shopOwnerId: shopData.ownerId,
              ...productData
            });
          }
        });
        
      } catch (error) {
        console.error(`‚ùå Could not load products from shop ${shopId}:`, error);
      }
    }
    
    console.log(`‚úÖ Total products loaded: ${allProducts.length}`);
    
    // ‚úÖ FALLBACK: If no in-stock products, show all products
    if (allProducts.length === 0) {
      console.log('‚ö†Ô∏è No in-stock products found, loading all products...');
      
      for (const shopDoc of shopsSnapshot.docs) {
        const shopData = shopDoc.data();
        const shopId = shopDoc.id;
        
        try {
          const productsRef = collection(window.db, 'shops', shopId, 'products');
          const productsSnapshot = await getDocs(productsRef);
          
          productsSnapshot.forEach(productDoc => {
            allProducts.push({
              id: productDoc.id,
              shopId: shopId,
              shopName: shopData.shopName || 'Local Shop',
              shopOwnerId: shopData.ownerId,
              ...productDoc.data()
            });
          });
          
        } catch (error) {
          console.error(`‚ùå Error loading all products from ${shopId}:`, error);
        }
      }
      
      console.log(`‚úÖ Loaded ${allProducts.length} products (including out-of-stock)`);
    }
    
    // Shuffle products for variety
    allProducts = shuffleArray(allProducts);
    
    // Take top 4 products
    featuredProducts = allProducts.slice(0, 4);
    
    console.log('‚úÖ Featured products selected:', featuredProducts.length);
    console.log('üìã Featured products:', featuredProducts.map(p => p.name));
    
    // Render products
    if (featuredProducts.length > 0) {
      renderFeaturedProducts();
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (containerDiv) containerDiv.style.display = 'flex';
    } else {
      // Show empty state
      if (loadingDiv) loadingDiv.style.display = 'none';
      if (emptyDiv) emptyDiv.style.display = 'block';
    }
    
  } catch (error) {
    console.error('‚ùå Error loading featured products:', error);
    alert('Error loading featured products: ' + error.message);
    if (loadingDiv) loadingDiv.style.display = 'none';
    if (emptyDiv) emptyDiv.style.display = 'block';
  }
}
/**
 * Render Featured Products (UPDATED - Remove on minus when qty=1)
 */
 function renderFeaturedProducts() {
  const container = document.getElementById('featuredProductsContainer');
  if (!container) return;
  
  let html = '';
  
  const gradients = [
    'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)',
    'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)',
    'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)',
    'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)'
  ];
  
  const icons = [
    '<i class="bi bi-box-seam" style="font-size: 3rem; color: #1976d2;"></i>',
    '<i class="bi bi-basket" style="font-size: 3rem; color: #7b1fa2;"></i>',
    '<i class="bi bi-bag-heart" style="font-size: 3rem; color: #e65100;"></i>',
    '<i class="bi bi-gift" style="font-size: 3rem; color: #2e7d32;"></i>'
  ];
  
  featuredProducts.forEach((product, index) => {
    const gradient = gradients[index % gradients.length];
    const icon = icons[index % icons.length];
    
    // Check if product is in cart
    const cartItem = cart.items.find(item => item.id === product.id);
    const inCart = !!cartItem;
    const quantity = cartItem ? cartItem.quantity : 0;
    const stock = product.stock || 0;
    const price = product.price || 0;
    
    html += `
      <div class="col-md-3 col-6">
        <div class="card h-100" 
             style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; cursor: pointer; transition: transform 0.2s;" 
             onmouseover="this.style.transform='translateY(-5px)'" 
             onmouseout="this.style.transform='translateY(0)'">
          
          <!-- Product Image Placeholder -->
          <div onclick="navigateToShopProducts('${product.shopId}', '${escapeHtml(product.shopName)}')" 
               style="background: ${gradient}; height: 150px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
            ${icon}
          </div>
          
          <!-- Product Details -->
          <div class="card-body">
            <h6 class="mb-2" style="font-weight: 600; color: #333;" title="${escapeHtml(product.name)}">
              ${escapeHtml(truncateText(product.name, 30))}
            </h6>
            
            <p class="text-muted mb-1" style="font-size: 0.8rem;">
              <i class="bi bi-shop me-1"></i>${escapeHtml(product.shopName)}
            </p>
            
            ${product.brand ? `<p class="text-muted mb-2" style="font-size: 0.75rem;"><strong>Brand:</strong> ${escapeHtml(product.brand)}</p>` : ''}
            
            <div class="d-flex justify-content-between align-items-center">
              <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">‚Çπ${formatPrice(price)}</span>
              
              ${inCart ? `
                <!-- ‚úÖ UPDATED: Quantity Stepper (No disabled, red trash when qty=1) -->
                <div class="quantity-stepper" style="transform: scale(0.85); display: flex; gap: 8px; align-items: center;">
                  <button 
                    onclick="event.stopPropagation(); updateCartQuantity('${product.id}', -1)" 
                    title="${quantity <= 1 ? 'Remove from cart' : 'Decrease quantity'}"
                    style="
                      background: ${quantity <= 1 ? '#dc3545' : '#ffc107'};
                      color: white;
                      border: none;
                      border-radius: 6px;
                      width: 32px;
                      height: 32px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                    onmouseover="this.style.transform='scale(1.1)'"
                    onmouseout="this.style.transform='scale(1)'">
                    <i class="bi bi-${quantity <= 1 ? 'trash' : 'dash'}"></i>
                  </button>
                  <span style="font-weight: 600; min-width: 20px; text-align: center;">${quantity}</span>
                  <button 
                    onclick="event.stopPropagation(); updateCartQuantity('${product.id}', 1)" 
                    ${quantity >= stock ? 'disabled' : ''}
                    title="${quantity >= stock ? 'Stock limit reached' : 'Increase quantity'}"
                    style="
                      background: ${quantity >= stock ? '#ccc' : '#25D366'};
                      color: white;
                      border: none;
                      border-radius: 6px;
                      width: 32px;
                      height: 32px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      cursor: ${quantity >= stock ? 'not-allowed' : 'pointer'};
                      transition: all 0.2s;
                    "
                    ${quantity < stock ? "onmouseover=\"this.style.transform='scale(1.1)'\" onmouseout=\"this.style.transform='scale(1)'\"" : ''}>
                    <i class="bi bi-plus"></i>
                  </button>
                </div>
              ` : `
                <!-- Add to Cart Button -->
                <button onclick="event.stopPropagation(); addToCartFromFeatured('${product.id}')" 
                        class="btn btn-sm" 
                        style="background: ${stock > 0 ? '#25D366' : '#ccc'}; color: white; border: none; border-radius: 6px; padding: 4px 12px;"
                        ${stock <= 0 ? 'disabled' : ''}>
                  <i class="bi bi-cart-plus"></i>
                </button>
              `}
            </div>
            
            ${stock <= 0 ? '<p class="text-danger mt-2 mb-0" style="font-size: 0.75rem;"><i class="bi bi-x-circle"></i> Out of stock</p>' : ''}
          </div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('‚úÖ Featured products rendered');
}


/**
 * Add to Cart from Featured Products
 */
function addToCartFromFeatured(productId) {
  console.log('üõí Adding to cart from featured:', productId);
  
  const product = featuredProducts.find(p => p.id === productId);
  if (!product) {
    console.error('‚ùå Product not found:', productId);
    return;
  }
  
  // Use existing addToCart function
  if (typeof addToCart === 'function') {
    addToCart(product);
    
    // Re-render featured products to show stepper
    setTimeout(() => {
      renderFeaturedProducts();
    }, 100);
  } else {
    alert('‚ö†Ô∏è Cart functionality not available. Please refresh the page.');
  }
}

/**
 * Get Cart Item (Helper)
 */
function getCartItem(productId) {
  return cart.items.find(item => item.id === productId);
}

/**
 * Scroll to Shops Section
 */
function scrollToShops() {
  const shopsSection = document.getElementById('shopsSection');
  if (shopsSection) {
    shopsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

/**
 * Shuffle Array (for random product selection)
 */
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

/**
 * Truncate Text (for long product names)
 */
function truncateText(text, maxLength) {
  if (!text) return '';
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

/**
 * Format Price
 */
function formatPrice(price) {
  if (typeof price !== 'number') return '0.00';
  return price.toFixed(2);
}

/**
 * Refresh Featured Products Display (when cart updates)
 */
function refreshFeaturedProductsDisplay() {
  // Check if we're on the homepage and featured products are loaded
  const mainApp = document.getElementById('mainApp');
  const isOnHomepage = mainApp && mainApp.style.display === 'block' && mainApp.classList.contains('active');
  
  if (isOnHomepage && featuredProducts && featuredProducts.length > 0) {
    if (typeof renderFeaturedProducts === 'function') {
      console.log('üîÑ Refreshing featured products display');
      renderFeaturedProducts();
    }
  }
}

// Make functions global
window.loadFeaturedProducts = loadFeaturedProducts;
window.renderFeaturedProducts = renderFeaturedProducts;
window.addToCartFromFeatured = addToCartFromFeatured;
window.getCartItem = getCartItem;
window.scrollToShops = scrollToShops;
window.shuffleArray = shuffleArray;
window.truncateText = truncateText;
window.formatPrice = formatPrice;
window.refreshFeaturedProductsDisplay = refreshFeaturedProductsDisplay;

console.log('‚úÖ Featured products management loaded (FIXED VERSION)');



/**
 * ==========================================
 * MOBILE BOTTOM NAVIGATION (ROLE-BASED)
 * ==========================================
 */

// Global variables
let currentMobileTab = 'home';

/**
 * Initialize Mobile Bottom Navigation (UPDATED - Role-based)
 */
function initializeMobileBottomNav() {
  console.log('üì± Initializing mobile bottom navigation...');
  
  if (!window.currentUser) {
    console.log('‚ö†Ô∏è No user signed in');
    hideMobileBottomNav();
    hideShopownerMobileBottomNav();
    return;
  }
  
  // Check if mobile
  if (!isMobileDevice()) {
    console.log('‚ö†Ô∏è Not a mobile device');
    hideMobileBottomNav();
    hideShopownerMobileBottomNav();
    return;
  }
  
  // Show appropriate nav based on role
  if (window.currentUser.role === 'customer') {
    console.log('‚úÖ Showing customer mobile nav');
    showMobileBottomNav();
    hideShopownerMobileBottomNav();
    updateMobileCartBadge();
    switchMobileTab('home', false);
  } else if (window.currentUser.role === 'shopowner') {
    console.log('‚úÖ Showing shopowner mobile nav');
    hideShopownerMobileBottomNav();
    showShopownerMobileBottomNav();
    updateMobileOrdersBadge();
    switchShopownerMobileTab('home', false);
  } else {
    hideMobileBottomNav();
    hideShopownerMobileBottomNav();
  }
  
  console.log('‚úÖ Mobile bottom navigation initialized');
}

/**
 * Check if Mobile Device
 */
function isMobileDevice() {
  return window.innerWidth <= 767;
}

/**
 * Show Mobile Bottom Navigation (Customer)
 */
function showMobileBottomNav() {
  const bottomNav = document.getElementById('mobileBottomNav');
  if (bottomNav) {
    bottomNav.style.display = 'flex';
    document.body.classList.add('mobile-customer-view');
    console.log('‚úÖ Customer mobile bottom nav shown');
  }
}

/**
 * Hide Mobile Bottom Navigation (Customer)
 */
function hideMobileBottomNav() {
  const bottomNav = document.getElementById('mobileBottomNav');
  if (bottomNav) {
    bottomNav.style.display = 'none';
    document.body.classList.remove('mobile-customer-view');
    console.log('üö´ Customer mobile bottom nav hidden');
  }
}

/**
 * Show Shopowner Mobile Bottom Navigation (NEW)
 */
function showShopownerMobileBottomNav() {
  const bottomNav = document.getElementById('mobileBottomNavShopowner');
  if (bottomNav) {
    bottomNav.style.display = 'flex';
    document.body.classList.add('mobile-shopowner-view');
    console.log('‚úÖ Shopowner mobile bottom nav shown');
  }
}

/**
 * Hide Shopowner Mobile Bottom Navigation (NEW)
 */
function hideShopownerMobileBottomNav() {
  const bottomNav = document.getElementById('mobileBottomNavShopowner');
  if (bottomNav) {
    bottomNav.style.display = 'none';
    document.body.classList.remove('mobile-shopowner-view');
    console.log('üö´ Shopowner mobile bottom nav hidden');
  }
}

/**
 * Switch Mobile Tab (Customer)
 */
function switchMobileTab(tabName, updateHistory = true) {
  console.log('üîÑ Switching to customer tab:', tabName);
  
  // Update active tab
  const allTabs = document.querySelectorAll('#mobileBottomNav .nav-tab');
  allTabs.forEach(tab => {
    if (tab.dataset.tab === tabName) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });
  
  // Hide all pages
  hideAllPages();
  
  // Show selected page
  switch (tabName) {
    case 'home':
      console.log('üì± Showing home page');
      showPage('mainApp');
      break;
      
    case 'orders':
      console.log('üì± Showing orders page');
      showPage('myOrdersPage');
      setTimeout(() => {
        if (typeof loadMyOrders === 'function') {
          loadMyOrders();
        } else if (typeof loadCustomerOrders === 'function') {
          loadCustomerOrders();
        } else {
          loadOrdersDirectly();
        }
      }, 100);
      break;
      
    case 'cart':
      console.log('üì± Showing cart page');
      showPage('cartPage');
      if (typeof updateCartPage === 'function') {
        updateCartPage();
      }
      break;
      
    case 'settings':
      console.log('üì± Showing settings page');
      showPage('mobileSettingsPage');
      break;
  }
  
  currentMobileTab = tabName;
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  if (updateHistory) {
    window.location.hash = '#mobile-' + tabName;
  }
  
  console.log('‚úÖ Switched to customer tab:', tabName);
}

/**
 * Switch Shopowner Mobile Tab (NEW)
 */
function switchShopownerMobileTab(tabName, updateHistory = true) {
  console.log('üîÑ Switching to shopowner tab:', tabName);
  
  // Update active tab
  const allTabs = document.querySelectorAll('#mobileBottomNavShopowner .nav-tab');
  allTabs.forEach(tab => {
    if (tab.dataset.tab === tabName) {
      tab.classList.add('active');
    } else {
      tab.classList.remove('active');
    }
  });
  
  // Hide all pages
  hideAllPages();
  
  // Show selected page
  switch (tabName) {
    case 'home':
      console.log('üì± Showing home page (shopowner)');
      showPage('mainApp');
      break;
      
    case 'orders-received':
      console.log('üì± Showing orders received page');
      showPage('ordersReceivedPage');
      setTimeout(() => {
        loadShopOrders();
      }, 100);
      break;
      
    case 'settings':
      console.log('üì± Showing settings page (shopowner)');
      showPage('mobileSettingsPage');
      break;
  }
  
  currentMobileTab = tabName;
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  if (updateHistory) {
    window.location.hash = '#mobile-shopowner-' + tabName;
  }
  
  console.log('‚úÖ Switched to shopowner tab:', tabName);
}

/**
 * Hide All Pages (Helper)
 */
function hideAllPages() {
  const pages = [
    'mainApp', 
    'cartPage', 
    'myOrdersPage', 
    'shopProductsPage', 
    'mobileSettingsPage',
    'ordersReceivedPage'
  ];
  
  pages.forEach(pageId => {
    const page = document.getElementById(pageId);
    if (page) {
      page.style.display = 'none';
      page.classList.remove('active');
    }
  });
}

/**
 * Show Page (Helper)
 */
function showPage(pageId) {
  const page = document.getElementById(pageId);
  if (page) {
    page.style.display = 'block';
    page.classList.add('active');
  }
}
/**
 * Load Shop Orders (Shopowner) - UPDATED to show ALL orders for ANY shopowner
 */
 async function loadShopOrders() {
  console.log('üì¶ Loading ALL shop orders (Global View)...');
  console.log('========================================');
  
  const ordersList = document.getElementById('shopOrdersList');
  const emptyState = document.getElementById('shopOrdersEmptyState');
  
  if (!ordersList) {
    console.error('‚ùå shopOrdersList element not found');
    return;
  }
  
  // Show loading
  ordersList.innerHTML = `
    <div style="text-align:center; padding:40px;">
      <div class="spinner-border text-success" role="status"></div>
      <p class="mt-3">Loading all orders...</p>
    </div>
  `;
  
  // ‚úÖ CHECK USER
  if (!window.currentUser) {
    console.error('‚ùå No user signed in');
    ordersList.innerHTML = `
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i> Please sign in to view orders.
      </div>
    `;
    return;
  }
  
  // ‚úÖ LOG USER DETAILS
  console.log('üë§ Current User Details:');
  console.log('  - UID:', window.currentUser.uid);
  console.log('  - Email:', window.currentUser.email);
  console.log('  - Role:', window.currentUser.role);
  console.log('========================================');
  
  if (window.currentUser.role !== 'shopowner') {
    console.error('‚ùå User is not a shopowner');
    ordersList.innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-x-circle"></i> Only shopowners can view this page.
      </div>
    `;
    return;
  }
  
  try {
    const { collection, collectionGroup, query, getDocs, orderBy } = window.firebaseImports;
    
    console.log('üîç Loading ALL orders from ALL shops...');
    console.log('========================================');
    
    // ‚úÖ METHOD 1: Get ALL orders using collectionGroup (no filter)
    try {
      console.log('üì¶ Method 1: CollectionGroup query for ALL orders...');
      
      const ordersRef = collectionGroup(window.db, 'orders');
      const q = query(
        ordersRef,
        orderBy('createdAt', 'desc')
      );
      
      const querySnapshot = await getDocs(q);
      
      console.log('‚úÖ Query successful! Found', querySnapshot.size, 'total orders');
      
      if (querySnapshot.size > 0) {
        const allOrders = [];
        
        querySnapshot.forEach((doc) => {
          const orderData = doc.data();
          
          console.log('  üìÑ Order:', doc.id);
          console.log('    - Shop:', orderData.shopName);
          console.log('    - Status:', orderData.status);
          console.log('    - Customer:', orderData.customerName || orderData.deliveryAddress?.name);
          console.log('    - Total:', orderData.totalAmount || orderData.total);
          
          allOrders.push({
            id: doc.id,
            ...orderData,
            // Convert Firestore Timestamp
            createdAt: orderData.createdAt?.toDate ? orderData.createdAt.toDate().toISOString() : orderData.createdAt,
            placedAt: orderData.placedAt?.toDate ? orderData.placedAt.toDate().toISOString() : orderData.placedAt
          });
        });
        
        console.log('========================================');
        console.log('‚úÖ Total orders loaded:', allOrders.length);
        console.log('========================================');
        
        if (emptyState) emptyState.style.display = 'none';
        
        window.allShopOrders = allOrders;
        updateShopOrderStats(allOrders);
        renderShopOrders(allOrders);
        updateMobileOrdersBadge();
        
        console.log('‚úÖ All orders rendered successfully!');
        return;
      }
      
    } catch (method1Error) {
      console.warn('‚ö†Ô∏è Method 1 failed:', method1Error.message);
      console.log('Trying Method 2 (fallback)...');
    }
    
    // ‚úÖ METHOD 2: Get all shops, then query each shop's orders
    console.log('üì¶ Method 2: Query each shop individually...');
    console.log('========================================');
    
    const shopsRef = collection(window.db, 'shops');
    const shopsSnapshot = await getDocs(shopsRef);
    
    console.log('üè™ Found', shopsSnapshot.size, 'total shops in system');
    
    const allOrders = [];
    
    for (const shopDoc of shopsSnapshot.docs) {
      const shopData = shopDoc.data();
      console.log('  üè™ Shop:', shopDoc.id, '‚Üí', shopData.shopName);
      
      const shopOrdersRef = collection(window.db, 'shops', shopDoc.id, 'orders');
      const shopOrdersSnapshot = await getDocs(shopOrdersRef);
      
      console.log('    ‚úÖ Found', shopOrdersSnapshot.size, 'orders');
      
      shopOrdersSnapshot.forEach(orderDoc => {
        const orderData = orderDoc.data();
        
        console.log('      üìÑ Order:', orderDoc.id);
        console.log('        - Status:', orderData.status);
        console.log('        - Customer:', orderData.customerName || orderData.deliveryAddress?.name);
        console.log('        - Total:', orderData.totalAmount || orderData.total);
        
        allOrders.push({
          id: orderDoc.id,
          shopId: shopDoc.id,
          shopName: shopData.shopName,
          ...orderData,
          createdAt: orderData.createdAt?.toDate ? orderData.createdAt.toDate().toISOString() : orderData.createdAt,
          placedAt: orderData.placedAt?.toDate ? orderData.placedAt.toDate().toISOString() : orderData.placedAt
        });
      });
    }
    
    console.log('========================================');
    console.log('‚úÖ Total orders found:', allOrders.length);
    console.log('========================================');
    
    // ‚úÖ IF NO ORDERS: Show empty state
    if (allOrders.length === 0) {
      console.log('üì≠ No orders found in entire system');
      ordersList.innerHTML = '';
      if (emptyState) emptyState.style.display = 'block';
      
      updateShopOrderStats([]);
      updateMobileOrdersBadge();
      return;
    }
    
    // ‚úÖ Sort by date (newest first)
    allOrders.sort((a, b) => {
      const dateA = a.createdAt ? new Date(a.createdAt) : (a.placedAt ? new Date(a.placedAt) : new Date(0));
      const dateB = b.createdAt ? new Date(b.createdAt) : (b.placedAt ? new Date(b.placedAt) : new Date(0));
      return dateB - dateA;
    });
    
    if (emptyState) emptyState.style.display = 'none';
    
    // ‚úÖ Store and render
    window.allShopOrders = allOrders;
    updateShopOrderStats(allOrders);
    renderShopOrders(allOrders);
    updateMobileOrdersBadge();
    
    console.log('‚úÖ All orders loaded and rendered successfully!');
    
  } catch (error) {
    console.error('‚ùå Error loading orders:', error);
    console.error('Error details:', {
      code: error.code,
      message: error.message,
      stack: error.stack
    });
    
    ordersList.innerHTML = `
      <div class="alert alert-danger" style="margin: 20px;">
        <h5><i class="bi bi-x-circle"></i> Error Loading Orders</h5>
        <p><strong>Error:</strong> ${error.message}</p>
        <button class="btn btn-sm btn-primary mt-2" onclick="loadShopOrders()">
          <i class="bi bi-arrow-clockwise me-1"></i>Retry
        </button>
      </div>
    `;
  }
}

// Make it global
window.loadShopOrders = loadShopOrders;

console.log('‚úÖ Shop orders (Global View) functions loaded');


/**
 * Navigate to Manage Shops (Helper)
 */
function navigateToManageShops() {
  console.log('üìç Navigating to Manage Shops...');
  
  // If on mobile, go back to home and open sidebar
  if (isMobileDevice()) {
    switchShopownerMobileTab('home');
    
    // Wait a bit then open sidebar
    setTimeout(() => {
      const sidebar = document.getElementById('sideNav');
      if (sidebar) {
        sidebar.classList.add('open');
      }
    }, 300);
  } else {
    // Desktop: Navigate to manage shops
    if (typeof navigateToShops === 'function') {
      navigateToShops();
    } else {
      alert('Please use the sidebar to navigate to "Manage Shops"');
    }
  }
}

// Make functions global
window.loadShopOrders = loadShopOrders;
window.navigateToManageShops = navigateToManageShops;

console.log('‚úÖ Shop orders functions loaded');


/**
 * Update Shop Order Statistics (UPDATED)
 */
function updateShopOrderStats(orders) {
  console.log('üìä Updating shop order stats...');
  
  const pending = orders.filter(o => o.status === 'pending').length;
  const accepted = orders.filter(o => o.status === 'accepted').length;
  const delivered = orders.filter(o => o.status === 'delivered').length;
  
  console.log('Stats:', { total: orders.length, pending, accepted, delivered });
  
  const pendingEl = document.getElementById('shopPendingCount');
  const acceptedEl = document.getElementById('shopAcceptedCount');
  const deliveredEl = document.getElementById('shopDeliveredCount');
  
  if (pendingEl) pendingEl.textContent = pending;
  if (acceptedEl) acceptedEl.textContent = accepted;
  if (deliveredEl) deliveredEl.textContent = delivered;
  
  console.log('‚úÖ Stats updated');
}

/**
 * Render Shop Orders (UPDATED with Accept + Delivered buttons)
 */
 function renderShopOrders(orders) {
  console.log('üé® Rendering', orders.length, 'shop orders');
  
  const container = document.getElementById('shopOrdersList');
  if (!container) {
    console.error('‚ùå shopOrdersList not found');
    return;
  }
  
  if (orders.length === 0) {
    container.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No orders match your filter.
      </div>
    `;
    return;
  }
  
  let html = '';
  
  orders.forEach(order => {
    const statusColor = getOrderStatusColor(order.status);
    const statusText = getOrderStatusText(order.status);
    
    // ‚úÖ Format date properly
    let orderDate = 'N/A';
    let orderTime = '';
    
    if (order.createdAt || order.placedAt) {
      try {
        const date = new Date(order.createdAt || order.placedAt);
        orderDate = date.toLocaleDateString('en-IN', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric' 
        });
        orderTime = date.toLocaleTimeString('en-IN', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      } catch (e) {
        console.warn('Error formatting date:', e);
      }
    }
    
    // ‚úÖ Check order status for button display
    const isPending = order.status === 'pending';
    const canDeliver = ['accepted', 'preparing', 'ready'].includes(order.status);
    const isDelivered = order.status === 'delivered';
    
    html += `
      <div class="card mb-2" style="border-radius: 10px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
        <div class="card-body" style="padding: 12px;">
          
          <!-- Order Header -->
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 style="font-weight: 700; margin: 0; font-size: 0.9rem; color: #333;">
                <i class="bi bi-receipt"></i> #${order.id.slice(-8)}
              </h6>
              <small class="text-muted" style="font-size: 0.75rem;">
                <i class="bi bi-calendar3"></i> ${orderDate}
                ${orderTime ? `<i class="bi bi-clock ms-2"></i> ${orderTime}` : ''}
              </small>
            </div>
            <span class="badge" style="background: ${statusColor}; font-size: 0.75rem; padding: 4px 8px;">
              ${statusText}
            </span>
          </div>
          
          <!-- Shop Name -->
          <p style="margin: 5px 0; font-size: 0.85rem;">
            <i class="bi bi-shop"></i> <strong>${escapeHtml(order.shopName || 'Shop')}</strong>
          </p>
          
          <!-- Customer Info -->
          <p style="margin: 5px 0; font-size: 0.85rem;">
            <i class="bi bi-person"></i> ${escapeHtml(order.customerName || order.deliveryAddress?.name || 'Customer')}
          </p>
          
          <!-- Items Count -->
          <p style="margin: 5px 0; font-size: 0.85rem;">
            <i class="bi bi-box-seam"></i> ${order.items ? order.items.length : 0} item${order.items && order.items.length !== 1 ? 's' : ''}
          </p>
          
          <!-- Total & Actions -->
          <div class="d-flex justify-content-between align-items-center mt-2 gap-2">
            <span style="font-size: 1.1rem; font-weight: 700; color: #25D366;">
              ‚Çπ${(order.totalAmount || order.total || 0).toFixed(2)}
            </span>
            <div class="d-flex gap-2">
              ${isPending ? `
                <!-- ‚úÖ ACCEPT BUTTON (Only for pending orders) -->
                <button 
                  class="btn btn-sm btn-success" 
                  onclick="acceptOrder('${order.id}', '${order.shopId || ''}')" 
                  style="border-radius: 6px; font-size: 0.8rem; padding: 4px 12px; white-space: nowrap;"
                  id="acceptBtn_${order.id}">
                  <i class="bi bi-check-circle"></i> Accept
                </button>
              ` : ''}
              ${canDeliver ? `
                <!-- ‚úÖ DELIVERED BUTTON (For accepted/preparing/ready orders) -->
                <button 
                  class="btn btn-sm btn-primary" 
                  onclick="deliverOrder('${order.id}', '${order.shopId || ''}')" 
                  style="border-radius: 6px; font-size: 0.8rem; padding: 4px 12px; white-space: nowrap; background: #28a745; border-color: #28a745;"
                  id="deliverBtn_${order.id}"
                  onmouseover="this.style.background='#218838'"
                  onmouseout="this.style.background='#28a745'">
                  <i class="bi bi-check-circle-fill"></i> Delivered
                </button>
              ` : ''}
              <!-- VIEW BUTTON -->
              <button 
                class="btn btn-sm btn-primary" 
                onclick="viewShopOrderDetails('${order.id}')" 
                style="border-radius: 6px; font-size: 0.8rem; padding: 4px 12px;">
                <i class="bi bi-eye"></i> View
              </button>
            </div>
          </div>
          
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('‚úÖ Rendered', orders.length, 'orders with action buttons');
}



/**
 * Filter Shop Orders (UPDATED)
 */
function filterShopOrders(status) {
  console.log('üîç Filtering orders by:', status);
  
  if (!window.allShopOrders) {
    console.warn('‚ö†Ô∏è No orders to filter');
    return;
  }
  
  if (status === 'all') {
    renderShopOrders(window.allShopOrders);
    console.log('‚úÖ Showing all', window.allShopOrders.length, 'orders');
  } else {
    const filtered = window.allShopOrders.filter(o => o.status === status);
    renderShopOrders(filtered);
    console.log('‚úÖ Showing', filtered.length, 'orders with status:', status);
  }
}

/**
 * View Shop Order Details (UPDATED with Accept + Delivered buttons in modal)
 */
 function viewShopOrderDetails(orderId) {
  console.log('üëÄ Viewing detailed order:', orderId);
  
  const order = window.allShopOrders ? window.allShopOrders.find(o => o.id === orderId) : null;
  
  if (!order) {
    alert('‚ùå Order not found!');
    return;
  }
  
  // Format dates
  let orderDate = 'N/A';
  let orderTime = '';
  
  if (order.createdAt || order.placedAt) {
    try {
      const date = new Date(order.createdAt || order.placedAt);
      orderDate = date.toLocaleDateString('en-IN', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
      });
      orderTime = date.toLocaleTimeString('en-IN', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
    } catch (e) {
      console.warn('Error formatting date:', e);
    }
  }
  
  // Get status badge
  const statusColor = getOrderStatusColor(order.status);
  const statusText = getOrderStatusText(order.status);
  
  // Format items list
  let itemsHtml = '';
  if (order.items && order.items.length > 0) {
    order.items.forEach((item, index) => {
      const itemTotal = (item.price || 0) * (item.quantity || 0);
      itemsHtml += `
        <div class="d-flex justify-content-between align-items-start mb-2 pb-2" style="border-bottom: 1px solid #f0f0f0;">
          <div style="flex: 1;">
            <div style="font-weight: 600; color: #333;">${index + 1}. ${escapeHtml(item.name || 'Item')}</div>
            ${item.brand ? `<small class="text-muted"><i class="bi bi-tag"></i> ${escapeHtml(item.brand)}</small><br>` : ''}
            ${item.size ? `<small class="text-muted"><i class="bi bi-rulers"></i> ${escapeHtml(item.size)}</small><br>` : ''}
            <small class="text-muted">‚Çπ${(item.price || 0).toFixed(2)} √ó ${item.quantity || 0}</small>
          </div>
          <div style="font-weight: 700; color: #25D366;">
            ‚Çπ${itemTotal.toFixed(2)}
          </div>
        </div>
      `;
    });
  } else {
    itemsHtml = '<p class="text-muted">No items</p>';
  }
  
  // Build modal content (same as before)
  const modalBody = document.getElementById('shopOrderDetailsBody');
  if (!modalBody) {
    console.error('Modal body not found');
    return;
  }
  
  modalBody.innerHTML = `
    <!-- Order ID & Status -->
    <div style="padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #dee2e6;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 style="margin: 0; font-weight: 700; color: #333;">
          Order #${order.id.slice(-8)}
        </h6>
        <span class="badge" style="background: ${statusColor}; font-size: 0.85rem; padding: 6px 12px;">
          ${statusText}
        </span>
      </div>
      <small class="text-muted">
        <i class="bi bi-calendar3"></i> ${orderDate}<br>
        <i class="bi bi-clock"></i> ${orderTime}
      </small>
    </div>
    
    <!-- Shop Information -->
    <div style="padding: 15px; border-bottom: 1px solid #eee;">
      <h6 style="font-weight: 700; color: #333; margin-bottom: 10px;">
        <i class="bi bi-shop"></i> Shop Information
      </h6>
      <p style="margin: 5px 0; font-size: 0.9rem;">
        <strong>Shop Name:</strong> ${escapeHtml(order.shopName || 'N/A')}
      </p>
      ${order.shopId ? `<p style="margin: 5px 0; font-size: 0.85rem; color: #666;"><strong>Shop ID:</strong> <code>${order.shopId}</code></p>` : ''}
      ${order.shopOwnerId ? `<p style="margin: 5px 0; font-size: 0.85rem; color: #666;"><strong>Owner ID:</strong> <code>${order.shopOwnerId.slice(0, 10)}...</code></p>` : ''}
    </div>
    
    <!-- Customer Information -->
    <div style="padding: 15px; border-bottom: 1px solid #eee;">
      <h6 style="font-weight: 700; color: #333; margin-bottom: 10px;">
        <i class="bi bi-person-circle"></i> Customer Information
      </h6>
      <p style="margin: 5px 0; font-size: 0.9rem;">
        <strong><i class="bi bi-person"></i> Name:</strong> ${escapeHtml(order.customerName || order.deliveryAddress?.name || 'N/A')}
      </p>
      ${order.customerId ? `<p style="margin: 5px 0; font-size: 0.85rem; color: #666;"><strong>Customer ID:</strong> <code>${order.customerId.slice(0, 10)}...</code></p>` : ''}
    </div>
    
    <!-- Delivery Address -->
    <div style="padding: 15px; border-bottom: 1px solid #eee;">
      <h6 style="font-weight: 700; color: #333; margin-bottom: 10px;">
        <i class="bi bi-geo-alt-fill"></i> Delivery Address
      </h6>
      ${order.deliveryAddress ? `
        <p style="margin: 5px 0; font-size: 0.9rem; line-height: 1.6;">
          <strong><i class="bi bi-house-door"></i> Address:</strong><br>
          ${escapeHtml(order.deliveryAddress.fullAddress || 'N/A')}
        </p>
        <p style="margin: 5px 0; font-size: 0.9rem;">
          <strong><i class="bi bi-telephone"></i> Phone:</strong> 
          <a href="tel:${order.deliveryAddress.phone}" style="color: #25D366; text-decoration: none; font-weight: 600;">
            ${escapeHtml(order.deliveryAddress.phone || 'N/A')}
          </a>
        </p>
      ` : '<p class="text-muted">No delivery address provided</p>'}
    </div>
    
    <!-- Order Items -->
    <div style="padding: 15px; border-bottom: 1px solid #eee;">
      <h6 style="font-weight: 700; color: #333; margin-bottom: 15px;">
        <i class="bi bi-box-seam"></i> Order Items (${order.items ? order.items.length : 0})
      </h6>
      ${itemsHtml}
    </div>
    
    <!-- Price Breakdown -->
    <div style="padding: 15px; background: #f8f9fa;">
      <h6 style="font-weight: 700; color: #333; margin-bottom: 15px;">
        <i class="bi bi-calculator"></i> Price Details
      </h6>
      
      <div class="d-flex justify-content-between mb-2">
        <span>Subtotal (${order.items ? order.items.length : 0} items)</span>
        <span style="font-weight: 600;">‚Çπ${(order.subtotal || order.totalAmount || 0).toFixed(2)}</span>
      </div>
      
      <div class="d-flex justify-content-between mb-2">
        <span>Tax & GST</span>
        <span style="font-weight: 600;">‚Çπ${(order.tax || 0).toFixed(2)}</span>
      </div>
      
      <div class="d-flex justify-content-between mb-2">
        <span>Delivery Charges</span>
        <span style="font-weight: 600; color: #25D366;">FREE</span>
      </div>
      
      <hr style="margin: 10px 0;">
      
      <div class="d-flex justify-content-between" style="font-size: 1.1rem;">
        <strong>Total Amount</strong>
        <strong style="color: #25D366; font-size: 1.3rem;">‚Çπ${(order.totalAmount || order.total || 0).toFixed(2)}</strong>
      </div>
    </div>
    
    <!-- Payment Method -->
    <div style="padding: 15px; border-top: 1px solid #eee;">
      <div class="d-flex align-items-center justify-content-between">
        <span style="font-weight: 600;">
          <i class="bi bi-cash-coin"></i> Payment Method
        </span>
        <span class="badge bg-warning text-dark" style="font-size: 0.9rem; padding: 6px 12px;">
          <i class="bi bi-cash"></i> ${order.paymentMethod || 'Cash on Delivery'}
        </span>
      </div>
    </div>
    
    <!-- Additional Info -->
    ${order.deliveryTime || order.orderNotes ? `
      <div style="padding: 15px; border-top: 1px solid #eee;">
        <h6 style="font-weight: 700; color: #333; margin-bottom: 10px;">
          <i class="bi bi-info-circle"></i> Additional Information
        </h6>
        ${order.deliveryTime ? `
          <p style="margin: 5px 0; font-size: 0.9rem;">
            <strong><i class="bi bi-clock"></i> Delivery Time:</strong> ${escapeHtml(order.deliveryTime)}
          </p>
        ` : ''}
        ${order.orderNotes ? `
          <p style="margin: 5px 0; font-size: 0.9rem;">
            <strong><i class="bi bi-sticky"></i> Notes:</strong> ${escapeHtml(order.orderNotes)}
          </p>
        ` : ''}
      </div>
    ` : ''}
    
    <!-- Order ID (Full) -->
    <div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #eee;">
      <small class="text-muted">
        <strong>Full Order ID:</strong><br>
        <code style="font-size: 0.75rem; word-break: break-all;">${order.id}</code>
      </small>
    </div>
  `;
  
  // ‚úÖ UPDATE MODAL FOOTER based on order status
  const modalFooter = document.querySelector('#shopOrderDetailsModal .modal-footer');
  if (modalFooter) {
    if (order.status === 'pending') {
      // Show Accept button for pending orders
      modalFooter.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">
          <i class="bi bi-x-circle"></i> Close
        </button>
        <button 
          type="button" 
          class="btn btn-success" 
          onclick="acceptOrderFromModal('${order.id}', '${order.shopId || ''}')" 
          style="border-radius: 8px;"
          id="modalAcceptBtn">
          <i class="bi bi-check-circle"></i> Accept Order
        </button>
      `;
    } else if (['accepted', 'preparing', 'ready'].includes(order.status)) {
      // Show Delivered button for accepted/preparing/ready orders
      modalFooter.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">
          <i class="bi bi-x-circle"></i> Close
        </button>
        <button 
          type="button" 
          class="btn btn-success" 
          onclick="deliverOrderFromModal('${order.id}', '${order.shopId || ''}')" 
          style="border-radius: 8px; background: #28a745; border-color: #28a745;"
          id="modalDeliverBtn">
          <i class="bi bi-check-circle-fill"></i> Mark as Delivered
        </button>
      `;
    } else {
      // Show status badge for delivered/cancelled orders
      modalFooter.innerHTML = `
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">
          <i class="bi bi-x-circle"></i> Close
        </button>
        <span class="badge" style="background: ${statusColor}; font-size: 1rem; padding: 8px 16px;">
          <i class="bi bi-info-circle"></i> Status: ${statusText}
        </span>
      `;
    }
  }
  
  // Store current order ID for reference
  window.currentViewingOrderId = orderId;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('shopOrderDetailsModal'));
  modal.show();
  
  console.log('‚úÖ Order details modal displayed');
}

/**
 * Deliver Order from Modal (with modal close on success)
 */
 async function deliverOrderFromModal(orderId, shopId) {
  console.log('üöö Marking order as delivered from modal:', orderId);
  
  // Get the modal button
  const modalDeliverBtn = document.getElementById('modalDeliverBtn');
  
  if (modalDeliverBtn) {
    modalDeliverBtn.disabled = true;
    modalDeliverBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';
  }
  
  try {
    const order = window.allShopOrders ? window.allShopOrders.find(o => o.id === orderId) : null;
    
    if (!order) {
      alert('‚ùå Order not found!');
      return;
    }
    
    if (order.status === 'delivered') {
      alert('‚ö†Ô∏è This order is already delivered!');
      return;
    }
    
    if (!['accepted', 'preparing', 'ready'].includes(order.status)) {
      alert(`‚ö†Ô∏è Cannot deliver this order!\n\nCurrent status: ${order.status}`);
      return;
    }
    
    const { doc, updateDoc, serverTimestamp } = window.firebaseImports;
    
    const orderRef = doc(window.db, 'shops', shopId, 'orders', orderId);
    
    await updateDoc(orderRef, {
      status: 'delivered',
      deliveredAt: serverTimestamp(),
      deliveredBy: window.currentUser.uid,
      deliveredByName: window.currentUser.displayName || window.currentUser.email || 'Shopowner',
      updatedAt: serverTimestamp()
    });
    
    console.log('‚úÖ Order marked as delivered successfully!');
    
    // Update button
    if (modalDeliverBtn) {
      modalDeliverBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Delivered!';
      modalDeliverBtn.style.background = '#6c757d';
      modalDeliverBtn.style.borderColor = '#6c757d';
    }
    
    // Update local order
    order.status = 'delivered';
    order.deliveredAt = new Date().toISOString();
    order.deliveredBy = window.currentUser.uid;
    order.deliveredByName = window.currentUser.displayName || window.currentUser.email || 'Shopowner';
    
    // Update stats
    updateShopOrderStats(window.allShopOrders);
    updateMobileOrdersBadge();
    
    // Re-render orders
    setTimeout(() => {
      renderShopOrders(window.allShopOrders);
    }, 1000);
    
    // Show success message
    alert('‚úÖ Order Delivered!\n\nOrder has been marked as delivered.');
    
    // Close modal after 1 second
    setTimeout(() => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('shopOrderDetailsModal'));
      if (modal) modal.hide();
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error delivering order:', error);
    alert(`‚ùå Error delivering order:\n\n${error.message}`);
    
    if (modalDeliverBtn) {
      modalDeliverBtn.disabled = false;
      modalDeliverBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Mark as Delivered';
    }
  }
}

// Make functions global
window.viewShopOrderDetails = viewShopOrderDetails;
window.acceptOrderFromModal = acceptOrderFromModal;
window.deliverOrderFromModal = deliverOrderFromModal;

console.log('‚úÖ Order details modal with Accept + Delivered buttons loaded');


/**
 * Accept Order from Modal (with modal close on success)
 */
async function acceptOrderFromModal(orderId, shopId) {
  console.log('‚úÖ Accepting order from modal:', orderId);
  
  // Get the modal button
  const modalAcceptBtn = document.getElementById('modalAcceptBtn');
  
  // Call the main accept function
  if (modalAcceptBtn) {
    modalAcceptBtn.disabled = true;
    modalAcceptBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Accepting...';
  }
  
  try {
    // Use the existing acceptOrder logic
    const order = window.allShopOrders ? window.allShopOrders.find(o => o.id === orderId) : null;
    
    if (!order) {
      alert('‚ùå Order not found!');
      return;
    }
    
    if (order.status !== 'pending') {
      alert(`‚ö†Ô∏è This order is already ${order.status}!`);
      return;
    }
    
    const { doc, updateDoc, serverTimestamp } = window.firebaseImports;
    
    const orderRef = doc(window.db, 'shops', shopId, 'orders', orderId);
    
    await updateDoc(orderRef, {
      status: 'accepted',
      acceptedAt: serverTimestamp(),
      acceptedBy: window.currentUser.uid,
      acceptedByName: window.currentUser.displayName || window.currentUser.email || 'Shopowner',
      updatedAt: serverTimestamp()
    });
    
    console.log('‚úÖ Order accepted successfully!');
    
    // Update button
    if (modalAcceptBtn) {
      modalAcceptBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Accepted!';
      modalAcceptBtn.classList.remove('btn-success');
      modalAcceptBtn.classList.add('btn-secondary');
    }
    
    // Update local order
    order.status = 'accepted';
    order.acceptedAt = new Date().toISOString();
    order.acceptedBy = window.currentUser.uid;
    order.acceptedByName = window.currentUser.displayName || window.currentUser.email || 'Shopowner';
    
    // Update stats
    updateShopOrderStats(window.allShopOrders);
    updateMobileOrdersBadge();
    
    // Re-render orders
    setTimeout(() => {
      renderShopOrders(window.allShopOrders);
    }, 1000);
    
    // Show success message
    alert('‚úÖ Order Accepted!\n\nOrder has been marked as accepted.');
    
    // Close modal after 1 second
    setTimeout(() => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('shopOrderDetailsModal'));
      if (modal) modal.hide();
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Error accepting order:', error);
    alert(`‚ùå Error accepting order:\n\n${error.message}`);
    
    if (modalAcceptBtn) {
      modalAcceptBtn.disabled = false;
      modalAcceptBtn.innerHTML = '<i class="bi bi-check-circle"></i> Accept Order';
    }
  }
}

// Make functions global
window.viewShopOrderDetails = viewShopOrderDetails;
window.acceptOrderFromModal = acceptOrderFromModal;

console.log('‚úÖ Order details modal with Accept button loaded');


/**
 * Update Order Status (Placeholder)
 */
function updateOrderStatus() {
  const orderId = window.currentViewingOrderId;
  
  if (!orderId) {
    alert('No order selected');
    return;
  }
  
  const order = window.allShopOrders.find(o => o.id === orderId);
  if (!order) {
    alert('Order not found');
    return;
  }
  
  // Show status options
  const newStatus = prompt(`Update Order Status\n\nCurrent: ${order.status}\n\nEnter new status:\n- pending\n- accepted\n- preparing\n- ready\n- delivered\n- cancelled`, order.status);
  
  if (!newStatus) return;
  
  const validStatuses = ['pending', 'accepted', 'preparing', 'ready', 'delivered', 'cancelled'];
  
  if (!validStatuses.includes(newStatus.toLowerCase())) {
    alert('Invalid status! Please use: ' + validStatuses.join(', '));
    return;
  }
  
  // TODO: Update status in Firebase
  console.log('üìù Updating order', orderId, 'to status:', newStatus);
  alert(`Status update feature coming soon!\n\nOrder: ${orderId}\nNew Status: ${newStatus}`);
  
  // TODO: Implement Firebase update
  // await updateDoc(doc(db, 'shops', order.shopId, 'orders', orderId), {
  //   status: newStatus,
  //   updatedAt: serverTimestamp()
  // });
}

// Make functions global
window.viewShopOrderDetails = viewShopOrderDetails;
window.updateOrderStatus = updateOrderStatus;

console.log('‚úÖ Order details modal functions loaded');


/**
 * Update Shop Order Statistics
 */
function updateShopOrderStats(orders) {
  const pending = orders.filter(o => o.status === 'pending').length;
  const accepted = orders.filter(o => o.status === 'accepted').length;
  const delivered = orders.filter(o => o.status === 'delivered').length;
  
  const pendingEl = document.getElementById('shopPendingCount');
  const acceptedEl = document.getElementById('shopAcceptedCount');
  const deliveredEl = document.getElementById('shopDeliveredCount');
  
  if (pendingEl) pendingEl.textContent = pending;
  if (acceptedEl) acceptedEl.textContent = accepted;
  if (deliveredEl) deliveredEl.textContent = delivered;
}



/**
 * Filter Shop Orders
 */
function filterShopOrders(status) {
  if (!window.allShopOrders) return;
  
  if (status === 'all') {
    renderShopOrders(window.allShopOrders);
  } else {
    const filtered = window.allShopOrders.filter(o => o.status === status);
    renderShopOrders(filtered);
  }
}



/**
 * Update Mobile Orders Badge (Shopowner)
 */
function updateMobileOrdersBadge() {
  const badge = document.getElementById('mobileOrdersBadge');
  if (!badge) return;
  
  if (!window.allShopOrders) {
    badge.style.display = 'none';
    return;
  }
  
  const pendingCount = window.allShopOrders.filter(o => o.status === 'pending').length;
  
  if (pendingCount > 0) {
    badge.textContent = pendingCount > 99 ? '99+' : pendingCount;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

/**
 * Update Mobile Cart Badge (Customer)
 */
function updateMobileCartBadge() {
  const badge = document.getElementById('mobileCartBadge');
  if (!badge) return;
  
  const totalItems = cart.items.reduce((sum, item) => sum + item.quantity, 0);
  
  if (totalItems > 0) {
    badge.textContent = totalItems > 99 ? '99+' : totalItems;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

/**
 * Handle Window Resize
 */
function handleMobileNavResize() {
  if (!window.currentUser) {
    hideMobileBottomNav();
    hideShopownerMobileBottomNav();
    return;
  }
  
  if (isMobileDevice()) {
    if (window.currentUser.role === 'customer') {
      showMobileBottomNav();
      hideShopownerMobileBottomNav();
    } else if (window.currentUser.role === 'shopowner') {
      hideMobileBottomNav();
      showShopownerMobileBottomNav();
    }
  } else {
    hideMobileBottomNav();
    hideShopownerMobileBottomNav();
  }
}

// Add resize listener
window.addEventListener('resize', handleMobileNavResize);

// Make functions global
window.initializeMobileBottomNav = initializeMobileBottomNav;
window.showMobileBottomNav = showMobileBottomNav;
window.hideMobileBottomNav = hideMobileBottomNav;
window.showShopownerMobileBottomNav = showShopownerMobileBottomNav;
window.hideShopownerMobileBottomNav = hideShopownerMobileBottomNav;
window.switchMobileTab = switchMobileTab;
window.switchShopownerMobileTab = switchShopownerMobileTab;
window.updateMobileCartBadge = updateMobileCartBadge;
window.updateMobileOrdersBadge = updateMobileOrdersBadge;
window.isMobileDevice = isMobileDevice;
window.loadShopOrders = loadShopOrders;
window.filterShopOrders = filterShopOrders;
window.viewShopOrderDetails = viewShopOrderDetails;

console.log('‚úÖ Mobile bottom navigation system loaded (Customer + Shopowner)');


/**
 * Accept Order (Any shopowner can accept any order)
 */
 async function acceptOrder(orderId, shopId) {
  console.log('‚úÖ Accepting order:', orderId, 'from shop:', shopId);
  
  // ‚úÖ Confirm action
  if (!confirm('Accept this order?\n\nThis will mark the order as "Accepted" and notify the customer.')) {
    return;
  }
  
  // ‚úÖ Find order
  const order = window.allShopOrders ? window.allShopOrders.find(o => o.id === orderId) : null;
  
  if (!order) {
    alert('‚ùå Order not found!');
    return;
  }
  
  // ‚úÖ Check if already accepted
  if (order.status !== 'pending') {
    alert(`‚ö†Ô∏è This order is already ${order.status}!`);
    return;
  }
  
  // ‚úÖ Show loading on button
  const acceptBtn = document.getElementById(`acceptBtn_${orderId}`);
  if (acceptBtn) {
    acceptBtn.disabled = true;
    acceptBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Accepting...';
  }
  
  try {
    const { doc, updateDoc, serverTimestamp } = window.firebaseImports;
    
    console.log('üìù Updating order in Firebase...');
    console.log('  - Order ID:', orderId);
    console.log('  - Shop ID:', shopId);
    
    // ‚úÖ Update order status in Firebase
    const orderRef = doc(window.db, 'shops', shopId, 'orders', orderId);
    
    await updateDoc(orderRef, {
      status: 'accepted',
      acceptedAt: serverTimestamp(),
      acceptedBy: window.currentUser.uid,
      acceptedByName: window.currentUser.displayName || window.currentUser.email || 'Shopowner',
      updatedAt: serverTimestamp()
    });
    
    console.log('‚úÖ Order accepted successfully!');
    
    // ‚úÖ Show success message
    if (acceptBtn) {
      acceptBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Accepted!';
      acceptBtn.classList.remove('btn-success');
      acceptBtn.classList.add('btn-secondary');
      
      setTimeout(() => {
        acceptBtn.style.display = 'none';
      }, 1500);
    }
    
    // ‚úÖ Update local order object
    order.status = 'accepted';
    order.acceptedAt = new Date().toISOString();
    order.acceptedBy = window.currentUser.uid;
    order.acceptedByName = window.currentUser.displayName || window.currentUser.email || 'Shopowner';
    
    // ‚úÖ Refresh stats
    updateShopOrderStats(window.allShopOrders);
    
    // ‚úÖ Update badge
    updateMobileOrdersBadge();
    
    // ‚úÖ Re-render orders after 1.5 seconds
    setTimeout(() => {
      renderShopOrders(window.allShopOrders);
    }, 1500);
    
    // ‚úÖ Show success alert
    alert('‚úÖ Order Accepted!\n\nOrder has been marked as accepted. Customer will be notified.');
    
  } catch (error) {
    console.error('‚ùå Error accepting order:', error);
    
    // ‚úÖ Show error message
    alert(`‚ùå Error accepting order:\n\n${error.message}`);
    
    // ‚úÖ Reset button
    if (acceptBtn) {
      acceptBtn.disabled = false;
      acceptBtn.innerHTML = '<i class="bi bi-check-circle"></i> Accept';
    }
  }
}

// Make it global
window.acceptOrder = acceptOrder;

console.log('‚úÖ Accept order function loaded');



/**
 * Deliver Order (Mark order as delivered)
 */
 async function deliverOrder(orderId, shopId) {
  console.log('üöö Marking order as delivered:', orderId, 'from shop:', shopId);
  
  // ‚úÖ Confirm action
  if (!confirm('Mark this order as Delivered?\n\nThis will complete the order and notify the customer.')) {
    return;
  }
  
  // ‚úÖ Find order
  const order = window.allShopOrders ? window.allShopOrders.find(o => o.id === orderId) : null;
  
  if (!order) {
    alert('‚ùå Order not found!');
    return;
  }
  
  // ‚úÖ Check if already delivered
  if (order.status === 'delivered') {
    alert('‚ö†Ô∏è This order is already delivered!');
    return;
  }
  
  // ‚úÖ Check if order can be delivered (must be accepted first)
  if (!['accepted', 'preparing', 'ready'].includes(order.status)) {
    alert(`‚ö†Ô∏è Cannot deliver this order!\n\nCurrent status: ${order.status}\n\nOnly accepted orders can be marked as delivered.`);
    return;
  }
  
  // ‚úÖ Show loading on button
  const deliverBtn = document.getElementById(`deliverBtn_${orderId}`);
  if (deliverBtn) {
    deliverBtn.disabled = true;
    deliverBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';
  }
  
  try {
    const { doc, updateDoc, serverTimestamp } = window.firebaseImports;
    
    console.log('üìù Updating order in Firebase...');
    console.log('  - Order ID:', orderId);
    console.log('  - Shop ID:', shopId);
    console.log('  - Status: delivered');
    
    // ‚úÖ Update order status in Firebase
    const orderRef = doc(window.db, 'shops', shopId, 'orders', orderId);
    
    await updateDoc(orderRef, {
      status: 'delivered',
      deliveredAt: serverTimestamp(),
      deliveredBy: window.currentUser.uid,
      deliveredByName: window.currentUser.displayName || window.currentUser.email || 'Shopowner',
      updatedAt: serverTimestamp()
    });
    
    console.log('‚úÖ Order marked as delivered successfully!');
    
    // ‚úÖ Show success message
    if (deliverBtn) {
      deliverBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Delivered!';
      deliverBtn.style.background = '#6c757d';
      deliverBtn.style.borderColor = '#6c757d';
      
      setTimeout(() => {
        deliverBtn.style.display = 'none';
      }, 1500);
    }
    
    // ‚úÖ Update local order object
    order.status = 'delivered';
    order.deliveredAt = new Date().toISOString();
    order.deliveredBy = window.currentUser.uid;
    order.deliveredByName = window.currentUser.displayName || window.currentUser.email || 'Shopowner';
    
    // ‚úÖ Refresh stats
    updateShopOrderStats(window.allShopOrders);
    
    // ‚úÖ Update badge
    updateMobileOrdersBadge();
    
    // ‚úÖ Re-render orders after 1.5 seconds
    setTimeout(() => {
      renderShopOrders(window.allShopOrders);
    }, 1500);
    
    // ‚úÖ Show success alert
    alert('‚úÖ Order Delivered!\n\nOrder has been marked as delivered. Customer will be notified.');
    
  } catch (error) {
    console.error('‚ùå Error marking order as delivered:', error);
    
    // ‚úÖ Show error message
    alert(`‚ùå Error delivering order:\n\n${error.message}`);
    
    // ‚úÖ Reset button
    if (deliverBtn) {
      deliverBtn.disabled = false;
      deliverBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Delivered';
    }
  }
}

// Make it global
window.deliverOrder = deliverOrder;

console.log('‚úÖ Deliver order function loaded');


</script>

</body>
</html>
